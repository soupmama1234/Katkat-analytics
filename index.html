<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>KATKAT Analytics</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #000000;
  --card-bg: #111111;
  --border: #222222;
  --primary: #FF9F0A;
  --text-main: #FFFFFF;
  --text-sub: #8E8E93;
  --green: #32D74B;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body { 
  background: var(--bg); 
  color: var(--text-main); 
  font-family: 'IBM Plex Sans Thai', sans-serif; 
  margin: 0; 
  padding: 0;
  /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏¢‡∏ö‡∏≤‡∏Å (Notch) ‡∏Ç‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  overflow-x: hidden;
}

.app-wrapper {
  min-height: 100vh;
  padding: 20px 20px 120px;
}

/* Header */
.header { margin-bottom: 30px; }
.header h1 { font-size: 32px; font-weight: 800; margin: 0; color: var(--text-main); }
.header p { color: var(--text-sub); font-size: 16px; margin-top: 5px; }

/* Stats - ‡πÄ‡∏ô‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà‡πÜ */
.stats-container { display: flex; gap: 15px; margin-bottom: 25px; }
.stat-box {
  flex: 1;
  background: var(--card-bg);
  padding: 24px 15px;
  border-radius: 20px;
  border: 1px solid var(--border);
}
.stat-label { font-size: 14px; color: var(--text-sub); margin-bottom: 10px; font-weight: 500; }
.stat-value { font-family: 'Inter', sans-serif; font-size: 28px; font-weight: 800; color: var(--primary); }

/* Chart Area */
.main-card {
  background: var(--card-bg);
  border-radius: 24px;
  padding: 24px;
  border: 1px solid var(--border);
  margin-bottom: 30px;
}
.card-header { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--text-main); }
.chart-box { height: 250px; width: 100%; }

/* List ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô - ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
.history-section h2 { font-size: 20px; font-weight: 700; margin-bottom: 15px; padding-left: 5px; }
.history-list { background: var(--card-bg); border-radius: 24px; border: 1px solid var(--border); overflow: hidden; }
.history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid var(--border);
}
.history-item:last-child { border-bottom: none; }
.date-label { font-size: 17px; font-weight: 500; }
.amount-label { font-family: 'Inter', sans-serif; font-size: 18px; font-weight: 700; color: var(--green); }

/* ‡∏õ‡∏∏‡πà‡∏° Refresh ‡πÉ‡∏´‡∏ç‡πà‡πÜ ‡πÅ‡∏ö‡∏ö‡∏•‡∏≠‡∏¢ */
.fab-refresh {
  position: fixed;
  bottom: 40px;
  right: 25px;
  width: 65px;
  height: 65px;
  background: var(--primary);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  border: none;
  box-shadow: 0 8px 25px rgba(255,159,10,0.4);
  z-index: 100;
}

/* Loading */
#loader {
  position: fixed; inset: 0; background: #000;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 999;
}
.loader-spin {
  width: 50px; height: 50px;
  border: 5px solid #222; border-top: 5px solid var(--primary);
  border-radius: 50%; animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loader">
  <div class="loader-spin"></div>
  <p style="margin-top:20px; color:var(--text-sub); font-weight: 500;">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</p>
</div>

<div class="app-wrapper">
  <header class="header">
    <h1>Analytics</h1>
    <p>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î KAT KAT KATSU</p>
  </header>

  <div class="stats-container">
    <div class="stat-box">
      <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</div>
      <div class="stat-value" id="rev-total">‡∏ø0</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</div>
      <div class="stat-value" id="order-count">0</div>
    </div>
  </div>

  <div class="main-card">
    <div class="card-header">‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 7 ‡∏ß‡∏±‡∏ô</div>
    <div class="chart-box">
      <canvas id="salesChart"></canvas>
    </div>
  </div>

  <section class="history-section">
    <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
    <div class="history-list" id="daily-list">
      </div>
  </section>
</div>

<button class="fab-refresh" onclick="getData()">üîÑ</button>

<script>
const URL = "https://uhruejkycwcxjhcokbfm.supabase.co";
const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocnVlamt5Y3djeGpoY29rYmZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjE4NDUsImV4cCI6MjA4NzIzNzg0NX0.M67DwOTw2cKXHlPBJnfn7FSsRmUCv83s7J3-CkvZguc";
const supabaseClient = supabase.createClient(URL, KEY);
let salesChart = null;

async function getData() {
  document.getElementById('loader').style.display = 'flex';
  try {
    const { data, error } = await supabaseClient
      .from('orders')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;
    updateUI(data);
  } catch (e) {
    alert(e.message);
  } finally {
    document.getElementById('loader').style.display = 'none';
  }
}

function updateUI(data) {
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
  const total = data.reduce((s, r) => s + (r.actual_amount || 0), 0);
  document.getElementById('rev-total').innerText = '‡∏ø' + total.toLocaleString();
  document.getElementById('order-count').innerText = data.length.toLocaleString();

  // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
  const dailyData = {};
  data.forEach(r => {
    const d = new Date(r.created_at).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
    dailyData[d] = (dailyMap = dailyData[d] || 0) + (r.actual_amount || 0);
  });

  // ‡πÅ‡∏™‡∏î‡∏á List
  const list = document.getElementById('daily-list');
  list.innerHTML = '';
  Object.entries(dailyData).slice(0, 10).forEach(([date, val]) => {
    list.innerHTML += `
      <div class="history-item">
        <span class="date-label">${date}</span>
        <span class="amount-label">‡∏ø${val.toLocaleString()}</span>
      </div>
    `;
  });

  renderSalesChart(dailyData);
}

function renderSalesChart(dailyData) {
  const ctx = document.getElementById('salesChart').getContext('2d');
  const labels = Object.keys(dailyData).reverse().slice(-7);
  const values = labels.map(l => dailyData[l]);

  if (salesChart) salesChart.destroy();
  
  salesChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        borderColor: '#FF9F0A',
        borderWidth: 5,
        tension: 0.4,
        pointRadius: 4,
        pointBackgroundColor: '#FF9F0A',
        fill: true,
        backgroundColor: (c) => {
          const g = ctx.createLinearGradient(0, 0, 0, 250);
          g.addColorStop(0, 'rgba(255, 159, 10, 0.25)');
          g.addColorStop(1, 'rgba(255, 159, 10, 0)');
          return g;
        }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#8E8E93', font: { size: 12, weight: '600' } } },
        y: { display: false }
      }
    }
  });
}

getData();
</script>
</body>
</html>
