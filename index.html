<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>KATKAT Analytics</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&family=Inter:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#000; --surface:#121212; --border:#222; --primary:#FF9F0A; --success:#32D74B; --text:#fff; --dim:#8E8E93; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans Thai',sans-serif;margin:0;padding:env(safe-area-inset-top) 0 env(safe-area-inset-bottom);user-select:none}
    .wrap{max-width:500px;margin:0 auto;padding:20px}

    /* NAV TABS */
    .nav{display:flex;background:var(--surface);border-radius:16px;padding:4px;margin-bottom:28px;gap:4px;border:1px solid var(--border)}
    .nav-btn{flex:1;background:none;border:none;color:var(--dim);font-family:inherit;font-size:13px;font-weight:600;padding:10px 4px;border-radius:12px;cursor:pointer;transition:all 0.2s}
    .nav-btn.active{background:var(--primary);color:#000}

    /* HERO */
    .hero{background:linear-gradient(145deg,#1a1a1a,#0a0a0a);border:1px solid var(--border);border-radius:28px;padding:32px 24px;margin-bottom:24px;text-align:center}
    .hero-lbl{color:var(--dim);font-size:13px;text-transform:uppercase;letter-spacing:1px}
    .hero-val{font-family:'Inter',sans-serif;font-size:48px;font-weight:800;color:var(--primary);margin:10px 0;letter-spacing:-1px}
    .hero-sub{color:var(--dim);font-size:14px}

    /* STATS GRID */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
    .scard{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:18px}
    .scard-lbl{color:var(--dim);font-size:12px;margin-bottom:6px}
    .scard-val{font-family:'Inter',sans-serif;font-size:20px;font-weight:700}

    /* SECTION */
    .sec-title{font-size:16px;font-weight:700;color:var(--dim);margin-bottom:12px;margin-top:28px}

    /* PERIOD TOGGLE */
    .period-row{display:flex;gap:8px;margin-bottom:16px}
    .period-btn{background:var(--surface);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:13px;font-weight:600;padding:8px 18px;border-radius:20px;cursor:pointer;transition:all 0.2s}
    .period-btn.active{background:var(--primary);color:#000;border-color:var(--primary)}

    /* CHART */
    .chart-box{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:20px;height:240px;margin-bottom:8px}

    /* RANK LIST */
    .rank-list{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:8px}
    .rank-item{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);gap:12px}
    .rank-item:last-child{border-bottom:none}
    .rank-no{font-family:'Inter',sans-serif;font-size:12px;font-weight:800;color:#333;width:18px;text-align:center;flex-shrink:0}
    .rank-no.gold{color:#FFD60A}.rank-no.silver{color:#8E8E93}.rank-no.bronze{color:#CD7F32}
    .rank-info{flex:1;min-width:0}
    .rank-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rank-sub{font-size:11px;color:var(--dim);margin-top:2px}
    .rank-bar-wrap{height:3px;background:#1a1a1a;border-radius:2px;margin-top:5px}
    .rank-bar{height:100%;background:var(--primary);border-radius:2px}
    .rank-right{text-align:right;flex-shrink:0}
    .rank-qty{font-family:'Inter',sans-serif;font-size:15px;font-weight:700;color:var(--primary)}
    .rank-rev{font-size:11px;color:var(--dim);margin-top:2px}

    /* CAT CARDS */
    .cat-list{display:flex;flex-direction:column;gap:10px;margin-bottom:8px}
    .cat-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px 18px}
    .cat-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
    .cat-name{font-size:15px;font-weight:600}
    .cat-val{font-family:'Inter',sans-serif;font-size:15px;font-weight:700;color:var(--success)}
    .cat-bar-wrap{height:3px;background:#1a1a1a;border-radius:2px}
    .cat-bar{height:100%;background:var(--success);border-radius:2px}
    .cat-sub{font-size:12px;color:var(--dim);margin-top:5px}

    /* HOUR LIST */
    .hour-list{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:8px}
    .hour-item{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);gap:12px}
    .hour-item:last-child{border-bottom:none}
    .hour-time{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;color:var(--dim);width:52px;flex-shrink:0}
    .hour-bar-wrap{flex:1;height:6px;background:#1a1a1a;border-radius:3px}
    .hour-bar{height:100%;background:var(--primary);border-radius:3px}
    .hour-right{text-align:right;flex-shrink:0}
    .hour-orders{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;color:var(--primary)}
    .hour-rev{font-size:11px;color:var(--dim)}

    /* TODAY ITEMS */
    .today-list{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:8px}
    .today-item{padding:14px 18px;border-bottom:1px solid var(--border)}
    .today-item:last-child{border-bottom:none}
    .today-main{display:flex;justify-content:space-between;align-items:center}
    .today-name{font-size:14px;font-weight:600}
    .today-val{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;color:var(--success)}
    .today-mod{font-size:12px;color:var(--dim);margin-top:4px;padding-left:4px}

    /* DAILY LIST */
    .day-list{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:8px}
    .day-item{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border)}
    .day-item:last-child{border-bottom:none}
    .day-date{font-weight:500;font-size:15px}
    .day-val{font-family:'Inter',sans-serif;font-weight:700;color:var(--success)}

    /* EMPTY */
    .empty{padding:32px;text-align:center;color:var(--dim);font-size:14px}

    /* FAB */
    .fab{position:fixed;bottom:40px;right:24px;width:56px;height:56px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(255,159,10,0.35);border:none;z-index:100;cursor:pointer}

    /* LOADER */
    #loader{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity 0.4s}
    .spinner{width:36px;height:36px;border:4px solid #222;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* PAGE */
    .page{display:none}.page.active{display:block}
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p style="margin-top:18px;color:var(--dim);font-size:13px">KATKAT ANALYTICS</p>
</div>

<div class="wrap">
  <!-- NAV -->
  <nav class="nav">
    <button class="nav-btn active" onclick="showPage('overview')">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
    <button class="nav-btn" onclick="showPage('today')">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    <button class="nav-btn" onclick="showPage('trend')">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</button>
    <button class="nav-btn" onclick="showPage('peak')">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
  </nav>

  <!-- PAGE: OVERVIEW -->
  <div id="page-overview" class="page active">
    <div class="hero">
      <div class="hero-lbl">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div class="hero-val" id="ov-revenue">‡∏ø0</div>
      <div class="hero-sub" id="ov-count">0 ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
    </div>
    <div class="grid2">
      <div class="scard"><div class="scard-lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="ov-avg">‡∏ø0</div></div>
      <div class="scard"><div class="scard-lbl">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div><div class="scard-val" id="ov-today">‡∏ø0</div></div>
    </div>
    <div class="sec-title" style="margin-top:0">üèÜ ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ Top 10</div>
    <div class="rank-list" id="ov-menu"></div>
    <div class="sec-title">üìÇ ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
    <div class="cat-list" id="ov-cat"></div>
    <div class="sec-title">üìÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
    <div class="day-list" id="ov-daily"></div>
  </div>

  <!-- PAGE: TODAY -->
  <div id="page-today" class="page">
    <div class="hero">
      <div class="hero-lbl">‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="hero-val" id="td-revenue">‡∏ø0</div>
      <div class="hero-sub" id="td-count">0 ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
    </div>
    <div class="grid2">
      <div class="scard"><div class="scard-lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="td-avg">‡∏ø0</div></div>
      <div class="scard"><div class="scard-lbl">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="scard-val" id="td-items">0 ‡∏ä‡∏¥‡πâ‡∏ô</div></div>
    </div>
    <div class="sec-title" style="margin-top:0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
    <div class="today-list" id="td-list"></div>
  </div>

  <!-- PAGE: TREND -->
  <div id="page-trend" class="page">
    <div class="sec-title" style="margin-top:0">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
    <div class="period-row">
      <button class="period-btn active" onclick="setPeriod('7d')">7 ‡∏ß‡∏±‡∏ô</button>
      <button class="period-btn" onclick="setPeriod('30d')">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
      <button class="period-btn" onclick="setPeriod('1y')">1 ‡∏õ‡∏µ</button>
    </div>
    <div class="chart-box"><canvas id="trend-chart"></canvas></div>
    <div class="day-list" id="trend-list" style="margin-top:16px"></div>
  </div>

  <!-- PAGE: PEAK -->
  <div id="page-peak" class="page">
    <div class="sec-title" style="margin-top:0">‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</div>
    <div class="chart-box"><canvas id="peak-chart"></canvas></div>
    <div class="sec-title">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
    <div class="hour-list" id="peak-list"></div>
  </div>
</div>

<button class="fab" onclick="init()">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
  </svg>
</button>

<script>
const SB_URL = "https://uhruejkycwcxjhcokbfm.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocnVlamt5Y3djeGpoY29rYmZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjE4NDUsImV4cCI6MjA4NzIzNzg0NX0.M67DwOTw2cKXHlPBJnfn7FSsRmUCv83s7J3-CkvZguc";
const sb = supabase.createClient(SB_URL, SB_KEY);

let allOrders = [], catMap = {}, currentPeriod = '7d';
let trendChart = null, peakChart = null;
const fmt = n => (n||0).toLocaleString('th-TH');
const todayStr = new Date().toLocaleDateString('en-CA');

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  showLoader(true);
  try {
    const [ordRes, prodRes] = await Promise.all([
      sb.from('orders').select('*').order('created_at', { ascending: false }),
      sb.from('products').select('id,name,category')
    ]);
    if (ordRes.error) throw ordRes.error;

    catMap = {};
    (prodRes.data||[]).forEach(p => { catMap[p.name] = p.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; });
    allOrders = ordRes.data || [];

    renderAll();
  } catch(e) { alert('Error: ' + e.message); }
  finally { showLoader(false); }
}

function showLoader(show) {
  const el = document.getElementById('loader');
  if (show) { el.style.opacity = 1; el.style.display = 'flex'; }
  else { setTimeout(() => { el.style.opacity = 0; setTimeout(() => el.style.display = 'none', 400); }, 500); }
}

// ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  event.target.classList.add('active');
}

// ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
  const { dailyMap, menuCount, menuRevenue, catRevenue, catCount, byHour, todayOrders } = compute(allOrders);

  renderOverview(dailyMap, menuCount, menuRevenue, catRevenue, catCount);
  renderToday(todayOrders);
  renderTrend(dailyMap);
  renderPeak(byHour);
}

// ‚îÄ‚îÄ COMPUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function compute(orders) {
  const dailyMap = {}, menuCount = {}, menuRevenue = {}, catRevenue = {}, catCount = {};
  const byHour = Array.from({length:24}, (_,i) => ({hour:i, orders:0, revenue:0}));
  const todayOrders = [];

  orders.forEach(r => {
    const date = (r.created_at||'').split('T')[0];
    const actual = r.actual_amount || 0;

    // daily
    if (date) dailyMap[date] = (dailyMap[date]||0) + actual;

    // hour
    if (r.created_at) {
      const h = new Date(r.created_at).getHours();
      byHour[h].orders++;
      byHour[h].revenue += actual;
    }

    // today
    if (date === todayStr) todayOrders.push(r);

    // items
    let items = r.items;
    if (!items) return;
    if (typeof items === 'string') { try { items = JSON.parse(items); } catch { return; } }
    if (!Array.isArray(items)) return;

    items.forEach(item => {
      const name = item.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const qty = Number(item.qty || item.quantity || 1);
      const price = Number(item.price || 0);
      const cat = catMap[name] || item.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';

      menuCount[name] = (menuCount[name]||0) + qty;
      menuRevenue[name] = (menuRevenue[name]||0) + (price * qty);
      catRevenue[cat] = (catRevenue[cat]||0) + (price * qty);
      catCount[cat] = (catCount[cat]||0) + qty;
    });
  });

  return { dailyMap, menuCount, menuRevenue, catRevenue, catCount, byHour, todayOrders };
}

// ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOverview(dailyMap, menuCount, menuRevenue, catRevenue, catCount) {
  const totalRev = allOrders.reduce((s,r) => s + (r.actual_amount||0), 0);
  const cnt = allOrders.length;
  document.getElementById('ov-revenue').innerText = '‡∏ø' + fmt(totalRev);
  document.getElementById('ov-count').innerText = fmt(cnt) + ' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
  document.getElementById('ov-avg').innerText = '‡∏ø' + fmt(Math.round(cnt ? totalRev/cnt : 0));
  document.getElementById('ov-today').innerText = '‡∏ø' + fmt(dailyMap[todayStr]||0);

  // ‡πÄ‡∏°‡∏ô‡∏π
  const topMenus = Object.entries(menuCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const maxQ = topMenus[0]?.[1] || 1;
  document.getElementById('ov-menu').innerHTML = topMenus.length
    ? topMenus.map(([name,qty],i) => rankItemHTML(i, name, qty, menuRevenue[name]||0, maxQ)).join('')
    : '<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';

  // ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
  const cats = Object.entries(catRevenue).sort((a,b)=>b[1]-a[1]);
  const maxC = cats[0]?.[1] || 1;
  document.getElementById('ov-cat').innerHTML = cats.length
    ? cats.map(([cat,rev]) => `
        <div class="cat-card">
          <div class="cat-row"><span class="cat-name">${cat}</span><span class="cat-val">‡∏ø${fmt(rev)}</span></div>
          <div class="cat-bar-wrap"><div class="cat-bar" style="width:${Math.round(rev/maxC*100)}%"></div></div>
          <div class="cat-sub">${catCount[cat]} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>`).join('')
    : '<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';

  // ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
  document.getElementById('ov-daily').innerHTML = Object.entries(dailyMap)
    .sort((a,b)=>b[0].localeCompare(a[0])).slice(0,14)
    .map(([date,val]) => `
      <div class="day-item">
        <span class="day-date">${new Date(date).toLocaleDateString('th-TH',{day:'numeric',month:'short'})}</span>
        <span class="day-val">‡∏ø${fmt(val)}</span>
      </div>`).join('');
}

// ‚îÄ‚îÄ TODAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderToday(todayOrders) {
  const rev = todayOrders.reduce((s,r) => s + (r.actual_amount||0), 0);
  const cnt = todayOrders.length;

  // ‡∏£‡∏ß‡∏° items ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
  const menuToday = {}, modToday = {}; // name ‚Üí {qty, revenue, mods:[]}
  let totalItems = 0;

  todayOrders.forEach(r => {
    let items = r.items;
    if (!items) return;
    if (typeof items === 'string') { try { items = JSON.parse(items); } catch { return; } }
    if (!Array.isArray(items)) return;

    items.forEach(item => {
      const name = item.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const qty = Number(item.qty || item.quantity || 1);
      const price = Number(item.price || 0);
      totalItems += qty;

      if (!menuToday[name]) menuToday[name] = { qty: 0, revenue: 0, mods: {} };
      menuToday[name].qty += qty;
      menuToday[name].revenue += price * qty;

      // modifier ‡∏Ç‡∏≠‡∏á item ‡∏ô‡∏µ‡πâ
      if (item.selectedModifier?.name) {
        const modName = item.selectedModifier.name;
        menuToday[name].mods[modName] = (menuToday[name].mods[modName]||0) + qty;
      }
    });
  });

  document.getElementById('td-revenue').innerText = '‡∏ø' + fmt(rev);
  document.getElementById('td-count').innerText = fmt(cnt) + ' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
  document.getElementById('td-avg').innerText = '‡∏ø' + fmt(Math.round(cnt ? rev/cnt : 0));
  document.getElementById('td-items').innerText = fmt(totalItems) + ' ‡∏ä‡∏¥‡πâ‡∏ô';

  const sorted = Object.entries(menuToday).sort((a,b) => b[1].qty - a[1].qty);
  document.getElementById('td-list').innerHTML = sorted.length
    ? sorted.map(([name, data]) => {
        const mods = Object.entries(data.mods);
        const modHTML = mods.length
          ? mods.map(([m,q]) => `<span style="margin-right:8px">‚öôÔ∏è ${m} √ó${q}</span>`).join('')
          : '';
        return `<div class="today-item">
          <div class="today-main">
            <span class="today-name">${name}</span>
            <span class="today-val">√ó${data.qty}</span>
          </div>
          ${modHTML ? `<div class="today-mod">${modHTML}</div>` : ''}
        </div>`;
      }).join('')
    : '<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
}

// ‚îÄ‚îÄ TREND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setPeriod(p) {
  currentPeriod = p;
  document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  const { dailyMap } = compute(allOrders);
  renderTrend(dailyMap);
}

function renderTrend(dailyMap) {
  const sorted = Object.keys(dailyMap).sort();
  let sliced, groupFn, labelFn;

  if (currentPeriod === '7d') {
    sliced = sorted.slice(-7);
    labelFn = d => d.split('-')[2]; // ‡πÄ‡∏•‡∏Ç‡∏ß‡∏±‡∏ô
    groupFn = null;
  } else if (currentPeriod === '30d') {
    sliced = sorted.slice(-30);
    labelFn = d => d.split('-')[2];
    groupFn = null;
  } else {
    // 1 ‡∏õ‡∏µ ‚Äî ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    const monthly = {};
    sorted.forEach(d => {
      const key = d.slice(0,7); // YYYY-MM
      monthly[key] = (monthly[key]||0) + dailyMap[d];
    });
    const mKeys = Object.keys(monthly).sort().slice(-12);
    const labels = mKeys.map(k => {
      const [y,m] = k.split('-');
      return new Date(+y, +m-1).toLocaleDateString('th-TH', {month:'short', year:'2-digit'});
    });
    const values = mKeys.map(k => monthly[k]);
    drawTrendChart(labels, values);

    // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    document.getElementById('trend-list').innerHTML = mKeys.slice().reverse().map(k => {
      const [y,m] = k.split('-');
      const label = new Date(+y,+m-1).toLocaleDateString('th-TH',{month:'long',year:'numeric'});
      return `<div class="day-item"><span class="day-date">${label}</span><span class="day-val">‡∏ø${fmt(monthly[k])}</span></div>`;
    }).join('');
    return;
  }

  const labels = sliced.map(labelFn);
  const values = sliced.map(d => dailyMap[d]);
  drawTrendChart(labels, values);

  document.getElementById('trend-list').innerHTML = sliced.slice().reverse().map(d => {
    const label = new Date(d).toLocaleDateString('th-TH',{day:'numeric',month:'short'});
    return `<div class="day-item"><span class="day-date">${label}</span><span class="day-val">‡∏ø${fmt(dailyMap[d])}</span></div>`;
  }).join('');
}

function drawTrendChart(labels, values) {
  if (trendChart) trendChart.destroy();
  const ctx = document.getElementById('trend-chart').getContext('2d');
  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data: values, borderColor: '#FF9F0A', borderWidth: 3,
        tension: 0.4, fill: true,
        backgroundColor: 'rgba(255,159,10,0.07)', pointRadius: 2,
        pointBackgroundColor: '#FF9F0A'
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#555', font: { size: 11 } } },
        y: { display: false }
      }
    }
  });
}

// ‚îÄ‚îÄ PEAK HOURS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPeak(byHour) {
  const active = byHour.filter(h => h.orders > 0);
  const maxO = Math.max(...active.map(h => h.orders), 1);

  // chart
  if (peakChart) peakChart.destroy();
  const ctx = document.getElementById('peak-chart').getContext('2d');
  peakChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: byHour.map(h => h.hour + ':00'),
      datasets: [{
        data: byHour.map(h => h.orders),
        backgroundColor: byHour.map(h => h.orders === maxO ? '#FF9F0A' : 'rgba(255,159,10,0.25)'),
        borderRadius: 6, borderSkipped: false
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#555', font: { size: 10 }, maxRotation: 0 } },
        y: { display: false }
      }
    }
  });

  // list ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏™‡∏∏‡∏î
  document.getElementById('peak-list').innerHTML = [...active]
    .sort((a,b) => b.orders - a.orders)
    .map((h,i) => `
      <div class="hour-item">
        <div class="hour-time">${String(h.hour).padStart(2,'0')}:00</div>
        <div class="hour-bar-wrap">
          <div class="hour-bar" style="width:${Math.round(h.orders/maxO*100)}%"></div>
        </div>
        <div class="hour-right">
          <div class="hour-orders">${h.orders} ‡∏ö‡∏¥‡∏•</div>
          <div class="hour-rev">‡∏ø${fmt(h.revenue)}</div>
        </div>
      </div>`).join('');
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rankItemHTML(i, name, qty, rev, maxQ) {
  const cls = i===0?'gold':i===1?'silver':i===2?'bronze':'';
  const pct = Math.round(qty/maxQ*100);
  return `<div class="rank-item">
    <div class="rank-no ${cls}">${i+1}</div>
    <div class="rank-info">
      <div class="rank-name">${name}</div>
      <div class="rank-bar-wrap"><div class="rank-bar" style="width:${pct}%"></div></div>
    </div>
    <div class="rank-right">
      <div class="rank-qty">${qty} ‡∏ä‡∏¥‡πâ‡∏ô</div>
      <div class="rank-rev">‡∏ø${fmt(rev)}</div>
    </div>
  </div>`;
}

init();
</script>
</body>
</html>
