<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <title>KATKAT Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&family=Inter:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#000;--surface:#121212;--surface2:#1a1a1a;--border:#222;--border2:#2a2a2a;
      --primary:#FF9F0A;--success:#32D74B;--danger:#FF453A;--blue:#0A84FF;
      --text:#fff;--dim:#8E8E93;
      --pos:#ffffff;--grab:#00B14F;--lineman:#00A84F;--shopee:#EE4D2D}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-font-smoothing:antialiased}
    html{height:100%;overflow:hidden}
    body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans Thai',sans-serif;
      margin:0;height:100%;overflow:hidden;user-select:none}

    #app{display:flex;flex-direction:column;height:100%;max-width:500px;margin:0 auto}
    .scroll-area{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 16px 24px}

    .bottom-nav{display:flex;background:rgba(18,18,18,0.95);backdrop-filter:blur(20px);
      -webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);
      padding:8px 0 calc(8px + env(safe-area-inset-bottom));flex-shrink:0}
    .bnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
      background:none;border:none;color:var(--dim);font-family:inherit;font-size:10px;
      font-weight:500;padding:6px 2px;cursor:pointer;transition:color .2s}
    .bnav-btn .icon{font-size:20px;line-height:1}
    .bnav-btn.active{color:var(--primary)}

    .hero{background:linear-gradient(145deg,#1a1a1a,#0a0a0a);border:1px solid var(--border);
      border-radius:24px;padding:24px 20px;margin-bottom:16px;text-align:center}
    .hero-lbl{color:var(--dim);font-size:11px;text-transform:uppercase;letter-spacing:1.5px}
    .hero-val{font-family:'Inter',sans-serif;font-size:40px;font-weight:800;
      color:var(--primary);margin:6px 0;letter-spacing:-1px}
    .hero-sub{color:var(--dim);font-size:13px}
    .hero-range{display:inline-flex;align-items:center;gap:5px;background:#1a1a1a;
      border:1px solid #333;border-radius:20px;padding:5px 12px;margin-top:10px;
      font-size:11px;color:var(--dim)}
    .hero-range b{color:var(--primary)}

    .pills{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
    .pill{background:var(--surface);border:1px solid var(--border);color:var(--dim);
      font-family:inherit;font-size:12px;font-weight:600;padding:6px 14px;
      border-radius:20px;cursor:pointer;transition:all .2s;white-space:nowrap}
    .pill.active{background:var(--primary);color:#000;border-color:var(--primary)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
    .scard{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:16px}
    .scard-lbl{color:var(--dim);font-size:11px;margin-bottom:5px}
    .scard-val{font-family:'Inter',sans-serif;font-size:18px;font-weight:700}
    .scard-val.red{color:var(--danger)}
    .scard-val.green{color:var(--success)}

    .sec{font-size:14px;font-weight:700;color:var(--dim);margin:20px 0 10px}
    .sec:first-child{margin-top:0}

    .chart-box{background:var(--surface);border:1px solid var(--border);border-radius:20px;
      padding:16px;margin-bottom:4px}

    .card-list{background:var(--surface);border-radius:20px;border:1px solid var(--border);
      overflow:hidden;margin-bottom:4px}
    .list-row{display:flex;align-items:center;padding:13px 16px;border-bottom:1px solid var(--border2);gap:10px}
    .list-row:last-child{border-bottom:none}

    .pname{font-size:13px;font-weight:700;width:60px;flex-shrink:0}
    .bar-w{flex:1;height:4px;background:#1a1a1a;border-radius:2px}
    .bar-f{height:100%;border-radius:2px;transition:width .6s}
    .pright{text-align:right;flex-shrink:0}
    .pval{font-family:'Inter',sans-serif;font-size:13px;font-weight:700}
    .psub{font-size:10px;color:var(--dim);margin-top:1px}

    .rno{font-family:'Inter',sans-serif;font-size:11px;font-weight:800;
      color:#333;width:16px;text-align:center;flex-shrink:0}
    .rno.g{color:#FFD60A}.rno.s{color:#8E8E93}.rno.b{color:#CD7F32}
    .rinfo{flex:1;min-width:0}
    .rname{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rbar-w{height:3px;background:#1a1a1a;border-radius:2px;margin-top:4px}
    .rbar{height:100%;background:var(--primary);border-radius:2px}
    .rright{text-align:right;flex-shrink:0}
    .rqty{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--primary)}
    .rrev{font-size:10px;color:var(--dim);margin-top:1px}

    .clist{display:flex;flex-direction:column;gap:8px;margin-bottom:4px}
    .ccard{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 16px}
    .crow{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .cname{font-size:14px;font-weight:600}
    .cval{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;color:var(--success)}
    .cbar-w{height:3px;background:#1a1a1a;border-radius:2px}
    .cbar{height:100%;background:var(--success);border-radius:2px}
    .csub{font-size:11px;color:var(--dim);margin-top:4px}

    .ddate{font-size:13px;font-weight:500;flex:1}
    .dval{font-family:'Inter',sans-serif;font-weight:700;color:var(--success);font-size:13px;flex-shrink:0}

    .titem{padding:12px 16px;border-bottom:1px solid var(--border2)}
    .titem:last-child{border-bottom:none}
    .tmain{display:flex;justify-content:space-between;align-items:center}
    .tname{font-size:13px;font-weight:600}
    .tqty{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--success)}
    .tmod{font-size:11px;color:var(--dim);margin-top:3px}

    .htime{font-family:'Inter',sans-serif;font-size:12px;font-weight:700;color:var(--dim);width:44px;flex-shrink:0}
    .horders{font-family:'Inter',sans-serif;font-size:12px;font-weight:700;color:var(--primary)}
    .hrev{font-size:10px;color:var(--dim)}

    .hmwrap{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:16px;margin-bottom:4px}
    .hm-hdr{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center;margin-bottom:6px}
    .hm-hdr span{font-size:10px;color:var(--dim)}
    .hmgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
    .hmcell{aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:9px;font-family:'Inter',sans-serif}
    .hm-leg{display:flex;align-items:center;gap:5px;margin-top:10px;justify-content:flex-end}
    .hm-leg span{font-size:10px;color:var(--dim)}
    .hm-dots{display:flex;gap:3px}
    .hm-dot{width:11px;height:11px;border-radius:3px}

    .form-wrap{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:16px;margin-bottom:16px}
    .form-title{font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .form-row{margin-bottom:12px}
    .form-label{font-size:11px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:block}
    .form-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:12px;
      padding:12px 14px;color:var(--text);font-family:inherit;font-size:15px;outline:none;
      transition:border-color .2s;-webkit-appearance:none}
    .form-input:focus{border-color:var(--primary)}
    .form-input::placeholder{color:#444}
    .cat-pills{display:flex;flex-wrap:wrap;gap:6px}
    .cat-pill{background:var(--surface2);border:1px solid var(--border);color:var(--dim);
      font-family:inherit;font-size:12px;font-weight:600;padding:7px 12px;
      border-radius:12px;cursor:pointer;transition:all .2s}
    .cat-pill.active{color:#000}
    .unit-pills{display:flex;flex-wrap:wrap;gap:6px}
    .unit-pill{background:var(--surface2);border:1px solid var(--border);color:var(--dim);
      font-family:inherit;font-size:12px;padding:6px 10px;border-radius:10px;cursor:pointer;transition:all .2s}
    .unit-pill.active{background:var(--primary);color:#000;border-color:var(--primary)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .calc-display{background:var(--surface2);border:1px solid var(--border);border-radius:12px;
      padding:12px 14px;font-family:'Inter',sans-serif;font-size:18px;font-weight:700;
      color:var(--primary);text-align:center}
    .btn-submit{width:100%;background:var(--primary);color:#000;border:none;border-radius:14px;
      padding:16px;font-family:inherit;font-size:16px;font-weight:700;cursor:pointer;
      margin-top:4px;transition:opacity .2s;-webkit-appearance:none}
    .btn-submit:active{opacity:.8}
    .btn-submit.green{background:var(--success)}

    .ac-wrap{position:relative}
    .ac-list{position:absolute;top:100%;left:0;right:0;background:#1e1e1e;border:1px solid #333;
      border-radius:12px;z-index:100;max-height:180px;overflow-y:auto;margin-top:4px;display:none}
    .ac-item{padding:11px 14px;cursor:pointer;font-size:14px;border-bottom:1px solid #2a2a2a;transition:background .15s}
    .ac-item:last-child{border-bottom:none}
    .ac-item:active{background:#2a2a2a}
    .warn-similar{background:rgba(255,159,10,0.1);border:1px solid rgba(255,159,10,0.3);
      border-radius:10px;padding:8px 12px;font-size:12px;color:var(--primary);margin-top:6px;display:none}

    .exp-item{padding:13px 16px;border-bottom:1px solid var(--border2)}
    .exp-item:last-child{border-bottom:none}
    .exp-top{display:flex;justify-content:space-between;align-items:flex-start}
    .exp-name{font-size:14px;font-weight:600;flex:1}
    .exp-amt{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;color:var(--danger);flex-shrink:0}
    .exp-amt.income{color:var(--success)}
    .exp-meta{font-size:11px;color:var(--dim);margin-top:3px}
    .exp-cat{display:inline-block;background:var(--surface2);border-radius:6px;
      padding:2px 7px;font-size:10px;font-weight:600;margin-right:4px}

    .profit-card{border-radius:20px;padding:20px;margin-bottom:16px;text-align:center}
    .profit-card.positive{background:rgba(50,215,75,0.1);border:1px solid rgba(50,215,75,0.3)}
    .profit-card.negative{background:rgba(255,69,58,0.1);border:1px solid rgba(255,69,58,0.3)}
    .profit-lbl{font-size:12px;color:var(--dim);text-transform:uppercase;letter-spacing:1px}
    .profit-val{font-family:'Inter',sans-serif;font-size:36px;font-weight:800;margin:6px 0}
    .profit-val.positive{color:var(--success)}
    .profit-val.negative{color:var(--danger)}

    .backup-row{display:flex;gap:10px;margin-bottom:16px}
    .backup-btn{flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);
      border-radius:14px;padding:14px;font-family:inherit;font-size:13px;font-weight:600;
      cursor:pointer;text-align:center}

    #loader{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;
      align-items:center;justify-content:center;z-index:1000;transition:opacity .4s}
    .spinner{width:32px;height:32px;border:3px solid #222;border-top-color:var(--primary);
      border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .toast{position:fixed;bottom:calc(80px + env(safe-area-inset-bottom));left:50%;
      transform:translateX(-50%) translateY(20px);background:#1e1e1e;border:1px solid #333;
      border-radius:14px;padding:12px 20px;font-size:13px;font-weight:600;
      z-index:999;opacity:0;transition:all .3s;white-space:nowrap;pointer-events:none}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.ok{border-color:rgba(50,215,75,.4);color:var(--success)}
    .toast.err{border-color:rgba(255,69,58,.4);color:var(--danger)}

    .page{display:none}.page.active{display:block}
    .empty{padding:24px;text-align:center;color:var(--dim);font-size:13px}
    select.form-input{-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center}

    .ocr-btn{width:100%;background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid #4D96FF44;
      color:#4D96FF;border-radius:16px;padding:16px;font-family:inherit;font-size:15px;font-weight:700;
      cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px}
    .ocr-btn.loading{color:#888;border-color:#333;pointer-events:none}
    #ocr-input{display:none}
    .ocr-preview{width:100%;border-radius:14px;margin-bottom:12px;max-height:200px;object-fit:cover;display:none}

    .ocr-result{background:var(--surface);border:1px solid #4D96FF33;border-radius:20px;
      padding:16px;margin-bottom:12px;display:none}
    .ocr-result-title{font-size:13px;font-weight:700;color:#4D96FF;margin-bottom:12px;display:flex;align-items:center;gap:6px}
    .ocr-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border2)}
    .ocr-check{width:20px;height:20px;border-radius:6px;border:2px solid #333;appearance:none;cursor:pointer}
    .ocr-check:checked{background:#4D96FF;border-color:#4D96FF}
    .ocr-check:checked::after{content:'‚úì';color:#000;display:block;text-align:center;font-size:12px;font-weight:800}
    .ocr-item-info{flex:1;min-width:0}
    .ocr-cat-select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:4px 8px;font-size:11px;color:var(--dim);margin-top:4px;width:100%}
    .btn-ocr-save{width:100%;background:#4D96FF;color:#000;border:none;border-radius:14px;padding:14px;font-weight:700;margin-top:4px}

    .apikey-wrap{background:var(--surface);border:1px solid #FFD60A33;border-radius:16px;padding:16px;margin-bottom:12px;display:none}
    .apikey-wrap.show{display:block}
    .apikey-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);font-family:monospace}
    .apikey-save{background:#FFD60A;color:#000;border:none;border-radius:10px;padding:10px 14px;font-weight:700}
  </style>
</head>
<body>
<div id="loader"><div class="spinner"></div><p style="margin-top:14px;color:var(--dim);font-size:11px;letter-spacing:2px">KATKAT</p></div>
<div class="toast" id="toast"></div>

<div id="app">
  <div class="scroll-area" id="scroll-area">
    <!-- PAGE: OVERVIEW -->
    <div id="page-overview" class="page active">
      <div class="pills">
        <button class="pill active" onclick="setOvPeriod('all',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="pill" onclick="setOvPeriod('today',this)">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        <button class="pill" onclick="setOvPeriod('7d',this)">7 ‡∏ß‡∏±‡∏ô</button>
        <button class="pill" onclick="setOvPeriod('30d',this)">30 ‡∏ß‡∏±‡∏ô</button>
      </div>
      <div class="hero">
        <div class="hero-lbl">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</div>
        <div class="hero-val" id="ov-rev">‡∏ø0</div>
        <div class="hero-sub" id="ov-cnt">0 ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
        <div class="hero-range">üìÖ <b id="ov-range-lbl">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b></div>
      </div>
      <div class="grid2">
        <div class="scard"><div class="scard-lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="ov-avg">‡∏ø0</div></div>
        <div class="scard"><div class="scard-lbl">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div><div class="scard-val" id="ov-today">‡∏ø0</div></div>
      </div>
      <div class="sec">üì° Platform</div>
      <div class="card-list" id="ov-platform"></div>
      <div class="sec">üèÜ ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ Top 10</div>
      <div class="card-list" id="ov-menu"></div>
      <div class="sec">üìÇ ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
      <div class="clist" id="ov-cat"></div>
      <div class="sec">üìÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
      <div class="card-list" id="ov-daily"></div>
    </div>

    <!-- PAGE: TODAY -->
    <div id="page-today" class="page">
      <div class="hero">
        <div class="hero-lbl">‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
        <div class="hero-val" id="td-rev">‡∏ø0</div>
        <div class="hero-sub" id="td-cnt">0 ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
      </div>
      <div class="grid2">
        <div class="scard"><div class="scard-lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="td-avg">‡∏ø0</div></div>
        <div class="scard"><div class="scard-lbl">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="scard-val" id="td-items">0 ‡∏ä‡∏¥‡πâ‡∏ô</div></div>
      </div>
      <div class="sec">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="card-list" id="td-list"></div>
    </div>

    <!-- PAGE: TREND -->
    <div id="page-trend" class="page">
      <div class="sec">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
      <div class="pills">
        <button class="pill active" onclick="setTrendPeriod('7d',this)">7 ‡∏ß‡∏±‡∏ô</button>
        <button class="pill" onclick="setTrendPeriod('30d',this)">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
        <button class="pill" onclick="setTrendPeriod('1y',this)">1 ‡∏õ‡∏µ</button>
      </div>
      <div class="chart-box" style="height:200px"><canvas id="trend-chart"></canvas></div>
      <div class="card-list" id="trend-table"></div>
      <div class="sec">üóì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
      <div class="hmwrap">
        <div class="hm-hdr"><span>‡∏à</span><span>‡∏≠</span><span>‡∏û</span><span>‡∏û‡∏§</span><span>‡∏®</span><span>‡∏™</span><span>‡∏≠‡∏≤</span></div>
        <div class="hmgrid" id="heatmap"></div>
      </div>
    </div>

    <!-- PAGE: PEAK -->
    <div id="page-peak" class="page">
      <div class="sec">‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</div>
      <div class="pills">
        <button class="pill active" onclick="setPeakScope('all',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="pill" onclick="setPeakScope('today',this)">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        <button class="pill" onclick="setPeakScope('week',this)">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</button>
      </div>
      <div class="chart-box" style="height:190px"><canvas id="peak-chart"></canvas></div>
      <div class="card-list" id="peak-list"></div>
    </div>

    <!-- PAGE: EXPENSES (COST) -->
    <div id="page-expenses" class="page">
      <div class="pills">
        <button class="pill active" onclick="setExpView('add',this)">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="pill" onclick="setExpView('list',this)">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <button class="pill" onclick="setExpView('analysis',this)">üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
      </div>

      <div id="exp-add">
        <div class="apikey-wrap" id="apikey-wrap">
          <div style="font-size:13px;color:#FFD60A;margin-bottom:10px">üîë ‡πÉ‡∏™‡πà Gemini API Key</div>
          <div style="display:flex;gap:8px">
            <input type="password" class="apikey-input" id="apikey-input" placeholder="AIza...">
            <button class="apikey-save" onclick="saveApiKey()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
        </div>

        <button class="ocr-btn" id="ocr-btn" onclick="document.getElementById('ocr-input').click()">
          <span style="font-size:22px">üì∑</span> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        </button>
        <input type="file" id="ocr-input" accept="image/*" capture="environment" onchange="handleOcrImage(this)">
        <img id="ocr-preview" class="ocr-preview">

        <div class="ocr-result" id="ocr-result">
          <div class="ocr-result-title">‚ú® ‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à <button onclick="clearOcr()" style="background:none;border:none;color:var(--dim);margin-left:auto">‡∏•‡πâ‡∏≤‡∏á</button></div>
          <div id="ocr-items-list"></div>
          <button class="btn-ocr-save" onclick="saveOcrItems()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>

        <div class="form-wrap">
          <div class="form-title">üí∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏∑‡∏≠)</div>
          <div class="form-row"><label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="exp-date" class="form-input"></div>
          <div class="form-row"><label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><div class="cat-pills" id="exp-cat-pills"></div></div>
          <div class="form-row"><label class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" id="exp-item" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π"></div>
          <div class="form-row">
            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô x ‡∏£‡∏≤‡∏Ñ‡∏≤</label>
            <div class="row3">
              <input type="number" id="exp-qty" class="form-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" oninput="calcAmount()">
              <input type="number" id="exp-ppu" class="form-input" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" oninput="calcAmount()">
              <input type="text" id="exp-unit" class="form-input" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢">
            </div>
          </div>
          <div class="form-row"><label class="form-label">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</label><div class="calc-display" id="exp-amount-display">‡∏ø0</div><input type="hidden" id="exp-amount"></div>
          <button class="btn-submit" onclick="submitExpense()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>

      <div id="exp-list" style="display:none">
        <div class="card-list" id="exp-items-list-view"></div>
      </div>

      <div id="exp-analysis" style="display:none">
        <div id="profit-card-wrap"></div>
        <div class="chart-box" style="height:220px"><canvas id="ana-chart"></canvas></div>
      </div>
    </div>

    <!-- PAGE: OTHER INCOME -->
    <div id="page-income" class="page">
        <div class="form-wrap">
          <div class="form-title">üíö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô</div>
          <div class="form-row"><input type="date" id="inc-date" class="form-input"></div>
          <div class="form-row"><input type="text" id="inc-item" class="form-input" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô"></div>
          <div class="form-row"><input type="number" id="inc-amount" class="form-input" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô"></div>
          <button class="btn-submit green" onclick="submitIncome()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
        <div class="card-list" id="inc-items-list"></div>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="bnav-btn active" onclick="showPage('overview',this)"><span class="icon">üìä</span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
    <button class="bnav-btn" onclick="showPage('today',this)"><span class="icon">üìã</span>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    <button class="bnav-btn" onclick="showPage('trend',this)"><span class="icon">üìà</span>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</button>
    <button class="bnav-btn" onclick="showPage('peak',this)"><span class="icon">‚è∞</span>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
    <button class="bnav-btn" onclick="showPage('expenses',this)"><span class="icon">üí∏</span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</button>
    <button class="bnav-btn" onclick="showPage('income',this)"><span class="icon">üíö</span>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô</button>
  </nav>
</div>

<script>
const SB_URL="https://uhruejkycwcxjhcokbfm.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocnVlamt5Y3djeGpoY29rYmZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjE4NDUsImV4cCI6MjA4NzIzNzg0NX0.M67DwOTw2cKXHlPBJnfn7FSsRmUCv83s7J3-CkvZguc";
const sb=supabase.createClient(SB_URL,SB_KEY);

const GEMINI_MODEL='gemini-2.5-flash';
let geminiKey=localStorage.getItem('gemini_api_key')||'';

let allOrders=[], realOrders=[], allExpenses=[], allIncome=[];
const todayStr=new Date().toLocaleDateString('en-CA');
const fmt=n=>(n||0).toLocaleString('th-TH');

const EXP_CATS=[
  {key:'‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏î',icon:'ü•©',color:'#FF6B6B'},
  {key:'‡∏Ç‡∏≠‡∏á‡πÅ‡∏´‡πâ‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á',icon:'üßÇ',color:'#FFD93D'},
  {key:'‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°/‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå',icon:'ü•§',color:'#6BCB77'},
  {key:'‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ',icon:'üî•',color:'#4D96FF'},
  {key:'‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á',icon:'üë§',color:'#32D74B'},
  {key:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ',icon:'üì¶',color:'#8E8E93'}
];

async function init(){
  loader(true);
  try{
    const[oR,eR,iR]=await Promise.all([
      sb.from('orders').select('*').order('created_at',{ascending:false}),
      sb.from('expenses').select('*').order('date',{ascending:false}),
      sb.from('other_income').select('*').order('date',{ascending:false}),
    ]);
    allOrders=oR.data||[];
    realOrders=allOrders.filter(r=>!r.is_history);
    allExpenses=eR.data||[];
    allIncome=iR.data||[];

    buildForms();
    if(!geminiKey) document.getElementById('apikey-wrap').classList.add('show');
    renderAll();
  }catch(e){console.error(e);}
  finally{loader(false);}
}

function loader(s){document.getElementById('loader').style.display=s?'flex':'none';}
function showToast(m,t='ok'){const e=document.getElementById('toast');e.textContent=m;e.className='toast '+t+' show';setTimeout(()=>e.classList.remove('show'),2500);}

function buildForms(){
  document.getElementById('exp-date').value=todayStr;
  document.getElementById('inc-date').value=todayStr;
  const ec=document.getElementById('exp-cat-pills');
  ec.innerHTML=EXP_CATS.map(c=>`<button class="cat-pill" onclick="selectExpCat('${c.key}',this,'${c.color}')">${c.icon} ${c.key}</button>`).join('');
}

let selectedExpCat='';
function selectExpCat(k,b,c){
  selectedExpCat=k;
  document.querySelectorAll('.cat-pill').forEach(x=>{x.classList.remove('active');x.style.background='';});
  b.classList.add('active');b.style.background=c;b.style.color='#000';
}

function calcAmount(){
  const q=parseFloat(document.getElementById('exp-qty').value)||0;
  const p=parseFloat(document.getElementById('exp-ppu').value)||0;
  const amt=q*p;
  document.getElementById('exp-amount').value=amt;
  document.getElementById('exp-amount-display').textContent='‡∏ø'+fmt(amt);
}

async function handleOcrImage(input) {
  if (!input.files || !input.files[0]) return;
  const file = input.files[0];
  const preview = document.getElementById('ocr-preview');
  preview.src = URL.createObjectURL(file);
  preview.style.display = 'block';

  const btn = document.getElementById('ocr-btn');
  btn.classList.add('loading');
  btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à...';

  try {
    const b64 = await new Promise((res) => {
      const r = new FileReader();
      r.onload = () => res(r.result.split(',')[1]);
      r.readAsDataURL(file);
    });

    const prompt = `Read this receipt and return ONLY a JSON array. 
    Format: [{"item":"name","quantity":number,"unit":"unit","amount":total_price,"vendor":"shop_name","date":"YYYY-MM-DD"}]`;

    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${geminiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ inline_data: { mime_type: file.type, data: b64 } }, { text: prompt }] }],
        generationConfig: { temperature: 0.1, response_mime_type: "application/json" }
      })
    });

    if (!resp.ok) throw new Error('AI Error');
    const data = await resp.json();
    const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || '[]';
    const items = JSON.parse(rawText.replace(/```json|```/g, '').trim());

    if (items.length) renderOcrResult(items);
    else showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'err');

  } catch (e) {
    showToast('OCR ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'err');
  } finally {
    btn.classList.remove('loading');
    btn.innerHTML = 'üì∑ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
  }
}

function renderOcrResult(items) {
  window._ocrItems = items;
  const list = document.getElementById('ocr-items-list');
  const catOpts = EXP_CATS.map(c => `<option value="${c.key}">${c.key}</option>`).join('');
  list.innerHTML = items.map((it, i) => `
    <div class="ocr-item">
      <input type="checkbox" class="ocr-check" id="chk-${i}" checked>
      <div class="ocr-item-info">
        <div style="font-size:13px;font-weight:600">${it.item}</div>
        <div style="font-size:11px;color:var(--dim)">${it.quantity||''} ${it.unit||''} | ‡∏ø${fmt(it.amount)}</div>
        <select class="ocr-cat-select" id="cat-${i}">${catOpts}</select>
      </div>
    </div>
  `).join('');
  document.getElementById('ocr-result').style.display = 'block';
}

async function saveOcrItems() {
  const toSave = [];
  window._ocrItems.forEach((it, i) => {
    if (document.getElementById(`chk-${i}`).checked) {
      toSave.push({
        date: it.date || todayStr,
        item: it.item,
        category: document.getElementById(`cat-${i}`).value,
        amount: it.amount,
        quantity: it.quantity,
        unit: it.unit,
        vendor: it.vendor
      });
    }
  });
  if (!toSave.length) return;
  const { error } = await sb.from('expenses').insert(toSave);
  if (!error) {
    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    clearOcr();
    init();
  }
}

function clearOcr() {
  document.getElementById('ocr-result').style.display = 'none';
  document.getElementById('ocr-preview').style.display = 'none';
}

function saveApiKey() {
  const k = document.getElementById('apikey-input').value.trim();
  if (k) {
    localStorage.setItem('gemini_api_key', k);
    geminiKey = k;
    document.getElementById('apikey-wrap').classList.remove('show');
    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API Key ‡πÅ‡∏•‡πâ‡∏ß');
  }
}

function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  btn.classList.add('active');
}

function renderAll() {
  renderOverview();
  renderToday();
}

function renderOverview() {
  const total = allOrders.reduce((s, r) => s + (r.actual_amount || 0), 0);
  document.getElementById('ov-rev').textContent = '‡∏ø' + fmt(total);
  document.getElementById('ov-cnt').textContent = fmt(allOrders.length) + ' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
}

function renderToday() {
  const today = realOrders.filter(r => (r.created_at || '').startsWith(todayStr));
  const rev = today.reduce((s, r) => s + (r.actual_amount || 0), 0);
  document.getElementById('td-rev').textContent = '‡∏ø' + fmt(rev);
  document.getElementById('td-cnt').textContent = fmt(today.length) + ' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
}

function setExpView(v, b) {
  document.getElementById('exp-add').style.display = v === 'add' ? 'block' : 'none';
  document.getElementById('exp-list').style.display = v === 'list' ? 'block' : 'none';
  document.getElementById('exp-analysis').style.display = v === 'analysis' ? 'block' : 'none';
}

async function submitExpense(){
  const it=document.getElementById('exp-item').value;
  const amt=parseFloat(document.getElementById('exp-amount').value);
  if(!it || !amt || !selectedExpCat) return showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö','err');
  const {error} = await sb.from('expenses').insert([{
    date: document.getElementById('exp-date').value,
    item: it,
    category: selectedExpCat,
    amount: amt,
    quantity: parseFloat(document.getElementById('exp-qty').value),
    unit: document.getElementById('exp-unit').value
  }]);
  if(!error) { showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß'); init(); }
}

init();
</script>
</body>
</html>
