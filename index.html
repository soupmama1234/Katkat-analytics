<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KATKAT Analytics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--border:#222;
  --text:#f0f0f0;--muted:#555;--muted2:#888;
  --orange:#f5a623;--green:#4caf50;--blue:#2196f3;--red:#ef5350;
}
html,body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans Thai',sans-serif;min-height:100vh; overflow-x: hidden;}
button{font-family:inherit;cursor:pointer}

/* Layout */
#app{max-width:800px;margin:0 auto;padding-bottom:80px}
.header{padding:20px 16px 0;display:flex;justify-content:space-between;align-items:flex-start}
.header-left .eyebrow{font-size:11px;color:var(--orange);letter-spacing:3px;text-transform:uppercase;margin-bottom:4px}
.header-left h1{font-size:22px;font-weight:700}
.header-left .sub{font-size:11px;color:#444;margin-top:2px}
.header-right{display:flex;gap:8px}

/* Button & Upload Fix */
.icon-btn{background:var(--bg3);border:1px solid var(--border);color:var(--muted2);padding:8px 12px;border-radius:8px;font-size:14px; display:flex; align-items:center; justify-content:center; cursor:pointer;}
.upload-label { position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.upload-label input[type="file"] { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; font-size: 0; }

/* Tabs */
.tabs{display:flex;padding:16px 16px 0;overflow-x:auto;gap:0;border-bottom:1px solid var(--bg3);margin-top:4px}
.tab{background:none;border:none;border-bottom:2px solid transparent;color:var(--muted);padding:8px 14px;font-size:13px;font-family:inherit;white-space:nowrap;transition:all 0.2s}
.tab.active{border-bottom-color:var(--orange);color:var(--orange);font-weight:600}

/* Cards & Stats */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:16px 16px 0}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px}
.section-pad{padding:16px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px}
.stat-label{font-size:11px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.stat-value{font-size:22px;font-weight:700;font-family:'IBM Plex Mono',monospace;line-height:1.2}
.section-title{font-size:11px;font-weight:600;color:#555;text-transform:uppercase;letter-spacing:2px;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--bg3)}

/* Table */
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:8px 0;color:#555;font-weight:500;border-bottom:1px solid var(--border)}
th.r,td.r{text-align:right}
td{padding:10px 0;border-bottom:1px solid var(--bg3);color:#aaa}

/* Empty State */
#empty{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:24px;text-align:center}
.btn-primary{background:var(--orange);color:#000;border:none;padding:14px 20px;border-radius:10px;font-size:14px;font-weight:700;width:100%;max-width:320px}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border);padding:14px 20px;border-radius:10px;font-size:14px;font-weight:600;width:100%;max-width:320px;display:flex;align-items:center;justify-content:center;gap:8px; cursor:pointer;}
</style>
</head>
<body>

<div id="empty">
  <div style="font-size:48px">üìä</div>
  <div style="font-size:20px; font-weight:700; color:var(--orange)">KATKAT Analytics</div>
  <div id="empty-sub" style="font-size:13px; color:#555; max-width:300px; line-height:1.6">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
  <div style="display:flex;flex-direction:column;gap:12px;width:100%;align-items:center" id="empty-btns">
    <button class="btn-primary" id="btn-supabase" style="display:none" onclick="loadSupabase()">‚ö° ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase</button>
    <label class="btn-secondary upload-label">
      üìÇ Upload CSV Backup
      <input type="file" accept=".csv" onchange="loadCSV(event)">
    </label>
  </div>
</div>

<div id="app" style="display:none">
  <div class="header">
    <div class="header-left">
      <div class="eyebrow">KAT KAT KATSU</div>
      <h1>Analytics</h1>
      <div class="sub" id="data-source-label"></div>
    </div>
    <div class="header-right">
      <button class="icon-btn" id="btn-refresh" onclick="loadSupabase()" style="display:none">üîÑ</button>
      <label class="icon-btn upload-label">
        üìÇ
        <input type="file" accept=".csv" onchange="loadCSV(event)">
      </label>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('overview')">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
    <button class="tab" onclick="switchTab('daily')">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
  </div>

  <div id="tab-overview" class="tab-content">
    <div class="grid-2" style="margin-top:16px">
      <div class="stat-card" style="border-top:3px solid var(--orange)">
        <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏£‡∏ß‡∏°</div>
        <div class="stat-value" id="s-revenue">‡∏ø0</div>
      </div>
      <div class="stat-card" style="border-top:3px solid var(--orange)">
        <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</div>
        <div class="stat-value" id="s-count">0</div>
      </div>
    </div>
    <div class="section-pad">
        <div class="card">
            <div class="section-title">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            <div style="height:200px"><canvas id="chart-trend"></canvas></div>
        </div>
    </div>
  </div>
  
  <div id="tab-daily" class="tab-content" style="display:none">
    <div class="section-pad">
      <div class="card">
        <div class="section-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
        <table>
          <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="r">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö</th></tr></thead>
          <tbody id="daily-table"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CONFIG (‡πÄ‡∏ï‡∏¥‡∏° URL ‡πÅ‡∏•‡∏∞ KEY ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPABASE_URL = ""; 
const SUPABASE_KEY = "";

let allOrders = [];
let charts = {};
const fmt = n => (n||0).toLocaleString("th-TH");

window.onload = () => {
  if (SUPABASE_URL && SUPABASE_KEY) {
    document.getElementById("btn-supabase").style.display = "block";
    document.getElementById("btn-refresh").style.display = "block";
    loadSupabase();
  }
};

// ‚îÄ‚îÄ CORE FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadSupabase() {
  setLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase...");
  try {
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { data, error } = await sb.from("orders").select("*").order("created_at", { ascending: false });
    if (error) throw error;
    allOrders = data.map(normalizeRow);
    showApp("supabase");
  } catch(e) { setError("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + e.message); }
}

function loadCSV(e) {
  const file = e.target.files[0];
  if (!file) return;
  setLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV...");
  
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const rows = parseCSV(ev.target.result);
      if (rows.length === 0) throw new Error("‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      allOrders = rows.map(normalizeRow);
      showApp("csv");
    } catch(err) { 
      console.error(err);
      setError("‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message); 
    }
  };
  // ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö UTF-8 ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô windows-874
  reader.readAsText(file, "UTF-8");
}

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return [];

  // ‡πÅ‡∏¢‡∏Å Header (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö , ‡πÅ‡∏•‡∏∞ ;)
  const delimiter = lines[0].indexOf(';') > -1 ? ';' : ',';
  const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g,""));
  
  return lines.slice(1).map(line => {
    const vals = line.split(delimiter).map(v => v.trim().replace(/"/g,""));
    const obj = {};
    headers.forEach((h, i) => { if(h) obj[h] = vals[i] || ""; });
    return obj;
  });
}

function normalizeRow(row) {
  return {
    time: row.created_at || row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤"] || row["Date"] || "",
    actual: Number(row.actual_amount || row["‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á"] || row["Actual"] || 0),
  };
}

// ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showApp(source) {
  document.getElementById("empty").style.display = "none";
  document.getElementById("app").style.display = "block";
  document.getElementById("data-source-label").textContent = source.toUpperCase() + " Mode";
  renderAll();
}

function setLoading(msg) {
  document.getElementById("empty-sub").textContent = msg;
  document.getElementById("empty-btns").style.display = "none";
}

function setError(msg) {
  document.getElementById("empty-sub").innerHTML = `<span style="color:red">${msg}</span>`;
  document.getElementById("empty-btns").style.display = "flex";
}

function switchTab(id) {
  document.querySelectorAll(".tab-content").forEach(el => el.style.display = "none");
  document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
  document.getElementById("tab-" + id).style.display = "block";
  event.target.classList.add("active");
}

function renderAll() {
    const totalRevenue = allOrders.reduce((s,o) => s + o.actual, 0);
    document.getElementById("s-revenue").textContent = "‡∏ø" + fmt(totalRevenue);
    document.getElementById("s-count").textContent = allOrders.length;
    
    const byDay = {};
    allOrders.forEach(o => {
        if(!o.time) return;
        const d = o.time.split("T")[0] || o.time.split(" ")[0];
        byDay[d] = (byDay[d]||0) + o.actual;
    });

    const sortedDays = Object.keys(byDay).sort();
    const chartDays = sortedDays.slice(-7);
    const chartVals = chartDays.map(d => byDay[d]);

    if(charts.trend) charts.trend.destroy();
    const ctx = document.getElementById("chart-trend").getContext("2d");
    charts.trend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartDays.map(d => d.split("-").slice(1).join("/")),
            datasets: [{ 
                data: chartVals, 
                borderColor: '#f5a623', 
                backgroundColor: 'rgba(245, 166, 35, 0.1)',
                fill: true,
                tension: 0.3 
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }, 
            scales: { 
                y: { grid: { color: '#222' }, ticks: { color: '#555' } }, 
                x: { grid: { display: false }, ticks: { color: '#555' } } 
            } 
        }
    });

    const tb = document.getElementById("daily-table");
    tb.innerHTML = Object.entries(byDay).sort((a,b)=>b[0].localeCompare(a[0])).map(([d,v]) => `
        <tr><td>${d}</td><td class="r">‡∏ø${fmt(v)}</td></tr>
    `).join("");
}
</script>
</body>
</html>
