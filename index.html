<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <title>KATKAT Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&family=Inter:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#000;--surface:#121212;--surface2:#1a1a1a;--border:#222;--border2:#2a2a2a;
      --primary:#FF9F0A;--success:#32D74B;--danger:#FF453A;--blue:#0A84FF;
      --text:#fff;--dim:#8E8E93;
      --pos:#ffffff;--grab:#00B14F;--lineman:#00A84F;--shopee:#EE4D2D}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-font-smoothing:antialiased}
    html{height:100%;overflow:hidden}
    body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans Thai',sans-serif;
      margin:0;height:100%;overflow:hidden;user-select:none}

    /* LAYOUT */
    #app{display:flex;flex-direction:column;height:100%;max-width:500px;margin:0 auto}
    .scroll-area{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 16px 24px}

    /* BOTTOM NAV */
    .bottom-nav{display:flex;background:rgba(18,18,18,0.95);backdrop-filter:blur(20px);
      -webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);
      padding:8px 0 calc(8px + env(safe-area-inset-bottom));flex-shrink:0}
    .bnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
      background:none;border:none;color:var(--dim);font-family:inherit;font-size:10px;
      font-weight:500;padding:6px 2px;cursor:pointer;transition:color .2s}
    .bnav-btn .icon{font-size:20px;line-height:1}
    .bnav-btn.active{color:var(--primary)}

    /* HERO */
    .hero{background:linear-gradient(145deg,#1a1a1a,#0a0a0a);border:1px solid var(--border);
      border-radius:24px;padding:24px 20px;margin-bottom:16px;text-align:center}
    .hero-lbl{color:var(--dim);font-size:11px;text-transform:uppercase;letter-spacing:1.5px}
    .hero-val{font-family:'Inter',sans-serif;font-size:40px;font-weight:800;
      color:var(--primary);margin:6px 0;letter-spacing:-1px}
    .hero-sub{color:var(--dim);font-size:13px}
    .hero-range{display:inline-flex;align-items:center;gap:5px;background:#1a1a1a;
      border:1px solid #333;border-radius:20px;padding:5px 12px;margin-top:10px;
      font-size:11px;color:var(--dim)}
    .hero-range b{color:var(--primary)}

    /* TOGGLE PILLS */
    .pills{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
    .pill{background:var(--surface);border:1px solid var(--border);color:var(--dim);
      font-family:inherit;font-size:12px;font-weight:600;padding:6px 14px;
      border-radius:20px;cursor:pointer;transition:all .2s;white-space:nowrap}
    .pill.active{background:var(--primary);color:#000;border-color:var(--primary)}

    /* CARDS */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
    .scard{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:16px}
    .scard-lbl{color:var(--dim);font-size:11px;margin-bottom:5px}
    .scard-val{font-family:'Inter',sans-serif;font-size:18px;font-weight:700}
    .scard-val.red{color:var(--danger)}
    .scard-val.green{color:var(--success)}

    /* SECTION */
    .sec{font-size:14px;font-weight:700;color:var(--dim);margin:20px 0 10px}
    .sec:first-child{margin-top:0}

    /* CHART */
    .chart-box{background:var(--surface);border:1px solid var(--border);border-radius:20px;
      padding:16px;margin-bottom:4px}

    /* LIST CONTAINERS */
    .card-list{background:var(--surface);border-radius:20px;border:1px solid var(--border);
      overflow:hidden;margin-bottom:4px}
    .list-row{display:flex;align-items:center;padding:13px 16px;border-bottom:1px solid var(--border2);gap:10px}
    .list-row:last-child{border-bottom:none}

    /* PLATFORM */
    .pname{font-size:13px;font-weight:700;width:60px;flex-shrink:0}
    .bar-w{flex:1;height:4px;background:#1a1a1a;border-radius:2px}
    .bar-f{height:100%;border-radius:2px;transition:width .6s}
    .pright{text-align:right;flex-shrink:0}
    .pval{font-family:'Inter',sans-serif;font-size:13px;font-weight:700}
    .psub{font-size:10px;color:var(--dim);margin-top:1px}

    /* RANK */
    .rno{font-family:'Inter',sans-serif;font-size:11px;font-weight:800;
      color:#333;width:16px;text-align:center;flex-shrink:0}
    .rno.g{color:#FFD60A}.rno.s{color:#8E8E93}.rno.b{color:#CD7F32}
    .rinfo{flex:1;min-width:0}
    .rname{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rbar-w{height:3px;background:#1a1a1a;border-radius:2px;margin-top:4px}
    .rbar{height:100%;background:var(--primary);border-radius:2px}
    .rright{text-align:right;flex-shrink:0}
    .rqty{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--primary)}
    .rrev{font-size:10px;color:var(--dim);margin-top:1px}

    /* CAT */
    .clist{display:flex;flex-direction:column;gap:8px;margin-bottom:4px}
    .ccard{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 16px}
    .crow{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .cname{font-size:14px;font-weight:600}
    .cval{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;color:var(--success)}
    .cbar-w{height:3px;background:#1a1a1a;border-radius:2px}
    .cbar{height:100%;background:var(--success);border-radius:2px}
    .csub{font-size:11px;color:var(--dim);margin-top:4px}

    /* DAY ROW */
    .ddate{font-size:13px;font-weight:500;flex:1}
    .dval{font-family:'Inter',sans-serif;font-weight:700;color:var(--success);font-size:13px;flex-shrink:0}

    /* TODAY ITEMS */
    .titem{padding:12px 16px;border-bottom:1px solid var(--border2)}
    .titem:last-child{border-bottom:none}
    .tmain{display:flex;justify-content:space-between;align-items:center}
    .tname{font-size:13px;font-weight:600}
    .tqty{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--success)}
    .tmod{font-size:11px;color:var(--dim);margin-top:3px}

    /* HOUR */
    .htime{font-family:'Inter',sans-serif;font-size:12px;font-weight:700;color:var(--dim);width:44px;flex-shrink:0}
    .horders{font-family:'Inter',sans-serif;font-size:12px;font-weight:700;color:var(--primary)}
    .hrev{font-size:10px;color:var(--dim)}

    /* HEATMAP */
    .hmwrap{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:16px;margin-bottom:4px}
    .hm-hdr{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center;margin-bottom:6px}
    .hm-hdr span{font-size:10px;color:var(--dim)}
    .hmgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
    .hmcell{aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:9px;font-family:'Inter',sans-serif}
    .hm-leg{display:flex;align-items:center;gap:5px;margin-top:10px;justify-content:flex-end}
    .hm-leg span{font-size:10px;color:var(--dim)}
    .hm-dots{display:flex;gap:3px}
    .hm-dot{width:11px;height:11px;border-radius:3px}

    /* ‚ïê‚ïê EXPENSE FORM ‚ïê‚ïê */
    .form-wrap{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:16px;margin-bottom:16px}
    .form-title{font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .form-row{margin-bottom:12px}
    .form-label{font-size:11px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:block}
    .form-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:12px;
      padding:12px 14px;color:var(--text);font-family:inherit;font-size:15px;outline:none;
      transition:border-color .2s;-webkit-appearance:none}
    .form-input:focus{border-color:var(--primary)}
    .form-input::placeholder{color:#444}
    .cat-pills{display:flex;flex-wrap:wrap;gap:6px}
    .cat-pill{background:var(--surface2);border:1px solid var(--border);color:var(--dim);
      font-family:inherit;font-size:12px;font-weight:600;padding:7px 12px;
      border-radius:12px;cursor:pointer;transition:all .2s}
    .cat-pill.active{color:#000}
    .unit-pills{display:flex;flex-wrap:wrap;gap:6px}
    .unit-pill{background:var(--surface2);border:1px solid var(--border);color:var(--dim);
      font-family:inherit;font-size:12px;padding:6px 10px;border-radius:10px;cursor:pointer;transition:all .2s}
    .unit-pill.active{background:var(--primary);color:#000;border-color:var(--primary)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .calc-display{background:var(--surface2);border:1px solid var(--border);border-radius:12px;
      padding:12px 14px;font-family:'Inter',sans-serif;font-size:18px;font-weight:700;
      color:var(--primary);text-align:center}
    .btn-submit{width:100%;background:var(--primary);color:#000;border:none;border-radius:14px;
      padding:16px;font-family:inherit;font-size:16px;font-weight:700;cursor:pointer;
      margin-top:4px;transition:opacity .2s;-webkit-appearance:none}
    .btn-submit:active{opacity:.8}
    .btn-submit.green{background:var(--success)}
    .btn-danger{background:none;border:1px solid var(--border);color:var(--dim);border-radius:14px;
      padding:12px;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;width:100%;margin-top:8px}

    /* AUTOCOMPLETE */
    .ac-wrap{position:relative}
    .ac-list{position:absolute;top:100%;left:0;right:0;background:#1e1e1e;border:1px solid #333;
      border-radius:12px;z-index:100;max-height:180px;overflow-y:auto;margin-top:4px;display:none}
    .ac-item{padding:11px 14px;cursor:pointer;font-size:14px;border-bottom:1px solid #2a2a2a;transition:background .15s}
    .ac-item:last-child{border-bottom:none}
    .ac-item:active{background:#2a2a2a}
    .warn-similar{background:rgba(255,159,10,0.1);border:1px solid rgba(255,159,10,0.3);
      border-radius:10px;padding:8px 12px;font-size:12px;color:var(--primary);margin-top:6px;display:none}

    /* EXPENSE LIST */
    .exp-item{padding:13px 16px;border-bottom:1px solid var(--border2)}
    .exp-item:last-child{border-bottom:none}
    .exp-top{display:flex;justify-content:space-between;align-items:flex-start}
    .exp-name{font-size:14px;font-weight:600;flex:1}
    .exp-amt{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;color:var(--danger);flex-shrink:0}
    .exp-amt.income{color:var(--success)}
    .exp-meta{font-size:11px;color:var(--dim);margin-top:3px}
    .exp-cat{display:inline-block;background:var(--surface2);border-radius:6px;
      padding:2px 7px;font-size:10px;font-weight:600;margin-right:4px}

    /* ANALYSIS */
    .profit-card{border-radius:20px;padding:20px;margin-bottom:16px;text-align:center}
    .profit-card.positive{background:rgba(50,215,75,0.1);border:1px solid rgba(50,215,75,0.3)}
    .profit-card.negative{background:rgba(255,69,58,0.1);border:1px solid rgba(255,69,58,0.3)}
    .profit-lbl{font-size:12px;color:var(--dim);text-transform:uppercase;letter-spacing:1px}
    .profit-val{font-family:'Inter',sans-serif;font-size:36px;font-weight:800;margin:6px 0}
    .profit-val.positive{color:var(--success)}
    .profit-val.negative{color:var(--danger)}
    .profit-sub{font-size:12px;color:var(--dim)}

    /* BACKUP */
    .backup-row{display:flex;gap:10px;margin-bottom:16px}
    .backup-btn{flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);
      border-radius:14px;padding:14px;font-family:inherit;font-size:13px;font-weight:600;
      cursor:pointer;text-align:center}

    /* LOADER */
    #loader{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;
      align-items:center;justify-content:center;z-index:1000;transition:opacity .4s}
    .spinner{width:32px;height:32px;border:3px solid #222;border-top-color:var(--primary);
      border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* TOAST */
    .toast{position:fixed;bottom:calc(80px + env(safe-area-inset-bottom));left:50%;
      transform:translateX(-50%) translateY(20px);background:#1e1e1e;border:1px solid #333;
      border-radius:14px;padding:12px 20px;font-size:13px;font-weight:600;
      z-index:999;opacity:0;transition:all .3s;white-space:nowrap;pointer-events:none}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.ok{border-color:rgba(50,215,75,.4);color:var(--success)}
    .toast.err{border-color:rgba(255,69,58,.4);color:var(--danger)}

    .page{display:none}.page.active{display:block}
    .empty{padding:24px;text-align:center;color:var(--dim);font-size:13px}
    /* RECENT HISTORY */
    .recent-panel{background:var(--surface);border:1px solid var(--border2);border-radius:16px;
      padding:12px;margin-bottom:12px}
    .recent-title{font-size:11px;color:var(--dim);font-weight:700;text-transform:uppercase;
      letter-spacing:.5px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
    .recent-item{display:flex;align-items:center;padding:8px 0;border-bottom:1px solid var(--border2);
      gap:10px;cursor:pointer;-webkit-tap-highlight-color:transparent}
    .recent-item:last-child{border-bottom:none}
    .recent-item:active{opacity:.7}
    .recent-info{flex:1;min-width:0}
    .recent-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .recent-meta{font-size:11px;color:var(--dim);margin-top:2px}
    .recent-amt{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--danger);flex-shrink:0}
    .recent-copy{font-size:11px;color:var(--blue);flex-shrink:0;padding:4px 8px;
      background:rgba(10,132,255,0.1);border-radius:8px}

    /* CAT SUGGEST */
    .cat-suggest{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .cat-suggest-chip{background:rgba(255,159,10,0.1);border:1px solid rgba(255,159,10,0.3);
      color:var(--primary);font-size:11px;font-weight:700;padding:5px 10px;border-radius:10px;
      cursor:pointer;transition:all .2s}
    .cat-suggest-chip:active{background:rgba(255,159,10,0.3)}

    select.form-input{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}

    /* OCR */
    .ocr-btn{width:100%;background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid #4D96FF44;
      color:#4D96FF;border-radius:16px;padding:16px;font-family:inherit;font-size:15px;font-weight:700;
      cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px;
      transition:all .2s}
    .ocr-btn:active{opacity:.8;transform:scale(.98)}
    .ocr-btn.loading{color:#888;border-color:#333;pointer-events:none}
    #ocr-input{display:none}
    .ocr-preview{width:100%;border-radius:14px;margin-bottom:12px;max-height:200px;object-fit:cover;display:none}

    /* OCR RESULT CHECKLIST */
    .ocr-result{background:var(--surface);border:1px solid #4D96FF33;border-radius:20px;
      padding:16px;margin-bottom:12px;display:none}
    .ocr-result-title{font-size:13px;font-weight:700;color:#4D96FF;margin-bottom:12px;
      display:flex;align-items:center;gap:6px}
    .ocr-item{display:flex;align-items:center;gap:10px;padding:10px 0;
      border-bottom:1px solid var(--border2)}
    .ocr-item:last-child{border-bottom:none}
    .ocr-check{width:20px;height:20px;border-radius:6px;border:2px solid #333;
      background:none;flex-shrink:0;cursor:pointer;display:flex;align-items:center;
      justify-content:center;transition:all .2s;-webkit-appearance:none;appearance:none}
    .ocr-check:checked{background:#4D96FF;border-color:#4D96FF}
    .ocr-check:checked::after{content:'‚úì';color:#000;font-size:12px;font-weight:800}
    .ocr-item-info{flex:1;min-width:0}
    .ocr-item-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ocr-item-meta{font-size:11px;color:var(--dim);margin-top:2px}
    .ocr-item-amt{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;
      color:var(--danger);flex-shrink:0}
    .ocr-cat-select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;
      padding:4px 8px;font-family:inherit;font-size:11px;color:var(--dim);margin-top:4px;
      -webkit-appearance:none;width:100%}
    .btn-ocr-save{width:100%;background:#4D96FF;color:#000;border:none;border-radius:14px;
      padding:14px;font-family:inherit;font-size:15px;font-weight:700;cursor:pointer;
      margin-top:4px;-webkit-appearance:none}
    .btn-ocr-save:active{opacity:.8}

    /* API KEY SETUP */
    .apikey-wrap{background:var(--surface);border:1px solid #FFD60A33;border-radius:16px;
      padding:16px;margin-bottom:12px;display:none}
    .apikey-wrap.show{display:block}
    .apikey-title{font-size:13px;font-weight:700;color:#FFD60A;margin-bottom:10px}
    .apikey-row{display:flex;gap:8px}
    .apikey-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;
      padding:10px 12px;color:var(--text);font-family:monospace;font-size:12px;outline:none}
    .apikey-input:focus{border-color:#FFD60A}
    .apikey-save{background:#FFD60A;color:#000;border:none;border-radius:10px;padding:10px 14px;
      font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;flex-shrink:0}
  </style>
</head>
<body>
<div id="loader"><div class="spinner"></div><p style="margin-top:14px;color:var(--dim);font-size:11px;letter-spacing:2px">KATKAT</p></div>
<div class="toast" id="toast"></div>

<div id="app">
  <div class="scroll-area" id="scroll-area">

    <!-- ‚ïê‚ïê OVERVIEW ‚ïê‚ïê -->
    <div id="page-overview" class="page active">
      <div class="pills">
        <button class="pill active" onclick="setOvPeriod('today',this)">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        <button class="pill" onclick="setOvPeriod('7d',this)">7 ‡∏ß‡∏±‡∏ô</button>
        <button class="pill" onclick="setOvPeriod('30d',this)">30 ‡∏ß‡∏±‡∏ô</button>
        <button class="pill" onclick="setOvPeriod('all',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
      <div class="hero">
        <div class="hero-lbl">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</div>
        <div class="hero-val" id="ov-rev">‡∏ø0</div>
        <div class="hero-sub" id="ov-cnt">0 ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
        <div class="hero-range">üìÖ <b id="ov-range-lbl">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b></div>
      </div>
      <div class="grid2">
        <div class="scard"><div class="scard-lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="ov-avg">‡∏ø0</div></div>
        <div class="scard"><div class="scard-lbl">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div><div class="scard-val" id="ov-today">‡∏ø0</div></div>
      </div>
      <div class="sec">üì° Platform</div>
      <div class="card-list" id="ov-platform"></div>
      <div class="sec">üèÜ ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ Top 10</div>
      <div class="card-list" id="ov-menu"></div>
      <div class="sec">‚öôÔ∏è Add-on / Modifier ‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</div>
      <div class="card-list" id="ov-modifiers"></div>
      <div class="sec">üìÇ ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
      <div class="clist" id="ov-cat"></div>
      <div class="sec">üìÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
      <div class="card-list" id="ov-daily"></div>
    </div>

    <!-- ‚ïê‚ïê TODAY ‚ïê‚ïê -->
    <div id="page-today" class="page">
      <div class="hero">
        <div class="hero-lbl">‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
        <div class="hero-val" id="td-rev">‡∏ø0</div>
        <div class="hero-sub" id="td-cnt">0 ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
      </div>
      <div class="grid2">
        <div class="scard"><div class="scard-lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="td-avg">‡∏ø0</div></div>
        <div class="scard"><div class="scard-lbl">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="scard-val" id="td-items">0 ‡∏ä‡∏¥‡πâ‡∏ô</div></div>
      </div>
      <div class="sec" style="margin-top:0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="card-list" id="td-list"></div>
    </div>

    <!-- ‚ïê‚ïê TREND ‚ïê‚ïê -->
    <div id="page-trend" class="page">
      <div class="sec" style="margin-top:0">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
      <div class="pills">
        <button class="pill active" onclick="setTrendPeriod('7d',this)">7 ‡∏ß‡∏±‡∏ô</button>
        <button class="pill" onclick="setTrendPeriod('30d',this)">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
        <button class="pill" onclick="setTrendPeriod('1y',this)">1 ‡∏õ‡∏µ</button>
      </div>
      <div class="grid2" style="margin-bottom:12px">
        <div class="scard"><div class="scard-lbl">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div><div class="scard-val green" id="trend-total">‡∏ø0</div></div>
        <div class="scard"><div class="scard-lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="trend-avg">‚Äî</div></div>
        <div class="scard"><div class="scard-lbl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="trend-cnt">0</div></div>
        <div class="scard"><div class="scard-lbl">‡∏ö‡∏¥‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div><div class="scard-val" id="trend-max">‚Äî</div></div>
      </div>
      <div class="card-list" id="trend-mom" style="margin-bottom:14px"></div>
      <div class="chart-box" style="height:200px"><canvas id="trend-chart"></canvas></div>
      <div class="card-list" id="trend-table" style="margin-top:14px;margin-bottom:0"></div>
      <div class="sec">üì° Platform ‡πÅ‡∏¢‡∏Å‡∏ä‡πà‡∏ß‡∏á</div>
      <div class="card-list" id="trend-platform"></div>
      <div class="sec">üìÖ ‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏™‡∏∏‡∏î (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</div>
      <div class="card-list" id="trend-weekday"></div>
      <div class="sec">üóì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
      <div class="hmwrap">
        <div class="hm-hdr"><span>‡∏à</span><span>‡∏≠</span><span>‡∏û</span><span>‡∏û‡∏§</span><span>‡∏®</span><span>‡∏™</span><span>‡∏≠‡∏≤</span></div>
        <div class="hmgrid" id="heatmap"></div>
        <div class="hm-leg"><span>‡∏ô‡πâ‡∏≠‡∏¢</span><div class="hm-dots"><div class="hm-dot" style="background:#1a1a1a"></div><div class="hm-dot" style="background:rgba(255,159,10,.25)"></div><div class="hm-dot" style="background:rgba(255,159,10,.5)"></div><div class="hm-dot" style="background:rgba(255,159,10,.75)"></div><div class="hm-dot" style="background:#FF9F0A"></div></div><span>‡∏°‡∏≤‡∏Å</span></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê PEAK ‚ïê‚ïê -->
    <div id="page-peak" class="page">
      <div class="sec" style="margin-top:0">‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</div>
      <div class="pills">
        <button class="pill active" onclick="setPeakScope('all',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="pill" onclick="setPeakScope('today',this)">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        <button class="pill" onclick="setPeakScope('week',this)">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</button>
        <button class="pill" onclick="setPeakScope('month',this)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
      </div>
      <div class="chart-box" style="height:190px"><canvas id="peak-chart"></canvas></div>
      <div class="sec">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
      <div class="card-list" id="peak-list"></div>
      <div class="sec">üìÜ ‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
      <div class="chart-box" style="height:170px"><canvas id="weekday-chart"></canvas></div>
      <div class="card-list" id="peak-weekday"></div>
    </div>

    <!-- ‚ïê‚ïê EXPENSES ‚ïê‚ïê -->
    <div id="page-expenses" class="page">
      <div class="pills">
        <button class="pill active" onclick="setExpView('add',this)">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="pill" onclick="setExpView('list',this)">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <button class="pill" onclick="setExpView('analysis',this)">üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
        <button class="pill" onclick="setExpView('backup',this)">üíæ Backup</button>
      </div>

      <!-- ADD EXPENSE FORM -->
      <div id="exp-add">

        <!-- API KEY SETUP (‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å) -->
        <div class="apikey-wrap" id="apikey-wrap">
          <div class="apikey-title">üîë ‡πÉ‡∏™‡πà Gemini API Key (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</div>
          <div class="apikey-row">
            <input type="password" class="apikey-input" id="apikey-input" placeholder="AIza...">
            <button class="apikey-save" onclick="saveApiKey()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
          <div style="font-size:10px;color:var(--dim);margin-top:8px">‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÑ‡∏´‡∏ô</div>
        </div>

        <!-- OCR BUTTON -->
        <button class="ocr-btn" id="ocr-btn" onclick="document.getElementById('ocr-input').click()">
          <span style="font-size:22px">üì∑</span> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ / ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
        </button>
        <input type="file" id="ocr-input" accept="image/*" capture="environment" onchange="handleOcrImage(this)">
        <img id="ocr-preview" class="ocr-preview">

        <!-- OCR RESULT CHECKLIST -->
        <div class="ocr-result" id="ocr-result">
          <div class="ocr-result-title">
            <span>‚ú® ‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            <button onclick="clearOcr()" style="margin-left:auto;background:none;border:none;color:var(--dim);font-size:12px;cursor:pointer">‡∏•‡πâ‡∏≤‡∏á</button>
          </div>
          <div id="ocr-items-list"></div>
          <button class="btn-ocr-save" onclick="saveOcrItems()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>

        <div class="form-wrap">
          <div class="form-title">üí∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏∑‡∏≠</div>

          <!-- RECENT HISTORY -->
          <div class="recent-panel" id="recent-panel" style="display:none">
            <div class="recent-title">üïê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‚Äî ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠ copy</div>
            <div id="recent-list"></div>
          </div>

          <div class="form-row">
            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="exp-date" class="form-input">
          </div>

          <div class="form-row">
            <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <div class="cat-pills" id="exp-cat-pills"></div>
            <div class="cat-suggest" id="cat-suggest" style="display:none"></div>
          </div>

          <div class="form-row">
            <label class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
            <div class="ac-wrap">
              <input type="text" id="exp-item" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡∏ô‡∏≠‡∏Å" autocomplete="off" oninput="acInput('exp-item','exp-item-ac',itemHistory);suggestCategory(this.value)">
              <div class="ac-list" id="exp-item-ac"></div>
            </div>
            <div class="warn-similar" id="warn-item"></div>
          </div>

          <div class="form-row">
            <label class="form-label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ <span style="color:var(--danger)">*</span></label>
            <input type="number" id="exp-amount-input" class="form-input" placeholder="‡∏ø ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°" inputmode="decimal" oninput="calcPpu()" style="font-size:20px;font-weight:700;color:var(--primary)">
            <input type="hidden" id="exp-amount">
          </div>

          <div class="form-row">
            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô + ‡∏´‡∏ô‡πà‡∏ß‡∏¢ <span style="font-weight:400;color:var(--dim)">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö ‚Äî ‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢)</span></label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <input type="number" id="exp-qty" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.5" inputmode="decimal" oninput="calcPpu()">
              <div class="ac-wrap">
                <input type="text" id="exp-unit" class="form-input" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô kg" autocomplete="off" oninput="acInput('exp-unit','exp-unit-ac',unitHistory)">
                <div class="ac-list" id="exp-unit-ac"></div>
              </div>
            </div>
            <div class="unit-pills" id="unit-presets" style="margin-top:8px"></div>
            <div id="ppu-display" style="display:none;margin-top:8px;background:var(--surface2);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--dim)">
              ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢: <span id="ppu-val" style="color:var(--primary);font-weight:700;font-family:'Inter',sans-serif"></span>
            </div>
          </div>

          <div class="form-row">
            <label class="form-label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏¥‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <input type="number" id="exp-discount" class="form-input" placeholder="0" inputmode="decimal" oninput="calcPpu()">
          </div>

          <div class="form-row">
            <label class="form-label">‡∏£‡πâ‡∏≤‡∏ô / Vendor</label>
            <div class="ac-wrap">
              <input type="text" id="exp-vendor" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô Makro" autocomplete="off" oninput="acInput('exp-vendor','exp-vendor-ac',vendorHistory)">
              <div class="ac-list" id="exp-vendor-ac"></div>
            </div>
          </div>

          <div class="form-row">
            <label class="form-label">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</label>
            <select id="exp-payment" class="form-input">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>
              <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
              <option value="‡πÇ‡∏≠‡∏ô">‡πÇ‡∏≠‡∏ô</option>
              <option value="‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
              <option value="QR Code">QR Code</option>
            </select>
          </div>

          <div class="form-row">
            <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
            <input type="text" id="exp-note" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î">
          </div>

          <button class="btn-submit" onclick="submitExpense()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>

      <!-- LIST -->
      <div id="exp-list" style="display:none">
        <div class="pills" style="margin-bottom:12px">
          <button class="pill active" onclick="setExpListPeriod('today',this)">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button class="pill" onclick="setExpListPeriod('7d',this)">7 ‡∏ß‡∏±‡∏ô</button>
          <button class="pill" onclick="setExpListPeriod('30d',this)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button class="pill" onclick="setExpListPeriod('all',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
        <div class="grid2" style="margin-bottom:12px">
          <div class="scard"><div class="scard-lbl">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div><div class="scard-val red" id="el-total">‡∏ø0</div></div>
          <div class="scard"><div class="scard-lbl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div><div class="scard-val" id="el-cnt">0</div></div>
        </div>
        <div class="card-list" id="exp-items-list"></div>
      </div>

      <!-- ANALYSIS -->
      <div id="exp-analysis" style="display:none">
        <div class="pills" style="margin-bottom:12px">
          <button class="pill active" onclick="setExpAnaPeriod('30d',this)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button class="pill" onclick="setExpAnaPeriod('6m',this)">6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
          <button class="pill" onclick="setExpAnaPeriod('1y',this)">1 ‡∏õ‡∏µ</button>
          <button class="pill" onclick="setExpAnaPeriod('all',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
        <div id="profit-card-wrap"></div>
        <div class="grid2">
          <div class="scard"><div class="scard-lbl">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div><div class="scard-val green" id="ana-rev">‡∏ø0</div></div>
          <div class="scard"><div class="scard-lbl">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div><div class="scard-val red" id="ana-exp">‡∏ø0</div></div>
          <div class="scard"><div class="scard-lbl">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô</div><div class="scard-val green" id="ana-inc">‡∏ø0</div></div>
          <div class="scard"><div class="scard-lbl">Gross Margin</div><div class="scard-val" id="ana-margin">0%</div></div>
        </div>
        <div class="sec">üìà ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö vs ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
        <div class="chart-box" style="height:220px"><canvas id="ana-chart"></canvas></div>
        <div class="sec">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î</div>
        <div class="clist" id="ana-cat"></div>
        <div class="sec">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</div>
        <div class="card-list" id="ana-price-trend"></div>
        <div class="sec">üè™ Vendor ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î</div>
        <div class="card-list" id="ana-vendor"></div>
      </div>

      <!-- BACKUP -->
      <div id="exp-backup" style="display:none">
        <div class="backup-row">
          <button class="backup-btn" onclick="exportCSV('expenses')">üì• Export ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ CSV</button>
          <button class="backup-btn" onclick="exportCSV('other_income')">üì• Export ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô CSV</button>
        </div>
        <div class="backup-row">
          <button class="backup-btn" onclick="exportCSV('orders')">üì• Export ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå CSV</button>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê OTHER INCOME ‚ïê‚ïê -->
    <div id="page-income" class="page">
      <div class="pills">
        <button class="pill active" onclick="setIncView('add',this)">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="pill" onclick="setIncView('list',this)">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>

      <!-- ADD INCOME FORM -->
      <div id="inc-add">
        <div class="form-wrap">
          <div class="form-title">üíö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô</div>

          <div class="form-row">
            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="inc-date" class="form-input">
          </div>

          <div class="form-row">
            <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <div class="cat-pills" id="inc-cat-pills"></div>
          </div>

          <div class="form-row">
            <label class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
            <div class="ac-wrap">
              <input type="text" id="inc-item" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ó‡∏≠‡∏î" autocomplete="off" oninput="acInput('inc-item','inc-item-ac',incItemHistory)">
              <div class="ac-list" id="inc-item-ac"></div>
            </div>
          </div>

          <div class="form-row">
            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô √ó ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
            <div class="row2">
              <input type="number" id="inc-qty" class="form-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" inputmode="decimal" oninput="calcIncAmount()">
              <input type="number" id="inc-ppu" class="form-input" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢" inputmode="decimal" oninput="calcIncAmount()">
            </div>
          </div>

          <div class="form-row">
            <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
            <input type="text" id="inc-unit" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏¥‡∏ï‡∏£, kg">
          </div>

          <div class="form-row">
            <label class="form-label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</label>
            <div class="calc-display" id="inc-amount-display">‡∏ø0</div>
            <input type="hidden" id="inc-amount">
          </div>

          <div class="form-row">
            <label class="form-label">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</label>
            <div class="ac-wrap">
              <input type="text" id="inc-source" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô" autocomplete="off" oninput="acInput('inc-source','inc-source-ac',sourceHistory)">
              <div class="ac-list" id="inc-source-ac"></div>
            </div>
          </div>

          <div class="form-row">
            <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <input type="text" id="inc-note" class="form-input" placeholder="‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö">
          </div>

          <button class="btn-submit green" onclick="submitIncome()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>

      <!-- INCOME LIST -->
      <div id="inc-list" style="display:none">
        <div class="grid2" style="margin-bottom:12px">
          <div class="scard"><div class="scard-lbl">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏ß‡∏°</div><div class="scard-val green" id="il-total">‡∏ø0</div></div>
          <div class="scard"><div class="scard-lbl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div><div class="scard-val" id="il-cnt">0</div></div>
        </div>
        <div class="card-list" id="inc-items-list"></div>
      </div>
    </div>

  </div><!-- end scroll-area -->

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="bnav-btn active" onclick="showPage('overview',this)"><span class="icon">üìä</span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
    <button class="bnav-btn" onclick="showPage('today',this)"><span class="icon">üìã</span>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    <button class="bnav-btn" onclick="showPage('trend',this)"><span class="icon">üìà</span>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</button>
    <button class="bnav-btn" onclick="showPage('peak',this)"><span class="icon">‚è∞</span>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
    <button class="bnav-btn" onclick="showPage('expenses',this)"><span class="icon">üí∏</span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</button>
    <button class="bnav-btn" onclick="showPage('income',this)"><span class="icon">üíö</span>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô</button>
  </nav>
</div>

<script>
const SB_URL="https://uhruejkycwcxjhcokbfm.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocnVlamt5Y3djeGpoY29rYmZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjE4NDUsImV4cCI6MjA4NzIzNzg0NX0.M67DwOTw2cKXHlPBJnfn7FSsRmUCv83s7J3-CkvZguc";
const sb=supabase.createClient(SB_URL,SB_KEY);

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// allOrders = ‡∏ó‡∏∏‡∏Å orders, realOrders = ‡∏ö‡∏¥‡∏•‡∏à‡∏£‡∏¥‡∏á (is_history!=true), histOrders = historical aggregate
let allOrders=[],realOrders=[],histOrders=[],catMap={},allExpenses=[],allIncome=[];
let ovPeriod='today',trendPeriod='7d',peakScope='all';
let expListPeriod='today',expAnaPeriod='30d';
let trendChart=null,peakChart=null,wdChart=null,anaChart=null;
const fmt=n=>(n||0).toLocaleString('th-TH');
const todayStr=new Date().toLocaleDateString('en-CA');
const CH_COLOR={pos:'#ffffff',grab:'#00B14F',lineman:'#00A84F',shopee:'#EE4D2D'};

// Expense categories
const EXP_CATS=[
  {key:'‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏î',icon:'ü•©',color:'#FF6B6B'},
  {key:'‡∏Ç‡∏≠‡∏á‡πÅ‡∏´‡πâ‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á',icon:'üßÇ',color:'#FFD93D'},
  {key:'‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°/‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå',icon:'ü•§',color:'#6BCB77'},
  {key:'‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ',icon:'üî•',color:'#4D96FF'},
  {key:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤',icon:'üè†',color:'#C77DFF'},
  {key:'‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ',icon:'üõ†',color:'#FF9F0A'},
  {key:'‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á',icon:'üë§',color:'#32D74B'},
  {key:'‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î/‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤',icon:'üì£',color:'#FF2D55'},
  {key:'‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î',icon:'üè∑',color:'#00C7BE'},
  {key:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ',icon:'üì¶',color:'#8E8E93'},
];
const INC_CATS=['‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠','‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô'];
const UNIT_PRESETS=['kg','g','‡∏•‡∏¥‡∏ï‡∏£','‡∏ä‡∏¥‡πâ‡∏ô','‡πÅ‡∏û‡πá‡∏Ñ','‡∏ñ‡∏±‡∏á','‡∏Ç‡∏ß‡∏î','‡∏Å‡∏•‡πà‡∏≠‡∏á'];
const VENDORS=['Makro','Go Wholesale','Shopee','Lotus','Lazada','Rimping','Tops','YOK','7-11','‡∏Ç‡πâ‡∏≤‡∏ß‡πÅ‡∏°‡πà‡∏£‡∏¥‡∏°‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ü‡∏π‡πâ‡∏î','CP Fresh Mart','Mr. DIY'];

// History for autocomplete (populated from DB)
let itemHistory=[],vendorHistory=VENDORS,unitHistory=UNIT_PRESETS,incItemHistory=[],sourceHistory=[];

let selectedExpCat='',selectedIncCat='';

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init(){
  loader(true);
  try{
    const[oR,pR,eR,iR]=await Promise.all([
      sb.from('orders').select('*').order('created_at',{ascending:false}),
      sb.from('products').select('id,name,category'),
      sb.from('expenses').select('*').order('date',{ascending:false}),
      sb.from('other_income').select('*').order('date',{ascending:false}),
    ]);
    if(oR.error) throw oR.error;
    catMap={};(pR.data||[]).forEach(p=>{catMap[p.name]=p.category||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';});
    allOrders=oR.data||[];
    // ‡πÅ‡∏¢‡∏Å historical (is_history=true) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å real orders
    realOrders=allOrders.filter(r=>!r.is_history);
    histOrders=allOrders.filter(r=>r.is_history);
    allExpenses=eR.data||[];
    allIncome=iR.data||[];

    // build history from existing data
    itemHistory=[...new Set(allExpenses.map(e=>e.item).filter(Boolean))];
    vendorHistory=[...new Set([...VENDORS,...allExpenses.map(e=>e.vendor).filter(Boolean)])];
    unitHistory=[...new Set([...UNIT_PRESETS,...allExpenses.map(e=>e.unit).filter(Boolean)])];
    incItemHistory=[...new Set(allIncome.map(i=>i.item).filter(Boolean))];
    sourceHistory=[...new Set(allIncome.map(i=>i.source).filter(Boolean))];

    buildForms();
    initApiKey();
    renderRecentExpenses();
    renderAll();
  }catch(e){alert('Error: '+e.message);}
  finally{loader(false);}
}

function loader(show){
  const el=document.getElementById('loader');
  if(show){el.style.opacity=1;el.style.display='flex';}
  else{setTimeout(()=>{el.style.opacity=0;setTimeout(()=>el.style.display='none',400);},500);}
}

function showToast(msg,type='ok'){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className='toast '+type+' show';
  setTimeout(()=>el.classList.remove('show'),2500);
}

// ‚îÄ‚îÄ BUILD FORMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildForms(){
  // set today date
  document.getElementById('exp-date').value=todayStr;
  document.getElementById('inc-date').value=todayStr;

  // expense category pills
  const ec=document.getElementById('exp-cat-pills');
  ec.innerHTML=EXP_CATS.map(c=>`
    <button class="cat-pill" style="border-color:${c.color}20" onclick="selectExpCat('${c.key}',this,'${c.color}')">${c.icon} ${c.key}</button>
  `).join('');

  // income category pills
  const ic=document.getElementById('inc-cat-pills');
  ic.innerHTML=INC_CATS.map(c=>`
    <button class="cat-pill" onclick="selectIncCat('${c}',this)">${c}</button>
  `).join('');

  // unit presets
  const up=document.getElementById('unit-presets');
  up.innerHTML=UNIT_PRESETS.map(u=>`
    <button class="unit-pill" onclick="selectUnit('${u}',this)">${u}</button>
  `).join('');
}

function selectExpCat(cat,btn,color){
  selectedExpCat=cat;
  document.querySelectorAll('#exp-cat-pills .cat-pill').forEach(b=>{b.classList.remove('active');b.style.background='';b.style.color='';});
  btn.classList.add('active');
  btn.style.background=color;btn.style.borderColor=color;btn.style.color='#000';
}
function selectIncCat(cat,btn){
  selectedIncCat=cat;
  document.querySelectorAll('#inc-cat-pills .cat-pill').forEach(b=>{b.classList.remove('active');b.style.background='';b.style.color='';});
  btn.classList.add('active');btn.style.background='var(--success)';btn.style.color='#000';
}
function selectUnit(u,btn){
  document.getElementById('exp-unit').value=u;
  document.querySelectorAll('.unit-pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  calcAmount();
}

// ‚îÄ‚îÄ AUTOCOMPLETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function acInput(inputId,listId,history){
  const val=document.getElementById(inputId).value.toLowerCase().trim();
  const list=document.getElementById(listId);
  if(!val){list.style.display='none';return;}
  const matches=history.filter(h=>h.toLowerCase().includes(val));
  if(!matches.length){list.style.display='none';return;}
  list.innerHTML=matches.slice(0,6).map(m=>`<div class="ac-item" onclick="selectAc('${inputId}','${listId}','${m}')">${m}</div>`).join('');
  list.style.display='block';

  // warn similar for item
  if(inputId==='exp-item') checkSimilar(val);
}
function selectAc(inputId,listId,val){
  document.getElementById(inputId).value=val;
  document.getElementById(listId).style.display='none';
  if(inputId==='exp-qty'||inputId==='exp-ppu') calcAmount();
}

function checkSimilar(val){
  const warn=document.getElementById('warn-item');
  const similar=itemHistory.filter(h=>{
    if(h.toLowerCase()===val) return false;
    return h.toLowerCase().includes(val)||val.includes(h.toLowerCase().substring(0,4));
  });
  if(similar.length){
    warn.style.display='block';
    warn.textContent=`‚ö†Ô∏è ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á: ${similar.slice(0,3).join(', ')} ‚Äî ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÑ‡∏´‡∏°?`;
  }else{warn.style.display='none';}
}

// ‚îÄ‚îÄ CALC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcPpu(){
  const total=parseFloat(document.getElementById('exp-amount-input').value)||0;
  const qty=parseFloat(document.getElementById('exp-qty').value)||0;
  const disc=parseFloat(document.getElementById('exp-discount').value)||0;
  const net=Math.max(0,total-disc);
  // set hidden amount
  document.getElementById('exp-amount').value=net||total;
  // show ppu if qty given
  const ppuDisplay=document.getElementById('ppu-display');
  const ppuVal=document.getElementById('ppu-val');
  const unit=document.getElementById('exp-unit').value||'‡∏´‡∏ô‡πà‡∏ß‡∏¢';
  if(qty>0&&total>0){
    const ppu=net>0?(net/qty):(total/qty);
    ppuVal.textContent=`‡∏ø${ppu.toFixed(2)}/${unit}`;
    ppuDisplay.style.display='block';
  }else{
    ppuDisplay.style.display='none';
  }
}
function calcIncAmount(){
  const qty=parseFloat(document.getElementById('inc-qty').value)||0;
  const ppu=parseFloat(document.getElementById('inc-ppu').value)||0;
  const amt=qty*ppu;
  document.getElementById('inc-amount').value=amt;
  document.getElementById('inc-amount-display').textContent='‡∏ø'+fmt(amt);
}

// ‚îÄ‚îÄ CATEGORY SUGGEST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function suggestCategory(val){
  const suggest=document.getElementById('cat-suggest');
  if(!val||val.length<2){suggest.style.display='none';return;}
  // guess top matches
  const il=val.toLowerCase();
  const matches=[];
  const rules=[
    {cats:['‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏î'],kw:['‡∏´‡∏°‡∏π','‡πÑ‡∏Å‡πà','‡πÄ‡∏ô‡∏∑‡πâ‡∏≠','‡∏Å‡∏∏‡πâ‡∏á','‡∏õ‡∏•‡∏≤','‡πÑ‡∏Ç‡πà','‡∏ô‡∏°','‡∏ä‡∏µ‡∏™','‡πÄ‡∏ô‡∏¢','‡∏ú‡∏±‡∏Å','‡∏Å‡∏∞‡∏´‡∏•‡πà‡∏≥','‡∏°‡∏±‡∏ô‡∏ù‡∏£‡∏±‡πà‡∏á','‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó','‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°','‡∏Ç‡πâ‡∏≤‡∏ß','‡∏™‡∏±‡∏ô‡∏ô‡∏≠‡∏Å','‡∏™‡∏±‡∏ô‡πÉ‡∏ô','‡∏™‡∏∞‡πÇ‡∏û‡∏Å','‡∏≠‡∏Å‡πÑ‡∏Å‡πà','‡∏ó‡∏π‡∏ô‡πà‡∏≤','‡πÅ‡∏Æ‡∏°','‡πÄ‡∏ö‡∏Ñ']},
    {cats:['‡∏Ç‡∏≠‡∏á‡πÅ‡∏´‡πâ‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á'],kw:['‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô','‡∏ã‡∏≠‡∏™','‡πÅ‡∏õ‡πâ‡∏á','‡πÄ‡∏Å‡∏•‡∏∑‡∏≠','‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•','‡∏°‡∏≤‡∏¢‡∏≠‡∏á','‡∏°‡∏¥‡∏£‡∏¥‡∏ô','‡πÇ‡∏ä‡∏¢‡∏∏','‡πÄ‡∏Å‡∏•‡πá‡∏î','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á','‡∏û‡∏£‡∏¥‡∏Å','‡∏Å‡∏∞‡∏õ‡∏¥','‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤','‡∏ã‡∏µ‡∏≠‡∏¥‡πä‡∏ß','oyster','mayo']},
    {cats:['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°/‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå'],kw:['‡∏ñ‡∏∏‡∏á','‡∏Å‡∏•‡πà‡∏≠‡∏á','‡∏ñ‡πâ‡∏ß‡∏¢','‡∏ä‡πâ‡∏≠‡∏ô','‡∏™‡πâ‡∏≠‡∏°','‡∏ä‡∏≤‡∏°','‡πÅ‡∏Å‡πâ‡∏ß','‡∏ü‡∏¥‡∏•‡πå‡∏°','wrap','container','‡∏ö‡∏£‡∏£‡∏à‡∏∏','‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°','‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏°','‡πÄ‡∏¢‡∏•‡∏•‡∏µ‡πà']},
    {cats:['‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ'],kw:['‡πÅ‡∏Å‡πä‡∏™','‡πÑ‡∏ü','‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤','gas','lpg']},
    {cats:['‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤'],kw:['‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤','‡πÄ‡∏ä‡πà‡∏≤','rent']},
    {cats:['‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ'],kw:['‡∏Å‡∏£‡∏∞‡∏ó‡∏∞','‡∏´‡∏°‡πâ‡∏≠','‡∏°‡∏µ‡∏î','‡πÄ‡∏Ç‡∏µ‡∏¢‡∏á','‡∏ï‡∏∞‡∏´‡∏•‡∏¥‡∏ß','‡∏ó‡∏µ‡πà‡∏Ñ‡∏µ‡∏ö','‡∏ú‡πâ‡∏≤','‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠','‡∏ü‡∏≠‡∏á‡∏ô‡πâ‡∏≥','‡∏ô‡πâ‡∏≥‡∏¢‡∏≤','‡πÑ‡∏°‡πâ','‡∏õ‡∏±‡πä‡∏°','‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤']},
    {cats:['‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î/‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤'],kw:['‡πÑ‡∏ß‡∏ô‡∏¥‡∏•','‡∏õ‡πâ‡∏≤‡∏¢','sticker','‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå','‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤','ads','‡∏ò‡∏á']},
    {cats:['‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î'],kw:['point','‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î','discount','‡∏Ñ‡∏∑‡∏ô','cashback']},
  ];
  for(const rule of rules){
    if(rule.kw.some(k=>il.includes(k))) matches.push(...rule.cats);
  }
  // also match from existing expenses with same item
  const hist=allExpenses.filter(e=>e.item&&e.item.toLowerCase().includes(il)&&e.category);
  hist.forEach(e=>{if(!matches.includes(e.category))matches.unshift(e.category);});

  const unique=[...new Set(matches)].slice(0,3);
  if(!unique.length){suggest.style.display='none';return;}
  suggest.innerHTML=unique.map(c=>{
    const cat=EXP_CATS.find(x=>x.key===c);
    return`<span class="cat-suggest-chip" onclick="applyCatSuggest('${c}')">${cat?.icon||''} ${c}</span>`;
  }).join('');
  suggest.style.display='flex';
}

function applyCatSuggest(cat){
  const btn=document.querySelector(`#exp-cat-pills .cat-pill[onclick*="'${cat}'"]`);
  if(btn) selectExpCat(cat,btn,EXP_CATS.find(c=>c.key===cat)?.color||'#888');
  document.getElementById('cat-suggest').style.display='none';
}

// ‚îÄ‚îÄ RECENT HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRecentExpenses(){
  const recent=allExpenses.slice(0,8);
  const panel=document.getElementById('recent-panel');
  const list=document.getElementById('recent-list');
  if(!recent.length){panel.style.display='none';return;}
  panel.style.display='block';
  list.innerHTML=recent.map((e,i)=>{
    const cat=EXP_CATS.find(c=>c.key===e.category);
    const meta=[e.vendor,e.quantity?`${e.quantity}${e.unit||''}`:null,e.date].filter(Boolean).join(' ¬∑ ');
    return`<div class="recent-item" onclick="copyExpense(${i})">
      <div class="recent-info">
        <div class="recent-name">${e.item||'-'}</div>
        <div class="recent-meta"><span style="color:${cat?.color||'#888'}">${cat?.icon||''} ${e.category||''}</span> ¬∑ ${meta}</div>
      </div>
      <div class="recent-amt">-‡∏ø${fmt(e.amount)}</div>
      <div class="recent-copy">copy</div>
    </div>`;
  }).join('');
}

function copyExpense(idx){
  const e=allExpenses[idx];
  if(!e) return;
  // fill form
  document.getElementById('exp-item').value=e.item||'';
  document.getElementById('exp-amount-input').value=e.amount||'';
  document.getElementById('exp-amount').value=e.amount||'';
  document.getElementById('exp-qty').value=e.quantity||'';
  document.getElementById('exp-unit').value=e.unit||'';
  document.getElementById('exp-vendor').value=e.vendor||'';
  document.getElementById('exp-date').value=todayStr;
  if(e.payment_method) document.getElementById('exp-payment').value=e.payment_method;
  // select category
  if(e.category){
    const cat=EXP_CATS.find(c=>c.key===e.category);
    const btn=document.querySelector(`#exp-cat-pills .cat-pill[onclick*="'${e.category}'"]`);
    if(btn&&cat) selectExpCat(e.category,btn,cat.color);
  }
  calcPpu();
  showToast('‚úÖ Copy ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
  // scroll to form
  document.getElementById('exp-date').scrollIntoView({behavior:'smooth',block:'center'});
}

// ‚îÄ‚îÄ SUBMIT EXPENSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitExpense(){
  const item=document.getElementById('exp-item').value.trim();
  const amountRaw=parseFloat(document.getElementById('exp-amount-input').value)||0;
  const disc=parseFloat(document.getElementById('exp-discount').value)||0;
  const amount=Math.max(0,amountRaw-disc)||amountRaw;
  if(!item){showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','err');return;}
  if(!selectedExpCat){showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','err');return;}
  if(amount<=0){showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô','err');return;}

  const qty=parseFloat(document.getElementById('exp-qty').value)||null;
  const unit=document.getElementById('exp-unit').value||null;
  const ppu=qty&&amount?Math.round((amount/qty)*100)/100:null;

  const row={
    date:document.getElementById('exp-date').value||todayStr,
    item,category:selectedExpCat,
    quantity:qty,unit,price_per_unit:ppu,
    amount,
    vendor:document.getElementById('exp-vendor').value.trim()||null,
    payment_method:document.getElementById('exp-payment').value||null,
    note:document.getElementById('exp-note').value.trim()||null,
  };

  try{
    const{data,error}=await sb.from('expenses').insert(row).select().single();
    if(error) throw error;
    allExpenses.unshift(data);
    if(!itemHistory.includes(item)) itemHistory.push(item);
    if(row.vendor&&!vendorHistory.includes(row.vendor)) vendorHistory.push(row.vendor);
    showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
    resetExpForm();
    renderRecentExpenses();
  }catch(e){showToast('‚ùå '+e.message,'err');}
}

function resetExpForm(){
  ['exp-item','exp-qty','exp-unit','exp-discount','exp-vendor','exp-note'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('exp-amount-input').value='';
  document.getElementById('exp-date').value=todayStr;
  document.getElementById('exp-payment').value='';
  document.getElementById('exp-amount').value='';
  document.getElementById('ppu-display').style.display='none';
  document.getElementById('cat-suggest').style.display='none';
  document.querySelectorAll('#exp-cat-pills .cat-pill').forEach(b=>{b.classList.remove('active');b.style.background='';b.style.color='';});
  document.querySelectorAll('.unit-pill').forEach(b=>b.classList.remove('active'));
  document.getElementById('warn-item').style.display='none';
  selectedExpCat='';
}

// ‚îÄ‚îÄ SUBMIT INCOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitIncome(){
  const item=document.getElementById('inc-item').value.trim();
  const amount=parseFloat(document.getElementById('inc-amount').value)||0;
  if(!item){showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','err');return;}
  if(amount<=0){showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô','err');return;}

  const row={
    date:document.getElementById('inc-date').value||todayStr,
    item:item,
    category:selectedIncCat||'‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô',
    quantity:parseFloat(document.getElementById('inc-qty').value)||null,
    unit:document.getElementById('inc-unit').value||null,
    price_per_unit:parseFloat(document.getElementById('inc-ppu').value)||null,
    amount:amount,
    source:document.getElementById('inc-source').value.trim()||null,
    note:document.getElementById('inc-note').value.trim()||null,
  };

  try{
    const{data,error}=await sb.from('other_income').insert(row).select().single();
    if(error) throw error;
    allIncome.unshift(data);
    if(!incItemHistory.includes(item)) incItemHistory.push(item);
    showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
    ['inc-item','inc-qty','inc-ppu','inc-unit','inc-source','inc-note'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('inc-amount').value='';
    document.getElementById('inc-amount-display').textContent='‡∏ø0';
    selectedIncCat='';
    document.querySelectorAll('#inc-cat-pills .cat-pill').forEach(b=>{b.classList.remove('active');b.style.background='';b.style.color='';});
  }catch(e){showToast('‚ùå '+e.message,'err');}
}

// ‚îÄ‚îÄ VIEW TOGGLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setExpView(v,btn){
  document.getElementById('exp-add').style.display=v==='add'?'block':'none';
  document.getElementById('exp-list').style.display=v==='list'?'block':'none';
  document.getElementById('exp-analysis').style.display=v==='analysis'?'block':'none';
  document.getElementById('exp-backup').style.display=v==='backup'?'block':'none';
  document.querySelectorAll('#page-expenses>.pills .pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(v==='list') renderExpList();
  if(v==='analysis') requestAnimationFrame(()=>renderExpAnalysis());
}
function setIncView(v,btn){
  document.getElementById('inc-add').style.display=v==='add'?'block':'none';
  document.getElementById('inc-list').style.display=v==='list'?'block':'none';
  document.querySelectorAll('#page-income>.pills .pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(v==='list') renderIncList();
}
function setExpListPeriod(p,btn){
  expListPeriod=p;
  document.querySelectorAll('#exp-list .pills .pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderExpList();
}
function setExpAnaPeriod(p,btn){
  expAnaPeriod=p;
  document.querySelectorAll('#exp-analysis .pills .pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderExpAnalysis();
}

// ‚îÄ‚îÄ RENDER EXPENSE LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderExpList(){
  const filtered=filterExpByPeriod(allExpenses,expListPeriod);
  const total=filtered.reduce((s,e)=>s+(e.amount||0),0);
  document.getElementById('el-total').textContent='‡∏ø'+fmt(total);
  document.getElementById('el-cnt').textContent=filtered.length;
  document.getElementById('exp-items-list').innerHTML=filtered.length
    ?filtered.map(e=>{
        const cat=EXP_CATS.find(c=>c.key===e.category);
        return`<div class="exp-item">
          <div class="exp-top">
            <div class="exp-name">${e.item||'-'}</div>
            <div class="exp-amt">-‡∏ø${fmt(e.amount)}</div>
          </div>
          <div class="exp-meta">
            <span class="exp-cat" style="color:${cat?.color||'#888'}">${cat?.icon||''} ${e.category||''}</span>
            ${e.vendor?`<span>${e.vendor}</span> ¬∑ `:''}
            ${e.quantity?`${e.quantity}${e.unit||''} ¬∑ `:''}
            ${e.date||''}
            ${e.note?`<br>üìù ${e.note}`:''}
          </div>
        </div>`;
      }).join('')
    :'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
}

// ‚îÄ‚îÄ RENDER INCOME LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderIncList(){
  const total=allIncome.reduce((s,i)=>s+(i.amount||0),0);
  document.getElementById('il-total').textContent='‡∏ø'+fmt(total);
  document.getElementById('il-cnt').textContent=allIncome.length;
  document.getElementById('inc-items-list').innerHTML=allIncome.length
    ?allIncome.map(i=>`
        <div class="exp-item">
          <div class="exp-top">
            <div class="exp-name">${i.item||'-'}</div>
            <div class="exp-amt income">+‡∏ø${fmt(i.amount)}</div>
          </div>
          <div class="exp-meta">
            ${i.source?`<span>${i.source}</span> ¬∑ `:''}
            ${i.quantity?`${i.quantity}${i.unit||''} ¬∑ `:''}
            ${i.date||''}
            ${i.note?`<br>üìù ${i.note}`:''}
          </div>
        </div>`).join('')
    :'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
}

// ‚îÄ‚îÄ RENDER EXPENSE ANALYSIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderExpAnalysis(){
  // map period ‚Üí filter key
  const ordPeriod={
    '30d':'month','6m':'6m','1y':'1y','all':'all'
  }[expAnaPeriod]||'all';

  const expFiltered=filterExpByPeriod(allExpenses,expAnaPeriod);
  const ordFiltered=filterByPeriod(allOrders,ordPeriod);
  const incFiltered=filterExpByPeriod(allIncome,expAnaPeriod);

  const totalRev=ordFiltered.reduce((s,r)=>s+(r.actual_amount||0),0);
  const totalExp=expFiltered.filter(e=>e.category!=='‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î').reduce((s,e)=>s+(e.amount||0),0);
  const totalDisc=expFiltered.filter(e=>e.category==='‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î').reduce((s,e)=>s+(e.amount||0),0);
  const totalInc=incFiltered.reduce((s,i)=>s+(i.amount||0),0);
  const profit=totalRev+totalInc+totalDisc-totalExp;
  const margin=totalRev>0?Math.round((profit/totalRev)*100):0;

  // profit card
  const pc=document.getElementById('profit-card-wrap');
  pc.innerHTML=`<div class="profit-card ${profit>=0?'positive':'negative'}">
    <div class="profit-lbl">‡∏Å‡∏≥‡πÑ‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£</div>
    <div class="profit-val ${profit>=0?'positive':'negative'}">${profit>=0?'':'-'}‡∏ø${fmt(Math.abs(profit))}</div>
    <div class="profit-sub">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ + ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô + ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ‚àí ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div>
  </div>`;

  document.getElementById('ana-rev').textContent='‡∏ø'+fmt(totalRev);
  document.getElementById('ana-exp').textContent='‡∏ø'+fmt(totalExp);
  document.getElementById('ana-inc').textContent='‡∏ø'+fmt(totalInc+totalDisc);
  document.getElementById('ana-margin').textContent=margin+'%';
  document.getElementById('ana-margin').style.color=margin>=0?'var(--success)':'var(--danger)';

  // ‚îÄ‚îÄ MONTHLY CHART ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö vs ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‚îÄ‚îÄ
  // build monthly maps
  const revByMonth={};
  ordFiltered.forEach(r=>{
    const m=(r.created_at||'').slice(0,7);
    if(m) revByMonth[m]=(revByMonth[m]||0)+(r.actual_amount||0);
  });
  const expByMonth={};
  expFiltered.filter(e=>e.category!=='‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î').forEach(e=>{
    const m=(e.date||'').slice(0,7);
    if(m) expByMonth[m]=(expByMonth[m]||0)+(e.amount||0);
  });

  // union of all months, sorted
  const allMonths=[...new Set([...Object.keys(revByMonth),...Object.keys(expByMonth)])].sort();
  // limit months shown based on period
  const maxMonths={all:999,'1y':12,'6m':6,'30d':1}[expAnaPeriod]||999;
  const months=allMonths.slice(-maxMonths);

  const mLabels=months.map(m=>{const[y,mo]=m.split('-');return new Date(+y,+mo-1).toLocaleDateString('th-TH',{month:'short',year:'2-digit'});});
  const mRev=months.map(m=>Math.round(revByMonth[m]||0));
  const mExp=months.map(m=>Math.round(expByMonth[m]||0));

  if(anaChart)anaChart.destroy();
  const ctx=document.getElementById('ana-chart').getContext('2d');
  anaChart=new Chart(ctx,{
    type:'bar',
    data:{
      labels:mLabels,
      datasets:[
        {label:'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö',data:mRev,backgroundColor:'rgba(50,215,75,0.7)',borderRadius:4,borderSkipped:false},
        {label:'‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô',data:mExp,backgroundColor:'rgba(255,69,58,0.7)',borderRadius:4,borderSkipped:false},
      ]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#888',font:{size:11}}}},
      scales:{
        x:{grid:{display:false},ticks:{color:'#555',font:{size:10},maxRotation:45}},
        y:{display:false,grid:{display:false}}
      }
    }
  });

  // ‚îÄ‚îÄ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‚îÄ‚îÄ
  const catMap2={};
  expFiltered.forEach(e=>{const c=e.category||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ';catMap2[c]=(catMap2[c]||0)+(e.amount||0);});
  const cats=Object.entries(catMap2).sort((a,b)=>b[1]-a[1]);
  const maxC=cats[0]?.[1]||1;
  document.getElementById('ana-cat').innerHTML=cats.map(([c,v])=>{
    const cat=EXP_CATS.find(x=>x.key===c);
    const pct=totalExp>0?Math.round(v/totalExp*100):0;
    return`<div class="ccard">
      <div class="crow"><span class="cname">${cat?.icon||''} ${c}</span><span class="cval" style="color:var(--danger)">‡∏ø${fmt(v)}</span></div>
      <div class="cbar-w"><div class="cbar" style="width:${Math.round(v/maxC*100)}%;background:${cat?.color||'#888'}"></div></div>
      <div class="csub">${pct}% ¬∑ ${expFiltered.filter(e=>e.category===c).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
    </div>`;
  }).join('')||'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';

  // ‚îÄ‚îÄ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‚îÄ‚îÄ
  const itemPpu={};
  expFiltered.filter(e=>e.item&&e.price_per_unit&&e.unit).forEach(e=>{
    if(!itemPpu[e.item]) itemPpu[e.item]=[];
    itemPpu[e.item].push({date:e.date,ppu:e.price_per_unit,unit:e.unit});
  });
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° frequency ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ >= 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  const priceItems=Object.entries(itemPpu)
    .filter(([,r])=>r.length>=2)
    .sort((a,b)=>b[1].length-a[1].length)
    .slice(0,10);
  document.getElementById('ana-price-trend').innerHTML=priceItems.map(([item,records])=>{
    records.sort((a,b)=>a.date.localeCompare(b.date));
    const first=records[0].ppu,last=records[records.length-1].ppu;
    const diff=last-first;const pctChg=first>0?Math.round((diff/first)*100):0;
    const arrow=diff>0?'üî∫':diff<0?'üîª':'‚û°Ô∏è';
    const color=diff>0?'var(--danger)':diff<0?'var(--success)':'var(--dim)';
    return`<div class="list-row">
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item}</div>
        <div style="font-size:11px;color:var(--dim);margin-top:2px">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏ø${last.toFixed(1)}/${records[records.length-1].unit} ¬∑ ${records.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:${color}">${arrow} ${Math.abs(pctChg)}%</div>
        <div style="font-size:10px;color:var(--dim)">‡∏ø${first.toFixed(1)} ‚Üí ‡∏ø${last.toFixed(1)}</div>
      </div>
    </div>`;
  }).join('')||'<div class="empty">‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚â• 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';

  // ‚îÄ‚îÄ Vendor ‚îÄ‚îÄ
  const vendorMap={};
  expFiltered.forEach(e=>{
    if(!e.vendor) return;
    if(!vendorMap[e.vendor]) vendorMap[e.vendor]={cnt:0,total:0};
    vendorMap[e.vendor].cnt++;
    vendorMap[e.vendor].total+=e.amount||0;
  });
  const vendors=Object.entries(vendorMap).sort((a,b)=>b[1].total-a[1].total).slice(0,6);
  const maxV=vendors[0]?.[1].total||1;
  document.getElementById('ana-vendor').innerHTML=vendors.map(([v,d])=>`
    <div class="list-row">
      <div style="font-size:13px;font-weight:600;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${v}</div>
      <div style="flex:2;padding:0 10px">
        <div class="bar-w"><div class="bar-f" style="width:${Math.round(d.total/maxV*100)}%;background:var(--primary)"></div></div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-family:'Inter',sans-serif;font-size:12px;font-weight:700">‡∏ø${fmt(d.total)}</div>
        <div style="font-size:10px;color:var(--dim)">${d.cnt} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
      </div>
    </div>`).join('')||'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
}

// ‚îÄ‚îÄ FILTER HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterByPeriod(orders,period){
  const now=new Date();
  if(period==='today') return orders.filter(r=>(r.created_at||'').startsWith(todayStr));
  if(period==='7d'){const d=new Date(now);d.setDate(d.getDate()-7);return orders.filter(r=>new Date(r.created_at)>=d);}
  if(period==='30d'||period==='month'){const d=new Date(now.getFullYear(),now.getMonth(),1);return orders.filter(r=>new Date(r.created_at)>=d);}
  if(period==='6m'){const d=new Date(now);d.setMonth(d.getMonth()-6);return orders.filter(r=>new Date(r.created_at)>=d);}
  if(period==='1y'){const d=new Date(now);d.setFullYear(d.getFullYear()-1);return orders.filter(r=>new Date(r.created_at)>=d);}
  if(period==='week'){const d=new Date(now);const day=d.getDay();const diff=day===0?-6:1-day;d.setDate(d.getDate()+diff);d.setHours(0,0,0,0);return orders.filter(r=>new Date(r.created_at)>=d);}
  return orders;
}
function filterExpByPeriod(rows,period){
  const now=new Date();
  if(period==='today') return rows.filter(r=>r.date===todayStr);
  if(period==='7d'){const d=new Date(now);d.setDate(d.getDate()-7);return rows.filter(r=>r.date&&r.date>=d.toLocaleDateString('en-CA'));}
  if(period==='30d'){const d=new Date(now.getFullYear(),now.getMonth(),1).toLocaleDateString('en-CA');return rows.filter(r=>r.date&&r.date>=d);}
  if(period==='6m'){const d=new Date(now);d.setMonth(d.getMonth()-6);return rows.filter(r=>r.date&&r.date>=d.toLocaleDateString('en-CA'));}
  if(period==='1y'){const d=new Date(now);d.setFullYear(d.getFullYear()-1);return rows.filter(r=>r.date&&r.date>=d.toLocaleDateString('en-CA'));}
  return rows;
}
function periodLabel(p){return{all:'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',today:'‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ','7d':'7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î','30d':'30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î',week:'‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ',month:'‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ'}[p]||'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';}

// ‚îÄ‚îÄ EXPORT CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function exportCSV(table){
  showToast('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á export...');
  const{data,error}=await sb.from(table).select('*').order('created_at',{ascending:false});
  if(error){showToast('‚ùå '+error.message,'err');return;}
  if(!data.length){showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','err');return;}
  const headers=Object.keys(data[0]);
  const csv=[headers.join(','),...data.map(r=>headers.map(h=>{const v=r[h];return v==null?'':`"${String(v).replace(/"/g,'""')}"`;}).join(','))].join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`${table}_${todayStr}.csv`;a.click();
  URL.revokeObjectURL(url);
  showToast('‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

// ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  btn.classList.add('active');
  document.getElementById('scroll-area').scrollTop=0;
  // re-render charts after page becomes visible (canvas needs non-zero size)
  if(id==='peak') requestAnimationFrame(()=>renderPeak());
  if(id==='trend') requestAnimationFrame(()=>renderTrend());
  if(id==='expenses') requestAnimationFrame(()=>{if(document.getElementById('exp-analysis').style.display!=='none')renderExpAnalysis();});
}

// ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll(){
  renderOverview();renderToday();
  // trend/peak charts ‡πÑ‡∏°‡πà render ‡∏ï‡∏≠‡∏ô init ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ canvas display:none ‚Üí size=0
  // ‡∏à‡∏∞ render ‡∏ï‡∏≠‡∏ô showPage() ‡πÅ‡∏ó‡∏ô
}

// ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setOvPeriod(p,btn){
  ovPeriod=p;
  document.querySelectorAll('#page-overview>.pills .pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');renderOverview();
}
function renderOverview(){
  const orders=filterByPeriod(allOrders,ovPeriod);
  const real=filterByPeriod(realOrders,ovPeriod);
  const s=computeFrom(real);
  const sAll=computeFrom(orders);
  const total=orders.reduce((sum,r)=>sum+(r.actual_amount||0),0);
  // ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏• = allOrders ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏±‡πâ‡∏ô (‡∏£‡∏ß‡∏° historical ‡∏î‡πâ‡∏ß‡∏¢ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤)
  const allCnt=orders.length;
  const avg=allCnt?Math.round(total/allCnt):0;
  document.getElementById('ov-rev').textContent='‡∏ø'+fmt(total);
  document.getElementById('ov-cnt').textContent=fmt(orders.length)+' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
  document.getElementById('ov-avg').textContent=avg?'‡∏ø'+fmt(avg):'‚Äî';
  document.getElementById('ov-today').textContent='‡∏ø'+fmt(computeFrom(filterByPeriod(allOrders,'today')).dailyMap[todayStr]||0);
  document.getElementById('ov-range-lbl').textContent=periodLabel(ovPeriod);
  renderPlatformBars('ov-platform',sAll.platformRev,sAll.platformCnt,total,sAll.posPayment);
  const top=Object.entries(s.menuCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const maxQ=top[0]?.[1]||1;
  document.getElementById('ov-menu').innerHTML=top.length?top.map(([n,q],i)=>rankRow(i,n,q,s.menuRev[n]||0,maxQ)).join(''):'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
  // modifiers
  renderModifiers('ov-modifiers',real);
  const cats=Object.entries(s.catRev).sort((a,b)=>b[1]-a[1]);
  const maxC=cats[0]?.[1]||1;
  document.getElementById('ov-cat').innerHTML=cats.length?cats.map(([c,r])=>`<div class="ccard"><div class="crow"><span class="cname">${c}</span><span class="cval">‡∏ø${fmt(r)}</span></div><div class="cbar-w"><div class="cbar" style="width:${Math.round(r/maxC*100)}%"></div></div><div class="csub">${s.catCnt[c]} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>`).join(''):'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
  document.getElementById('ov-daily').innerHTML=Object.entries(sAll.dailyMap).sort((a,b)=>b[0].localeCompare(a[0])).slice(0,14).map(([d,v])=>`<div class="list-row"><span class="ddate">${new Date(d).toLocaleDateString('th-TH',{weekday:'short',day:'numeric',month:'short'})}</span><span class="dval">‡∏ø${fmt(v)}</span></div>`).join('');
}

// ‚îÄ‚îÄ TODAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderToday(){
  // ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ realOrders ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Äî historical data ‡πÑ‡∏°‡πà‡∏°‡∏µ items ‡πÅ‡∏•‡∏∞ timestamp ‡πÑ‡∏°‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
  const orders=filterByPeriod(realOrders,'today');
  const rev=orders.reduce((s,r)=>s+(r.actual_amount||0),0);
  const cnt=orders.length;
  const menuT={};let totalItems=0;
  orders.forEach(r=>{
    let items=r.items;if(!items)return;
    if(typeof items==='string'){try{items=JSON.parse(items);}catch{return;}}
    if(!Array.isArray(items))return;
    items.forEach(item=>{const n=item.name||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';const q=Number(item.qty||1);totalItems+=q;if(!menuT[n])menuT[n]={qty:0,mods:{}};menuT[n].qty+=q;if(item.selectedModifier?.name){const m=item.selectedModifier.name;menuT[n].mods[m]=(menuT[n].mods[m]||0)+q;}});
  });
  document.getElementById('td-rev').textContent='‡∏ø'+fmt(rev);
  document.getElementById('td-cnt').textContent=fmt(cnt)+' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
  document.getElementById('td-avg').textContent='‡∏ø'+fmt(Math.round(cnt?rev/cnt:0));
  document.getElementById('td-items').textContent=fmt(totalItems)+' ‡∏ä‡∏¥‡πâ‡∏ô';
  const sorted=Object.entries(menuT).sort((a,b)=>b[1].qty-a[1].qty);
  document.getElementById('td-list').innerHTML=sorted.length?sorted.map(([n,d])=>{const mods=Object.entries(d.mods).map(([m,q])=>`‚öôÔ∏è ${m} √ó${q}`).join('  ');return`<div class="titem"><div class="tmain"><span class="tname">${n}</span><span class="tqty">√ó${d.qty}</span></div>${mods?`<div class="tmod">${mods}</div>`:''}</div>`;}).join(''):'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
}

// ‚îÄ‚îÄ MODIFIERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderModifiers(elId,orders){
  const modCount={};
  orders.forEach(r=>{
    let items=r.items;if(!items)return;
    if(typeof items==='string'){try{items=JSON.parse(items);}catch{return;}}
    if(!Array.isArray(items))return;
    items.forEach(item=>{
      const mod=item.selectedModifier?.name||item.modifier?.name||item.modifierName||null;
      if(mod){modCount[mod]=(modCount[mod]||0)+(Number(item.qty)||1);}
      // some platforms store multiple modifiers as array
      if(Array.isArray(item.modifiers)){
        item.modifiers.forEach(m=>{const mn=m.name||m;if(mn)modCount[mn]=(modCount[mn]||0)+(Number(item.qty)||1);});
      }
    });
  });
  const top=Object.entries(modCount).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const maxM=top[0]?.[1]||1;
  document.getElementById(elId).innerHTML=top.length
    ?top.map(([m,q],i)=>`<div class="list-row">
        <div class="rno ${i===0?'g':i===1?'s':i===2?'b':''}">${i+1}</div>
        <div class="rinfo"><div class="rname">${m}</div>
          <div class="rbar-w"><div class="rbar" style="width:${Math.round(q/maxM*100)}%;background:#4D96FF"></div></div>
        </div>
        <div class="rright"><div class="rqty" style="color:#4D96FF">${fmt(q)} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div></div>
      </div>`).join('')
    :'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• modifier</div>';
}

// ‚îÄ‚îÄ TREND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTrendPeriod(p,btn){trendPeriod=p;document.querySelectorAll('#page-trend>.pills .pill').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderTrend();}
function renderTrend(){
  const period=trendPeriod==='7d'?'7d':trendPeriod==='30d'?'30d':'all';
  const orders=filterByPeriod(allOrders,period);
  const real=filterByPeriod(realOrders,period);
  const s=computeFrom(orders);
  const total=orders.reduce((sum,r)=>sum+(r.actual_amount||0),0);
  const realTotal=real.reduce((sum,r)=>sum+(r.actual_amount||0),0);
  const avg=real.length?Math.round(realTotal/real.length):0;
  const maxBill=real.length?Math.max(...real.map(r=>r.actual_amount||0)):0;
  document.getElementById('trend-total').textContent='‡∏ø'+fmt(total);
  document.getElementById('trend-avg').textContent=avg?'‡∏ø'+fmt(avg):'‚Äî';
  document.getElementById('trend-cnt').textContent=fmt(orders.length)+' ‡∏ö‡∏¥‡∏•';
  document.getElementById('trend-max').textContent=maxBill?'‡∏ø'+fmt(maxBill):'‚Äî';

  // ‚îÄ‚îÄ MoM / Period-over-Period ‚îÄ‚îÄ
  const momEl=document.getElementById('trend-mom');
  const now=new Date();
  let prevOrders=[];let prevLabel='';let curLabel='';
  if(trendPeriod==='7d'){
    const d1=new Date(now);d1.setDate(d1.getDate()-14);
    const d2=new Date(now);d2.setDate(d2.getDate()-7);
    prevOrders=allOrders.filter(r=>{const d=new Date(r.created_at);return d>=d1&&d<d2;});
    prevLabel='7 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤';curLabel='7 ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
  }else if(trendPeriod==='30d'){
    const d1=new Date(now.getFullYear(),now.getMonth()-1,1);
    const d2=new Date(now.getFullYear(),now.getMonth(),1);
    prevOrders=allOrders.filter(r=>{const d=new Date(r.created_at);return d>=d1&&d<d2;});
    prevLabel='‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';curLabel='‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ';
  }else if(trendPeriod==='1y'){
    const d1=new Date(now.getFullYear()-1,0,1);
    const d2=new Date(now.getFullYear(),0,1);
    prevOrders=allOrders.filter(r=>{const d=new Date(r.created_at);return d>=d1&&d<d2;});
    prevLabel='‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';curLabel='‡∏õ‡∏µ‡∏ô‡∏µ‡πâ';
  }
  if(prevOrders.length){
    const prevTotal=prevOrders.reduce((s,r)=>s+(r.actual_amount||0),0);
    const prevAvg=prevOrders.length?Math.round(prevTotal/prevOrders.length):0;
    const diff=total-prevTotal;const pct=prevTotal>0?Math.round((diff/prevTotal)*100):0;
    const avgDiff=avg-prevAvg;const avgPct=prevAvg>0?Math.round((avgDiff/prevAvg)*100):0;
    const arrow=diff>=0?'‚ñ≤':'‚ñº';const color=diff>=0?'var(--success)':'var(--danger)';
    const avgArrow=avgDiff>=0?'‚ñ≤':'‚ñº';const avgColor=avgDiff>=0?'var(--success)':'var(--danger)';
    momEl.innerHTML=`
      <div class="list-row" style="flex-wrap:wrap;gap:4px">
        <div style="font-size:12px;color:var(--dim);width:100%;margin-bottom:4px">üìä ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö${prevLabel}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:11px;color:var(--dim)">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div>
          <div style="font-family:'Inter',sans-serif;font-size:15px;font-weight:700;color:${color}">${arrow} ${Math.abs(pct)}% <span style="font-size:11px;font-weight:400">(${diff>=0?'+':''}‡∏ø${fmt(Math.abs(diff))})</span></div>
          <div style="font-size:10px;color:var(--dim)">${prevLabel} ‡∏ø${fmt(prevTotal)}</div>
        </div>
        <div style="flex:1;min-width:0;border-left:1px solid var(--border2);padding-left:14px">
          <div style="font-size:11px;color:var(--dim)">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ö‡∏¥‡∏•</div>
          <div style="font-family:'Inter',sans-serif;font-size:15px;font-weight:700;color:${avgColor}">${avgArrow} ${Math.abs(avgPct)}% <span style="font-size:11px;font-weight:400">(${avgDiff>=0?'+':''}‡∏ø${fmt(Math.abs(avgDiff))})</span></div>
          <div style="font-size:10px;color:var(--dim)">${prevLabel} ‡∏ø${fmt(prevAvg)}</div>
        </div>
      </div>`;
  }else{
    momEl.innerHTML='';
  }
  const sorted=Object.keys(s.dailyMap).sort();
  let labels,values,tableRows;
  if(trendPeriod==='1y'){
    const monthly={};sorted.forEach(d=>{const k=d.slice(0,7);monthly[k]=(monthly[k]||0)+s.dailyMap[d];});
    const mKeys=Object.keys(monthly).sort().slice(-12);
    labels=mKeys.map(k=>{const[y,m]=k.split('-');return new Date(+y,+m-1).toLocaleDateString('th-TH',{month:'short',year:'2-digit'});});
    values=mKeys.map(k=>monthly[k]);
    tableRows=mKeys.slice().reverse().map(k=>{const[y,m]=k.split('-');return{label:new Date(+y,+m-1).toLocaleDateString('th-TH',{month:'long',year:'numeric'}),val:monthly[k]};});
  }else{
    const n=trendPeriod==='7d'?7:30;const sl=sorted.slice(-n);
    labels=sl.map(d=>d.split('-')[2]);values=sl.map(d=>s.dailyMap[d]);
    tableRows=sl.slice().reverse().map(d=>({label:new Date(d).toLocaleDateString('th-TH',{weekday:'short',day:'numeric',month:'short'}),val:s.dailyMap[d]}));
  }
  if(trendChart)trendChart.destroy();
  const ctx=document.getElementById('trend-chart').getContext('2d');
  trendChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{data:values,borderColor:'#FF9F0A',borderWidth:3,tension:0.4,fill:true,backgroundColor:'rgba(255,159,10,0.07)',pointRadius:2,pointBackgroundColor:'#FF9F0A'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{color:'#555',font:{size:11}}},y:{display:false}}}});
  document.getElementById('trend-table').innerHTML=tableRows.map(r=>`<div class="list-row"><span class="ddate">${r.label}</span><span class="dval">‡∏ø${fmt(r.val)}</span></div>`).join('');
  renderPlatformBars('trend-platform',s.platformRev,s.platformCnt,total,s.posPayment);
  renderWeekdayBars('trend-weekday',s.byWeekday);
  const sAll=computeFrom(allOrders);renderHeatmap(sAll.dailyMap);
}

// ‚îÄ‚îÄ PEAK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setPeakScope(p,btn){peakScope=p;document.querySelectorAll('#page-peak>.pills .pill').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderPeak();}
function renderPeak(){
  // Peak hours ‡πÉ‡∏ä‡πâ realOrders ‚Äî historical ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡∏ñ‡∏π‡∏Å set ‡πÄ‡∏õ‡πá‡∏ô 12:00 ‡∏ó‡∏≥‡πÉ‡∏´‡πâ hour chart ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
  const orders=filterByPeriod(realOrders,peakScope);
  const s=computeFrom(orders);
  const active=s.byHour.filter(h=>h.orders>0);
  const maxO=Math.max(...active.map(h=>h.orders),1);
  if(peakChart)peakChart.destroy();
  const ctx1=document.getElementById('peak-chart').getContext('2d');
  peakChart=new Chart(ctx1,{type:'bar',data:{labels:s.byHour.map(h=>h.hour+':00'),datasets:[{data:s.byHour.map(h=>h.orders),backgroundColor:s.byHour.map(h=>h.orders>0&&h.orders===maxO?'#FF9F0A':'rgba(255,159,10,.2)'),borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{color:'#555',font:{size:9},maxRotation:0}},y:{display:false}}}});
  document.getElementById('peak-list').innerHTML=[...active].sort((a,b)=>b.orders-a.orders).map(h=>`<div class="list-row"><div class="htime">${String(h.hour).padStart(2,'0')}:00</div><div class="bar-w"><div class="bar-f" style="width:${Math.round(h.orders/maxO*100)}%;background:var(--primary)"></div></div><div class="hright"><div class="horders">${h.orders} ‡∏ö‡∏¥‡∏•</div><div class="hrev">‡∏ø${fmt(h.revenue)}</div></div></div>`).join('');
  const avgs=s.byWeekday.map(d=>d.cnt?Math.round(d.rev/d.cnt):0);
  const maxA=Math.max(...avgs,1);
  const dayNames=['‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™','‡∏≠‡∏≤'];
  if(wdChart)wdChart.destroy();
  const ctx2=document.getElementById('weekday-chart').getContext('2d');
  wdChart=new Chart(ctx2,{type:'bar',data:{labels:dayNames,datasets:[{data:avgs,backgroundColor:avgs.map(v=>v===maxA?'#32D74B':'rgba(50,215,75,.2)'),borderRadius:5,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{color:'#555',font:{size:11}}},y:{display:false}}}});
  renderWeekdayBars('peak-weekday',s.byWeekday);
}

// ‚îÄ‚îÄ COMPUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeFrom(orders){
  const dailyMap={},menuCount={},menuRev={},catRev={},catCnt={},platformRev={},platformCnt={};
  const byHour=Array.from({length:24},(_,i)=>({hour:i,orders:0,revenue:0}));
  const byWeekday=Array(7).fill(null).map(()=>({rev:0,cnt:0}));
  // pos payment breakdown: {cash, transfer, card, qr, other}
  const posPayment={cash:0,transfer:0,card:0,qr:0,other:0};
  orders.forEach(r=>{
    const actual=r.actual_amount||0;
    const date=(r.created_at||'').split('T')[0];
    if(date)dailyMap[date]=(dailyMap[date]||0)+actual;
    const ch=(r.channel||'pos').toLowerCase();
    platformRev[ch]=(platformRev[ch]||0)+actual;platformCnt[ch]=(platformCnt[ch]||0)+1;
    // track pos payment method
    if(ch==='pos'&&actual>0){
      const pm=(r.payment||'').toLowerCase();
      if(pm.includes('‡πÇ‡∏≠‡∏ô')||pm.includes('transfer')) posPayment.transfer+=actual;
      else if(pm.includes('‡∏ö‡∏±‡∏ï‡∏£')||pm.includes('card')||pm.includes('credit')) posPayment.card+=actual;
      else if(pm.includes('qr')||pm.includes('promptpay')) posPayment.qr+=actual;
      else if(pm.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î')||pm.includes('cash')) posPayment.cash+=actual;
      else posPayment.other+=actual;
    }
    if(r.created_at){const d=new Date(r.created_at);const h=d.getHours();byHour[h].orders++;byHour[h].revenue+=actual;const wd=d.getDay();const idx=wd===0?6:wd-1;byWeekday[idx].rev+=actual;byWeekday[idx].cnt++;}
    let items=r.items;if(!items)return;
    if(typeof items==='string'){try{items=JSON.parse(items);}catch{return;}}
    if(!Array.isArray(items))return;
    items.forEach(item=>{const n=item.name||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';const q=Number(item.qty||1);const p=Number(item.price||0);const cat=catMap[n]||item.category||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';menuCount[n]=(menuCount[n]||0)+q;menuRev[n]=(menuRev[n]||0)+(p*q);catRev[cat]=(catRev[cat]||0)+(p*q);catCnt[cat]=(catCnt[cat]||0)+q;});
  });
  return{dailyMap,menuCount,menuRev,catRev,catCnt,platformRev,platformCnt,byHour,byWeekday,posPayment};
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPlatformBars(elId,platformRev,platformCnt,totalRev,posPayment){
  const order=['pos','grab','lineman','shopee'];
  const label={pos:'POS',grab:'Grab',lineman:'Lineman',shopee:'Shopee'};
  const maxRev=Math.max(...Object.values(platformRev),1);
  const html=order.filter(k=>platformRev[k]>0).map(k=>{
    const color=CH_COLOR[k]||'#888';const pct=Math.round((platformRev[k]/maxRev)*100);
    const share=totalRev>0?Math.round((platformRev[k]/totalRev)*100):0;
    // POS payment breakdown icons
    let posDetail='';
    if(k==='pos'&&posPayment){
      const pp=posPayment;
      const posTotal=platformRev.pos||1;
      const parts=[];
      if(pp.cash>0) parts.push(`<span title="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">üíµ ${Math.round(pp.cash/posTotal*100)}% ‡∏ø${fmt(pp.cash)}</span>`);
      if(pp.transfer>0) parts.push(`<span title="‡πÇ‡∏≠‡∏ô">üì≤ ${Math.round(pp.transfer/posTotal*100)}% ‡∏ø${fmt(pp.transfer)}</span>`);
      if(pp.qr>0) parts.push(`<span title="QR/PromptPay">üì± ${Math.round(pp.qr/posTotal*100)}% ‡∏ø${fmt(pp.qr)}</span>`);
      if(pp.card>0) parts.push(`<span title="‡∏ö‡∏±‡∏ï‡∏£">üí≥ ${Math.round(pp.card/posTotal*100)}% ‡∏ø${fmt(pp.card)}</span>`);
      if(pp.other>0&&(pp.cash+pp.transfer+pp.qr+pp.card)===0) parts.push(`<span title="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‚ùì</span>`);
      if(parts.length) posDetail=`<div style="font-size:10px;color:var(--dim);margin-top:3px;display:flex;gap:8px">${parts.join('')}</div>`;
    }
    return`<div class="list-row" style="flex-wrap:wrap">
      <div class="pname" style="color:${color}">${label[k]}</div>
      <div class="bar-w"><div class="bar-f" style="width:${pct}%;background:${color}"></div></div>
      <div class="pright"><div class="pval" style="color:${color}">‡∏ø${fmt(platformRev[k])}</div><div class="psub">${platformCnt[k]} ‡∏ö‡∏¥‡∏• ¬∑ ${share}%</div></div>
      ${posDetail?`<div style="width:100%;padding-left:60px">${posDetail}</div>`:''}
    </div>`;
  }).join('');
  document.getElementById(elId).innerHTML=html||'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
}
function renderWeekdayBars(elId,byWeekday){
  const dayNames=['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå','‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'];
  const avgs=byWeekday.map(d=>d.cnt?Math.round(d.rev/d.cnt):0);
  const maxA=Math.max(...avgs,1);
  document.getElementById(elId).innerHTML=avgs.map((a,i)=>`<div class="list-row"><div style="font-size:13px;font-weight:600;width:52px;flex-shrink:0">${dayNames[i]}</div><div class="bar-w"><div class="bar-f" style="width:${Math.round(a/maxA*100)}%;background:var(--primary)"></div></div><div style="text-align:right;flex-shrink:0"><div style="font-family:'Inter',sans-serif;font-size:12px;font-weight:700;color:var(--primary)">‡∏ø${fmt(a)}</div><div style="font-size:10px;color:var(--dim)">${byWeekday[i].cnt} ‡∏ß‡∏±‡∏ô</div></div></div>`).join('');
}
function renderHeatmap(dailyMap){
  const now=new Date();const y=now.getFullYear(),mo=now.getMonth();
  const dim=new Date(y,mo+1,0).getDate();const fd=new Date(y,mo,1).getDay();
  const offset=fd===0?6:fd-1;
  let maxD=0;
  for(let d=1;d<=dim;d++){const k=`${y}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;maxD=Math.max(maxD,dailyMap[k]||0);}
  let html='';
  for(let i=0;i<offset;i++)html+='<div></div>';
  for(let d=1;d<=dim;d++){
    const k=`${y}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const v=dailyMap[k]||0;const isToday=k===todayStr;const p=maxD>0?v/maxD:0;
    const bg=p>0.75?'#FF9F0A':p>0.5?'rgba(255,159,10,.75)':p>0.25?'rgba(255,159,10,.5)':p>0?'rgba(255,159,10,.25)':'#1a1a1a';
    html+=`<div class="hmcell" style="background:${bg};color:${p>0.5?'#000':'#555'};font-weight:${isToday?700:400};outline:${isToday?'2px solid #FF9F0A':'none'};outline-offset:-1px">${d}</div>`;
  }
  document.getElementById('heatmap').innerHTML=html;
}
function rankRow(i,name,qty,rev,maxQ){
  const cls=i===0?'g':i===1?'s':i===2?'b':'';
  return`<div class="list-row"><div class="rno ${cls}">${i+1}</div><div class="rinfo"><div class="rname">${name}</div><div class="rbar-w"><div class="rbar" style="width:${Math.round(qty/maxQ*100)}%"></div></div></div><div class="rright"><div class="rqty">${qty} ‡∏ä‡∏¥‡πâ‡∏ô</div><div class="rrev">‡∏ø${fmt(rev)}</div></div></div>`;
}

// close autocomplete on outside click
document.addEventListener('click',e=>{
  if(!e.target.classList.contains('form-input')&&!e.target.classList.contains('ac-item'))
    document.querySelectorAll('.ac-list').forEach(l=>l.style.display='none');
});

// ‚îÄ‚îÄ OCR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GEMINI_MODEL='gemini-2.5-flash';
let geminiKey='';

function initApiKey(){
  geminiKey=localStorage.getItem('gemini_api_key')||'';
  if(!geminiKey){
    const wrap=document.getElementById('apikey-wrap');
    if(wrap) wrap.classList.add('show');
    const btn=document.getElementById('ocr-btn');
    if(btn){btn.style.opacity='0.4';btn.style.pointerEvents='none';}
  }
}

function saveApiKey(){
  const k=(document.getElementById('apikey-input').value||'').trim();
  if(!k){showToast('‡πÉ‡∏™‡πà API key ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö','err');return;}
  localStorage.setItem('gemini_api_key',k);
  geminiKey=k;
  document.getElementById('apikey-wrap').classList.remove('show');
  const btn=document.getElementById('ocr-btn');
  if(btn){btn.style.opacity='';btn.style.pointerEvents='';}
  showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API key ‡πÅ‡∏•‡πâ‡∏ß');
}

async function handleOcrImage(input){
  if(!input.files||!input.files[0]) return;
  const file=input.files[0];

  const preview=document.getElementById('ocr-preview');
  if(preview){preview.src=URL.createObjectURL(file);preview.style.display='block';}

  const btn=document.getElementById('ocr-btn');
  btn.disabled=true;
  btn.innerHTML='<span style="font-size:18px">‚è≥</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à...';
  document.getElementById('ocr-result').style.display='none';

  try{
    const b64=await new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result.split(',')[1]);
      r.onerror=rej;
      r.readAsDataURL(file);
    });

    const prompt=`‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß return JSON array ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô
format: [{"item":"‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","quantity":‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,"unit":"‡∏´‡∏ô‡πà‡∏ß‡∏¢","amount":‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°,"vendor":"‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô","date":"YYYY-MM-DD"}]
- item: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ï‡∏≤‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
- quantity: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
- unit: kg/g/‡∏ä‡∏¥‡πâ‡∏ô/‡πÅ‡∏û‡πá‡∏Ñ ‡∏Ø‡∏•‡∏Ø
- amount: ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏ø)
- vendor: ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
- date: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à format YYYY-MM-DD ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏™‡πà null
‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ return []`;

    const resp=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${geminiKey}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        contents:[{parts:[
          {inline_data:{mime_type:file.type,data:b64}},
          {text:prompt}
        ]}],
        generationConfig:{temperature:0.1}
      })
    });

    const result=await resp.json();
    if(!resp.ok) throw new Error(`${resp.status}: ${result.error?.message||'API error'}`);

    const rawText=result.candidates?.[0]?.content?.parts?.[0]?.text||'[]';
    const cleanText=rawText.replace(/```json|```/g,'').trim();
    const items=JSON.parse(cleanText);

    if(!items.length){showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ','err');return;}
    renderOcrResult(items);

  }catch(err){
    showToast('‚ùå '+err.message,'err');
    console.error(err);
  }finally{
    btn.disabled=false;
    btn.innerHTML='<span style="font-size:22px">üì∑</span> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ / ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à';
    input.value='';
  }
}

function renderOcrResult(items){
  const catOptions=EXP_CATS.map(c=>`<option value="${c.key}">${c.icon} ${c.key}</option>`).join('');
  document.getElementById('ocr-items-list').innerHTML=items.map((item,i)=>`
    <div class="ocr-item" id="ocr-item-${i}">
      <input type="checkbox" class="ocr-check" id="ocr-chk-${i}" checked>
      <div class="ocr-item-info">
        <div class="ocr-item-name">${item.item||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
        <div class="ocr-item-meta">
          ${item.quantity?`${item.quantity}${item.unit||''} ¬∑ `:''}
          ${item.vendor||''}
          ${item.date?` ¬∑ ${item.date}`:''}
        </div>
        <select class="ocr-cat-select" id="ocr-cat-${i}">${catOptions}</select>
      </div>
      <div class="ocr-item-amt">‡∏ø${fmt(item.amount)}</div>
    </div>
  `).join('');

  items.forEach((item,i)=>{
    const sel=document.getElementById(`ocr-cat-${i}`);
    if(sel) sel.value=guessCategory(item.item||'');
  });

  window._ocrItems=items;
  document.getElementById('ocr-result').style.display='block';
  document.getElementById('ocr-result').scrollIntoView({behavior:'smooth',block:'nearest'});
}

function guessCategory(item){
  const il=item.toLowerCase();
  if(['‡∏´‡∏°‡∏π','‡πÑ‡∏Å‡πà','‡πÄ‡∏ô‡∏∑‡πâ‡∏≠','‡∏Å‡∏∏‡πâ‡∏á','‡πÑ‡∏Ç‡πà','‡∏ô‡∏°','‡∏ä‡∏µ‡∏™','‡πÄ‡∏ô‡∏¢','‡∏Å‡∏∞‡∏´‡∏•‡πà‡∏≥','‡∏´‡∏≠‡∏°‡πÉ‡∏´‡∏ç‡πà','‡∏°‡∏±‡∏ô‡∏ù‡∏£‡∏±‡πà‡∏á','‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó','‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°','‡∏Ç‡πâ‡∏≤‡∏ß','‡∏™‡∏±‡∏ô‡∏ô‡∏≠‡∏Å','‡∏™‡∏±‡∏ô‡πÉ‡∏ô','‡∏™‡∏∞‡πÇ‡∏û‡∏Å','‡∏≠‡∏Å‡πÑ‡∏Å‡πà'].some(k=>il.includes(k))) return '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏î';
  if(['‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô','‡∏ã‡∏≠‡∏™','‡πÅ‡∏õ‡πâ‡∏á','‡πÄ‡∏Å‡∏•‡∏∑‡∏≠','‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•','‡∏°‡∏≤‡∏¢‡∏≠‡∏á','‡∏°‡∏¥‡∏£‡∏¥‡∏ô','‡πÇ‡∏ä‡∏¢‡∏∏','‡πÄ‡∏Å‡∏•‡πá‡∏î‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á'].some(k=>il.includes(k))) return '‡∏Ç‡∏≠‡∏á‡πÅ‡∏´‡πâ‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á';
  if(['‡∏ñ‡∏∏‡∏á','‡∏Å‡∏•‡πà‡∏≠‡∏á','‡∏ñ‡πâ‡∏ß‡∏¢','‡∏ä‡πâ‡∏≠‡∏ô','‡∏™‡πâ‡∏≠‡∏°','‡∏ä‡∏≤‡∏°'].some(k=>il.includes(k))) return '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°/‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå';
  if(['‡πÅ‡∏Å‡πä‡∏™','‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°'].some(k=>il.includes(k))) return '‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ';
  if(['‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤'].some(k=>il.includes(k))) return '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤';
  return '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏î';
}

async function saveOcrItems(){
  const items=window._ocrItems||[];
  const toSave=[];
  items.forEach((item,i)=>{
    const chk=document.getElementById(`ocr-chk-${i}`);
    if(!chk?.checked) return;
    const cat=document.getElementById(`ocr-cat-${i}`)?.value||'‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏î';
    toSave.push({
      date:item.date||todayStr,
      item:item.item,
      category:cat,
      quantity:item.quantity||null,
      unit:item.unit||null,
      price_per_unit:item.quantity&&item.amount?Math.round((item.amount/item.quantity)*100)/100:null,
      amount:item.amount,
      vendor:item.vendor||null,
      note:'ocr',
    });
  });

  if(!toSave.length){showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å','err');return;}

  const btn=document.querySelector('.btn-ocr-save');
  btn.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  btn.disabled=true;

  try{
    const{error}=await sb.from('expenses').insert(toSave);
    if(error) throw error;
    const{data}=await sb.from('expenses').select('*').order('date',{ascending:false}).limit(toSave.length+10);
    if(data) allExpenses=[...data.filter(d=>!allExpenses.find(e=>e.id===d.id)),...allExpenses];
    toSave.forEach(e=>{
      if(e.item&&!itemHistory.includes(e.item)) itemHistory.push(e.item);
      if(e.vendor&&!vendorHistory.includes(e.vendor)) vendorHistory.push(e.vendor);
    });
    showToast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${toSave.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß`);
    clearOcr();
  }catch(e){
    showToast('‚ùå '+e.message,'err');
  }finally{
    btn.textContent='üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
    btn.disabled=false;
  }
}

function clearOcr(){
  document.getElementById('ocr-result').style.display='none';
  const preview=document.getElementById('ocr-preview');
  if(preview){preview.style.display='none';preview.src='';}
  window._ocrItems=[];
}

init();
</script>
</body>
</html>
