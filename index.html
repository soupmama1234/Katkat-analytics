<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KATKAT Analytics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--border:#222;
  --text:#f0f0f0;--muted:#555;--muted2:#888;
  --orange:#f5a623;--green:#4caf50;--blue:#2196f3;--red:#ef5350;
}
html,body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans Thai',sans-serif;min-height:100vh; overflow-x: hidden;}
button{font-family:inherit;cursor:pointer}
input[type=file]{display:none}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* Layout */
#app{max-width:800px;margin:0 auto;padding-bottom:80px}
.header{padding:20px 16px 0;display:flex;justify-content:space-between;align-items:flex-start}
.header-left .eyebrow{font-size:11px;color:var(--orange);letter-spacing:3px;text-transform:uppercase;margin-bottom:4px}
.header-left h1{font-size:22px;font-weight:700}
.header-left .sub{font-size:11px;color:#444;margin-top:2px}
.header-right{display:flex;gap:8px}

/* Button Fixes */
.icon-btn{background:var(--bg3);border:1px solid var(--border);color:var(--muted2);padding:8px 12px;border-radius:8px;font-size:14px; display:flex; align-items:center; justify-content:center; cursor:pointer;}
.upload-label { position: relative; overflow: hidden; cursor: pointer; }
.upload-label input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2; }

/* Tabs */
.tabs{display:flex;padding:16px 16px 0;overflow-x:auto;gap:0;border-bottom:1px solid var(--bg3);margin-top:4px}
.tab{background:none;border:none;border-bottom:2px solid transparent;color:var(--muted);padding:8px 14px;font-size:13px;font-family:inherit;white-space:nowrap;transition:all 0.2s}
.tab.active{border-bottom-color:var(--orange);color:var(--orange);font-weight:600}

/* Cards */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:16px 16px 0}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px}
.section-pad{padding:16px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px}
.stat-label{font-size:11px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.stat-value{font-size:22px;font-weight:700;font-family:'IBM Plex Mono',monospace;line-height:1.2}
.stat-sub{font-size:12px;color:#555;margin-top:4px}
.section-title{font-size:11px;font-weight:600;color:#555;text-transform:uppercase;letter-spacing:2px;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--bg3)}

/* Table & Charts */
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:8px 0;color:#555;font-weight:500;border-bottom:1px solid var(--border)}
th.r,td.r{text-align:right}
td{padding:10px 0;border-bottom:1px solid var(--bg3);color:#aaa}
.chart-wrap{position:relative;margin-top:8px}

/* Empty / loading */
#empty{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:24px;text-align:center}
.btn-primary{background:var(--orange);color:#000;border:none;padding:14px 20px;border-radius:10px;font-size:14px;font-weight:700;width:100%;max-width:320px}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border);padding:14px 20px;border-radius:10px;font-size:14px;font-weight:600;width:100%;max-width:320px;display:flex;align-items:center;justify-content:center;gap:8px; cursor:pointer;}
</style>
</head>
<body>

<div id="empty">
  <div style="font-size:48px">üìä</div>
  <div style="font-size:20px; font-weight:700; color:var(--orange)">KATKAT Analytics</div>
  <div id="empty-sub" style="font-size:13px; color:#555; max-width:300px; line-height:1.6">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
  <div style="display:flex;flex-direction:column;gap:12px;width:100%;align-items:center" id="empty-btns">
    <button class="btn-primary" id="btn-supabase" style="display:none" onclick="loadSupabase()">‚ö° ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase</button>
    <label class="btn-secondary upload-label">
      üìÇ Upload CSV Backup
      <input type="file" accept=".csv" onchange="loadCSV(event)">
    </label>
  </div>
</div>

<div id="app" style="display:none">
  <div class="header">
    <div class="header-left">
      <div class="eyebrow">KAT KAT KATSU</div>
      <h1>Analytics</h1>
      <div class="sub" id="data-source-label"></div>
    </div>
    <div class="header-right">
      <button class="icon-btn" id="btn-refresh" onclick="loadSupabase()" style="display:none">üîÑ</button>
      <label class="icon-btn upload-label">
        üìÇ
        <input type="file" accept=".csv" onchange="loadCSV(event)">
      </label>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('overview')">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
    <button class="tab" onclick="switchTab('daily')">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
    <button class="tab" onclick="switchTab('menu')">‡πÄ‡∏°‡∏ô‡∏π</button>
    <button class="tab" onclick="switchTab('channel')">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</button>
  </div>

  <div id="tab-overview" class="tab-content">
    <div class="grid-2" style="margin-top:16px">
      <div class="stat-card" style="border-top:3px solid var(--orange)">
        <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏£‡∏ß‡∏°</div>
        <div class="stat-value" id="s-revenue">‡∏ø0</div>
      </div>
      <div class="stat-card" style="border-top:3px solid var(--orange)">
        <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</div>
        <div class="stat-value" id="s-count">0</div>
      </div>
    </div>
    <div class="section-pad">
        <div class="card">
            <div class="section-title">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            <div class="chart-wrap"><canvas id="chart-trend" height="140"></canvas></div>
        </div>
    </div>
  </div>
  
  <div id="tab-daily" class="tab-content" style="display:none">
    <div class="section-pad">
      <div class="card">
        <div class="section-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
        <table>
          <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="r">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th><th class="r">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö</th></tr></thead>
          <tbody id="daily-table"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-menu" class="tab-content" style="display:none; padding:16px;">
      <div class="card"><div class="section-title">‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</div><div id="menu-list"></div></div>
  </div>
  <div id="tab-channel" class="tab-content" style="display:none; padding:16px;">
      <div class="card"><div class="section-title">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</div><canvas id="chart-pie" height="200"></canvas></div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ CONFIG (‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPABASE_URL = "https://uhruejkycwcxjhcokbfm.supabase.co"; 
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocnVlamt5Y3djeGpoY29rYmZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjE4NDUsImV4cCI6MjA4NzIzNzg0NX0.M67DwOTw2cKXHlPBJnfn7FSsRmUCv83s7J3-CkvZguc";

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allOrders = [];
let charts = {};
const fmt = n => (n||0).toLocaleString("th-TH");

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onload = () => {
  if (SUPABASE_URL && SUPABASE_KEY && !SUPABASE_URL.includes("xxxx")) {
    document.getElementById("btn-supabase").style.display = "block";
    document.getElementById("btn-refresh").style.display = "block";
  }
};

// ‚îÄ‚îÄ LOADERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadSupabase() {
  setLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
  try {
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { data, error } = await sb.from("orders").select("*").order("created_at", { ascending: false });
    if (error) throw error;
    allOrders = data.map(normalizeRow);
    showApp("supabase");
  } catch(e) { setError("Error: " + e.message); }
}

function loadCSV(e) {
  const file = e.target.files[0];
  if (!file) return;
  setLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV...");
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const rows = parseCSV(ev.target.result);
      allOrders = rows.map(normalizeRow);
      showApp("csv");
    } catch(err) { setError("‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
  };
  reader.readAsText(file, "UTF-8"); // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "windows-874" ‡∏ñ‡πâ‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
}

function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",").map(h => h.trim().replace(/"/g,""));
  return lines.slice(1).map(line => {
    const vals = line.split(",").map(v => v.trim().replace(/"/g,""));
    const obj = {};
    headers.forEach((h,i) => obj[h] = vals[i]);
    return obj;
  });
}

function normalizeRow(row) {
  return {
    time: row.created_at || row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤"] || "",
    channel: (row.channel || row["‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á"] || "pos").toLowerCase(),
    total: Number(row.total || row["‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏°‡∏ô‡∏π"] || 0),
    actual: Number(row.actual_amount || row["‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á"] || 0),
    items: row.items || row["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"] || ""
  };
}

// ‚îÄ‚îÄ UI CONTROL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showApp(source) {
  document.getElementById("empty").style.display = "none";
  document.getElementById("app").style.display = "block";
  document.getElementById("data-source-label").textContent = source.toUpperCase() + " Mode";
  renderAll();
}

function setLoading(msg) {
  document.getElementById("empty-sub").textContent = msg;
  document.getElementById("empty-btns").style.display = "none";
}

function setError(msg) {
  document.getElementById("empty-sub").innerHTML = `<span style="color:red">${msg}</span>`;
  document.getElementById("empty-btns").style.display = "flex";
}

function switchTab(id) {
  document.querySelectorAll(".tab-content").forEach(el => el.style.display = "none");
  document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
  document.getElementById("tab-" + id).style.display = "block";
  event.target.classList.add("active");
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
    const totalRevenue = allOrders.reduce((s,o) => s + o.actual, 0);
    document.getElementById("s-revenue").textContent = "‡∏ø" + fmt(totalRevenue);
    document.getElementById("s-count").textContent = allOrders.length;
    
    // Render Trend Chart
    const byDay = {};
    allOrders.forEach(o => {
        const d = o.time.split("T")[0];
        byDay[d] = (byDay[d]||0) + o.actual;
    });
    const days = Object.keys(byDay).sort().slice(-7);
    const vals = days.map(d => byDay[d]);

    if(charts.trend) charts.trend.destroy();
    charts.trend = new Chart(document.getElementById("chart-trend"), {
        type: 'line',
        data: {
            labels: days.map(d => d.split("-")[2]),
            datasets: [{ data: vals, borderColor: '#f5a623', tension: 0.4, fill: false }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
    });

    // Daily Table
    const tb = document.getElementById("daily-table");
    tb.innerHTML = Object.entries(byDay).sort((a,b)=>b[0].localeCompare(a[0])).map(([d,v]) => `
        <tr><td>${d}</td><td class="r">-</td><td class="r">‡∏ø${fmt(v)}</td></tr>
    `).join("");
}
</script>
</body>
</html>
