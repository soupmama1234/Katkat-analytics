<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>KATKAT Analytics</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&family=Inter:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#000;--surface:#121212;--border:#222;--primary:#FF9F0A;--success:#32D74B;--text:#fff;--dim:#8E8E93;
      --pos:#ffffff;--grab:#00B14F;--lineman:#00A84F;--shopee:#EE4D2D}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans Thai',sans-serif;margin:0;
      padding:env(safe-area-inset-top) 0 calc(env(safe-area-inset-bottom)+20px);user-select:none}
    .wrap{max-width:500px;margin:0 auto;padding:20px}

    /* NAV */
    .nav{display:flex;background:var(--surface);border-radius:16px;padding:4px;margin-bottom:24px;gap:4px;border:1px solid var(--border)}
    .nav-btn{flex:1;background:none;border:none;color:var(--dim);font-family:inherit;font-size:12px;font-weight:600;padding:10px 2px;border-radius:12px;cursor:pointer;transition:all .2s}
    .nav-btn.active{background:var(--primary);color:#000}

    /* HERO */
    .hero{background:linear-gradient(145deg,#1a1a1a,#0a0a0a);border:1px solid var(--border);border-radius:28px;padding:28px 24px;margin-bottom:16px;text-align:center}
    .hero-lbl{color:var(--dim);font-size:12px;text-transform:uppercase;letter-spacing:1px}
    .hero-val{font-family:'Inter',sans-serif;font-size:44px;font-weight:800;color:var(--primary);margin:8px 0;letter-spacing:-1px}
    .hero-sub{color:var(--dim);font-size:13px}
    .hero-range{display:inline-flex;align-items:center;gap:6px;background:#1a1a1a;border:1px solid #333;border-radius:20px;padding:6px 14px;margin-top:12px;font-size:12px;color:var(--dim);cursor:pointer}
    .hero-range span{color:var(--primary);font-weight:600}

    /* GRID */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
    .scard{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:18px}
    .scard-lbl{color:var(--dim);font-size:12px;margin-bottom:6px}
    .scard-val{font-family:'Inter',sans-serif;font-size:20px;font-weight:700}

    /* TOGGLE ROW */
    .trow{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
    .tbtn{background:var(--surface);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:12px;font-weight:600;padding:7px 14px;border-radius:20px;cursor:pointer;transition:all .2s;white-space:nowrap}
    .tbtn.active{background:var(--primary);color:#000;border-color:var(--primary)}
    .tbtn.active-g{background:var(--success);color:#000;border-color:var(--success)}

    /* SECTION TITLE */
    .sec{font-size:15px;font-weight:700;color:var(--dim);margin:22px 0 12px}
    .sec:first-child{margin-top:0}

    /* CHART */
    .chart-box{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:20px;margin-bottom:4px}

    /* PLATFORM BARS */
    .plist{display:flex;flex-direction:column;gap:0;background:var(--surface);border:1px solid var(--border);border-radius:24px;overflow:hidden;margin-bottom:4px}
    .pitem{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);gap:14px}
    .pitem:last-child{border-bottom:none}
    .pname{font-size:13px;font-weight:700;width:64px;flex-shrink:0}
    .pbar-w{flex:1;height:5px;background:#1a1a1a;border-radius:3px}
    .pbar{height:100%;border-radius:3px;transition:width .6s ease}
    .pright{text-align:right;flex-shrink:0}
    .pval{font-family:'Inter',sans-serif;font-size:13px;font-weight:700}
    .psub{font-size:11px;color:var(--dim);margin-top:2px}

    /* RANK LIST */
    .rlist{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:4px}
    .ritem{display:flex;align-items:center;padding:13px 18px;border-bottom:1px solid var(--border);gap:12px}
    .ritem:last-child{border-bottom:none}
    .rno{font-family:'Inter',sans-serif;font-size:12px;font-weight:800;color:#333;width:18px;text-align:center;flex-shrink:0}
    .rno.g{color:#FFD60A}.rno.s{color:#8E8E93}.rno.b{color:#CD7F32}
    .rinfo{flex:1;min-width:0}
    .rname{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rbar-w{height:3px;background:#1a1a1a;border-radius:2px;margin-top:5px}
    .rbar{height:100%;background:var(--primary);border-radius:2px}
    .rright{text-align:right;flex-shrink:0}
    .rqty{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;color:var(--primary)}
    .rrev{font-size:11px;color:var(--dim);margin-top:2px}

    /* CAT */
    .clist{display:flex;flex-direction:column;gap:8px;margin-bottom:4px}
    .ccard{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:14px 18px}
    .crow{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
    .cname{font-size:14px;font-weight:600}
    .cval{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;color:var(--success)}
    .cbar-w{height:3px;background:#1a1a1a;border-radius:2px}
    .cbar{height:100%;background:var(--success);border-radius:2px}
    .csub{font-size:11px;color:var(--dim);margin-top:5px}

    /* DAY LIST */
    .dlist{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:4px}
    .ditem{display:flex;justify-content:space-between;align-items:center;padding:13px 18px;border-bottom:1px solid var(--border)}
    .ditem:last-child{border-bottom:none}
    .ddate{font-size:13px;font-weight:500}
    .dval{font-family:'Inter',sans-serif;font-weight:700;color:var(--success);font-size:13px}

    /* TODAY */
    .tlist{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:4px}
    .titem{padding:13px 18px;border-bottom:1px solid var(--border)}
    .titem:last-child{border-bottom:none}
    .tmain{display:flex;justify-content:space-between;align-items:center}
    .tname{font-size:13px;font-weight:600}
    .tqty{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--success)}
    .tmod{font-size:11px;color:var(--dim);margin-top:4px}

    /* HOUR LIST */
    .hlist{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:4px}
    .hitem{display:flex;align-items:center;padding:11px 18px;border-bottom:1px solid var(--border);gap:12px}
    .hitem:last-child{border-bottom:none}
    .htime{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--dim);width:48px;flex-shrink:0}
    .hbar-w{flex:1;height:5px;background:#1a1a1a;border-radius:3px}
    .hbar{height:100%;background:var(--primary);border-radius:3px}
    .hright{text-align:right;flex-shrink:0}
    .horders{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--primary)}
    .hrev{font-size:11px;color:var(--dim)}

    /* HEATMAP */
    .hmwrap{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:20px;margin-bottom:4px}
    .hm-hdr{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center;margin-bottom:6px}
    .hm-hdr span{font-size:10px;color:var(--dim)}
    .hmgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
    .hmcell{aspect-ratio:1;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:10px;font-family:'Inter',sans-serif;cursor:default}
    .hm-leg{display:flex;align-items:center;gap:5px;margin-top:10px;justify-content:flex-end}
    .hm-leg span{font-size:10px;color:var(--dim)}
    .hm-dots{display:flex;gap:3px}
    .hm-dot{width:12px;height:12px;border-radius:3px}

    /* WEEKDAY BAR */
    .wdlist{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:4px}
    .wditem{display:flex;align-items:center;padding:12px 18px;border-bottom:1px solid var(--border);gap:12px}
    .wditem:last-child{border-bottom:none}
    .wdname{font-size:13px;font-weight:600;width:44px;flex-shrink:0}
    .wdbar-w{flex:1;height:5px;background:#1a1a1a;border-radius:3px}
    .wdbar{height:100%;border-radius:3px;transition:width .6s ease}
    .wdright{text-align:right;flex-shrink:0}
    .wdval{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--primary)}
    .wdsub{font-size:10px;color:var(--dim)}

    /* FAB */
    .fab{position:fixed;bottom:36px;right:20px;width:52px;height:52px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(255,159,10,.35);border:none;z-index:100;cursor:pointer}

    /* LOADER */
    #loader{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .4s}
    .spinner{width:36px;height:36px;border:4px solid #222;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .page{display:none}.page.active{display:block}
    .empty{padding:24px;text-align:center;color:var(--dim);font-size:13px}
    .badge{display:inline-block;background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:3px 10px;font-size:11px;color:var(--primary);font-weight:600;margin-left:8px}
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p style="margin-top:16px;color:var(--dim);font-size:12px;letter-spacing:2px">KATKAT ANALYTICS</p>
</div>

<div class="wrap">
  <nav class="nav">
    <button class="nav-btn active" onclick="showPage('overview',this)">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
    <button class="nav-btn" onclick="showPage('today',this)">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    <button class="nav-btn" onclick="showPage('trend',this)">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</button>
    <button class="nav-btn" onclick="showPage('peak',this)">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
  </nav>

  <!-- ‚ïê‚ïê OVERVIEW ‚ïê‚ïê -->
  <div id="page-overview" class="page active">
    <!-- period filter -->
    <div class="trow" style="margin-bottom:16px">
      <button class="tbtn active" onclick="setOverviewPeriod('all',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="tbtn" onclick="setOverviewPeriod('today',this)">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
      <button class="tbtn" onclick="setOverviewPeriod('7d',this)">7 ‡∏ß‡∏±‡∏ô</button>
      <button class="tbtn" onclick="setOverviewPeriod('30d',this)">30 ‡∏ß‡∏±‡∏ô</button>
    </div>

    <div class="hero">
      <div class="hero-lbl">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</div>
      <div class="hero-val" id="ov-rev">‡∏ø0</div>
      <div class="hero-sub" id="ov-cnt">0 ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
      <div class="hero-range" id="ov-range">üìÖ <span id="ov-range-lbl">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></div>
    </div>

    <div class="grid2">
      <div class="scard"><div class="scard-lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="ov-avg">‡∏ø0</div></div>
      <div class="scard"><div class="scard-lbl">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div><div class="scard-val" id="ov-today">‡∏ø0</div></div>
    </div>

    <div class="sec">üì° Platform</div>
    <div class="plist" id="ov-platform"></div>

    <div class="sec">üèÜ ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ Top 10</div>
    <div class="rlist" id="ov-menu"></div>

    <div class="sec">üìÇ ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
    <div class="clist" id="ov-cat"></div>

    <div class="sec">üìÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
    <div class="dlist" id="ov-daily"></div>
  </div>

  <!-- ‚ïê‚ïê TODAY ‚ïê‚ïê -->
  <div id="page-today" class="page">
    <div class="hero">
      <div class="hero-lbl">‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="hero-val" id="td-rev">‡∏ø0</div>
      <div class="hero-sub" id="td-cnt">0 ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
    </div>
    <div class="grid2">
      <div class="scard"><div class="scard-lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="td-avg">‡∏ø0</div></div>
      <div class="scard"><div class="scard-lbl">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="scard-val" id="td-items">0 ‡∏ä‡∏¥‡πâ‡∏ô</div></div>
    </div>
    <div class="sec" style="margin-top:0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
    <div class="tlist" id="td-list"></div>
  </div>

  <!-- ‚ïê‚ïê TREND ‚ïê‚ïê -->
  <div id="page-trend" class="page">
    <div class="sec" style="margin-top:0">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
    <div class="trow">
      <button class="tbtn active" onclick="setTrendPeriod('7d',this)">7 ‡∏ß‡∏±‡∏ô</button>
      <button class="tbtn" onclick="setTrendPeriod('30d',this)">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
      <button class="tbtn" onclick="setTrendPeriod('1y',this)">1 ‡∏õ‡∏µ</button>
    </div>
    <div class="chart-box" style="height:220px"><canvas id="trend-chart"></canvas></div>
    <div class="dlist" id="trend-table" style="margin-top:14px;margin-bottom:0"></div>

    <div class="sec">üì° Platform ‡πÅ‡∏¢‡∏Å‡∏ä‡πà‡∏ß‡∏á</div>
    <div class="plist" id="trend-platform"></div>

    <div class="sec">üìÖ ‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏™‡∏∏‡∏î (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</div>
    <div class="wdlist" id="trend-weekday"></div>

    <div class="sec">üóì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
    <div class="hmwrap">
      <div class="hm-hdr"><span>‡∏à</span><span>‡∏≠</span><span>‡∏û</span><span>‡∏û‡∏§</span><span>‡∏®</span><span>‡∏™</span><span>‡∏≠‡∏≤</span></div>
      <div class="hmgrid" id="heatmap"></div>
      <div class="hm-leg">
        <span>‡∏ô‡πâ‡∏≠‡∏¢</span>
        <div class="hm-dots">
          <div class="hm-dot" style="background:#1a1a1a"></div>
          <div class="hm-dot" style="background:rgba(255,159,10,.25)"></div>
          <div class="hm-dot" style="background:rgba(255,159,10,.5)"></div>
          <div class="hm-dot" style="background:rgba(255,159,10,.75)"></div>
          <div class="hm-dot" style="background:#FF9F0A"></div>
        </div>
        <span>‡∏°‡∏≤‡∏Å</span>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê PEAK ‚ïê‚ïê -->
  <div id="page-peak" class="page">
    <div class="sec" style="margin-top:0">‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</div>
    <!-- filter scope -->
    <div class="trow">
      <button class="tbtn active" onclick="setPeakScope('all',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="tbtn" onclick="setPeakScope('today',this)">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
      <button class="tbtn" onclick="setPeakScope('week',this)">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</button>
      <button class="tbtn" onclick="setPeakScope('month',this)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
    <div class="chart-box" style="height:200px"><canvas id="peak-chart"></canvas></div>
    <div class="sec">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
    <div class="hlist" id="peak-list"></div>

    <div class="sec">üìÜ ‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</div>
    <div class="chart-box" style="height:180px"><canvas id="weekday-chart"></canvas></div>
    <div class="wdlist" id="peak-weekday"></div>
  </div>
</div>

<button class="fab" onclick="init()">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
  </svg>
</button>

<script>
const SB_URL="https://uhruejkycwcxjhcokbfm.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocnVlamt5Y3djeGpoY29rYmZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjE4NDUsImV4cCI6MjA4NzIzNzg0NX0.M67DwOTw2cKXHlPBJnfn7FSsRmUCv83s7J3-CkvZguc";
const sb=supabase.createClient(SB_URL,SB_KEY);

let allOrders=[],catMap={};
let ovPeriod='all',trendPeriod='7d',peakScope='all';
let trendChart=null,peakChart=null,wdChart=null;

const fmt=n=>(n||0).toLocaleString('th-TH');
const todayStr=new Date().toLocaleDateString('en-CA');
const CH_COLOR={pos:'#ffffff',grab:'#00B14F',lineman:'#00A84F',shopee:'#EE4D2D'};

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init(){
  loader(true);
  try{
    const[oR,pR]=await Promise.all([
      sb.from('orders').select('*').order('created_at',{ascending:false}),
      sb.from('products').select('id,name,category')
    ]);
    if(oR.error) throw oR.error;
    catMap={};
    (pR.data||[]).forEach(p=>{catMap[p.name]=p.category||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';});
    allOrders=oR.data||[];
    renderAll();
  }catch(e){alert('Error: '+e.message);}
  finally{loader(false);}
}

function loader(show){
  const el=document.getElementById('loader');
  if(show){el.style.opacity=1;el.style.display='flex';}
  else{setTimeout(()=>{el.style.opacity=0;setTimeout(()=>el.style.display='none',400);},500);}
}

// ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  btn.classList.add('active');
}

// ‚îÄ‚îÄ FILTER HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterByPeriod(orders,period){
  const now=new Date();
  if(period==='today') return orders.filter(r=>(r.created_at||'').startsWith(todayStr));
  if(period==='7d'){
    const d=new Date(now); d.setDate(d.getDate()-7);
    return orders.filter(r=>new Date(r.created_at)>=d);
  }
  if(period==='30d'){
    const d=new Date(now); d.setDate(d.getDate()-30);
    return orders.filter(r=>new Date(r.created_at)>=d);
  }
  if(period==='week'){
    // ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‚Äì‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
    const d=new Date(now);
    const day=d.getDay(); const diff=day===0?-6:1-day;
    d.setDate(d.getDate()+diff); d.setHours(0,0,0,0);
    return orders.filter(r=>new Date(r.created_at)>=d);
  }
  if(period==='month'){
    const d=new Date(now.getFullYear(),now.getMonth(),1);
    return orders.filter(r=>new Date(r.created_at)>=d);
  }
  return orders; // all
}

function periodLabel(p){
  if(p==='today') return '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
  if(p==='7d') return '7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
  if(p==='30d') return '30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
  if(p==='week') return '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ';
  if(p==='month') return '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ';
  return '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
}

// ‚îÄ‚îÄ COMPUTE FROM ORDERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeFrom(orders){
  const dailyMap={},menuCount={},menuRev={},catRev={},catCnt={},platformRev={},platformCnt={};
  const byHour=Array.from({length:24},(_,i)=>({hour:i,orders:0,revenue:0}));
  const byWeekday=Array(7).fill(null).map(()=>({rev:0,cnt:0}));

  orders.forEach(r=>{
    const actual=r.actual_amount||0;
    const date=(r.created_at||'').split('T')[0];
    if(date) dailyMap[date]=(dailyMap[date]||0)+actual;

    // platform
    const ch=(r.channel||'pos').toLowerCase();
    platformRev[ch]=(platformRev[ch]||0)+actual;
    platformCnt[ch]=(platformCnt[ch]||0)+1;

    if(r.created_at){
      const d=new Date(r.created_at);
      const h=d.getHours();
      byHour[h].orders++; byHour[h].revenue+=actual;
      const wd=d.getDay(); const idx=wd===0?6:wd-1;
      byWeekday[idx].rev+=actual; byWeekday[idx].cnt++;
    }

    let items=r.items;
    if(!items) return;
    if(typeof items==='string'){try{items=JSON.parse(items);}catch{return;}}
    if(!Array.isArray(items)) return;

    items.forEach(item=>{
      const n=item.name||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const q=Number(item.qty||item.quantity||1);
      const p=Number(item.price||0);
      const cat=catMap[n]||item.category||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
      menuCount[n]=(menuCount[n]||0)+q;
      menuRev[n]=(menuRev[n]||0)+(p*q);
      catRev[cat]=(catRev[cat]||0)+(p*q);
      catCnt[cat]=(catCnt[cat]||0)+q;
    });
  });

  return{dailyMap,menuCount,menuRev,catRev,catCnt,platformRev,platformCnt,byHour,byWeekday};
}

// ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll(){
  renderOverview();
  renderToday();
  renderTrend();
  renderPeak();
}

// ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setOverviewPeriod(p,btn){
  ovPeriod=p;
  document.querySelectorAll('#page-overview .tbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderOverview();
}

function renderOverview(){
  const orders=filterByPeriod(allOrders,ovPeriod);
  const s=computeFrom(orders);
  const total=orders.reduce((sum,r)=>sum+(r.actual_amount||0),0);
  const cnt=orders.length;

  document.getElementById('ov-rev').innerText='‡∏ø'+fmt(total);
  document.getElementById('ov-cnt').innerText=fmt(cnt)+' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
  document.getElementById('ov-avg').innerText='‡∏ø'+fmt(Math.round(cnt?total/cnt:0));
  document.getElementById('ov-today').innerText='‡∏ø'+fmt(s.dailyMap[todayStr]||0);
  document.getElementById('ov-range-lbl').innerText=periodLabel(ovPeriod);

  // platform
  renderPlatformBars('ov-platform',s.platformRev,s.platformCnt,total);

  // ‡πÄ‡∏°‡∏ô‡∏π
  const top=Object.entries(s.menuCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const maxQ=top[0]?.[1]||1;
  document.getElementById('ov-menu').innerHTML=top.length
    ?top.map(([n,q],i)=>rankRow(i,n,q,s.menuRev[n]||0,maxQ)).join('')
    :'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';

  // ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
  const cats=Object.entries(s.catRev).sort((a,b)=>b[1]-a[1]);
  const maxC=cats[0]?.[1]||1;
  document.getElementById('ov-cat').innerHTML=cats.length
    ?cats.map(([c,r])=>`
        <div class="ccard">
          <div class="crow"><span class="cname">${c}</span><span class="cval">‡∏ø${fmt(r)}</span></div>
          <div class="cbar-w"><div class="cbar" style="width:${Math.round(r/maxC*100)}%"></div></div>
          <div class="csub">${s.catCnt[c]} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>`).join('')
    :'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';

  // ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
  document.getElementById('ov-daily').innerHTML=Object.entries(s.dailyMap)
    .sort((a,b)=>b[0].localeCompare(a[0])).slice(0,14)
    .map(([d,v])=>`
      <div class="ditem">
        <span class="ddate">${new Date(d).toLocaleDateString('th-TH',{weekday:'short',day:'numeric',month:'short'})}</span>
        <span class="dval">‡∏ø${fmt(v)}</span>
      </div>`).join('');
}

// ‚îÄ‚îÄ PLATFORM BARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPlatformBars(elId,platformRev,platformCnt,totalRev){
  const order=['pos','grab','lineman','shopee'];
  const label={pos:'POS',grab:'Grab',lineman:'Lineman',shopee:'Shopee'};
  const maxRev=Math.max(...Object.values(platformRev),1);
  const html=order.filter(k=>platformRev[k]>0).map(k=>{
    const color=CH_COLOR[k]||'#888';
    const pct=Math.round((platformRev[k]/maxRev)*100);
    const share=totalRev>0?Math.round((platformRev[k]/totalRev)*100):0;
    return`<div class="pitem">
      <div class="pname" style="color:${color}">${label[k]}</div>
      <div class="pbar-w"><div class="pbar" style="width:${pct}%;background:${color}"></div></div>
      <div class="pright">
        <div class="pval" style="color:${color}">‡∏ø${fmt(platformRev[k])}</div>
        <div class="psub">${platformCnt[k]} ‡∏ö‡∏¥‡∏• ¬∑ ${share}%</div>
      </div>
    </div>`;
  }).join('');
  document.getElementById(elId).innerHTML=html||'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
}

// ‚îÄ‚îÄ TODAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderToday(){
  const orders=filterByPeriod(allOrders,'today');
  const rev=orders.reduce((s,r)=>s+(r.actual_amount||0),0);
  const cnt=orders.length;
  const menuT={};let totalItems=0;

  orders.forEach(r=>{
    let items=r.items;
    if(!items) return;
    if(typeof items==='string'){try{items=JSON.parse(items);}catch{return;}}
    if(!Array.isArray(items)) return;
    items.forEach(item=>{
      const n=item.name||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const q=Number(item.qty||item.quantity||1);
      totalItems+=q;
      if(!menuT[n]) menuT[n]={qty:0,mods:{}};
      menuT[n].qty+=q;
      if(item.selectedModifier?.name){
        const m=item.selectedModifier.name;
        menuT[n].mods[m]=(menuT[n].mods[m]||0)+q;
      }
    });
  });

  document.getElementById('td-rev').innerText='‡∏ø'+fmt(rev);
  document.getElementById('td-cnt').innerText=fmt(cnt)+' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
  document.getElementById('td-avg').innerText='‡∏ø'+fmt(Math.round(cnt?rev/cnt:0));
  document.getElementById('td-items').innerText=fmt(totalItems)+' ‡∏ä‡∏¥‡πâ‡∏ô';

  const sorted=Object.entries(menuT).sort((a,b)=>b[1].qty-a[1].qty);
  document.getElementById('td-list').innerHTML=sorted.length
    ?sorted.map(([n,d])=>{
        const mods=Object.entries(d.mods).map(([m,q])=>`‚öôÔ∏è ${m} √ó${q}`).join('  ');
        return`<div class="titem">
          <div class="tmain"><span class="tname">${n}</span><span class="tqty">√ó${d.qty}</span></div>
          ${mods?`<div class="tmod">${mods}</div>`:''}
        </div>`;
      }).join('')
    :'<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
}

// ‚îÄ‚îÄ TREND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTrendPeriod(p,btn){
  trendPeriod=p;
  document.querySelectorAll('#page-trend .tbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderTrend();
}

function renderTrend(){
  const orders=filterByPeriod(allOrders,trendPeriod==='7d'?'7d':trendPeriod==='30d'?'30d':'all');
  const s=computeFrom(orders);
  const sorted=Object.keys(s.dailyMap).sort();
  let labels,values,tableRows;

  if(trendPeriod==='1y'){
    const monthly={};
    sorted.forEach(d=>{const k=d.slice(0,7);monthly[k]=(monthly[k]||0)+s.dailyMap[d];});
    const mKeys=Object.keys(monthly).sort().slice(-12);
    labels=mKeys.map(k=>{const[y,m]=k.split('-');return new Date(+y,+m-1).toLocaleDateString('th-TH',{month:'short',year:'2-digit'});});
    values=mKeys.map(k=>monthly[k]);
    tableRows=mKeys.slice().reverse().map(k=>{
      const[y,m]=k.split('-');
      return{label:new Date(+y,+m-1).toLocaleDateString('th-TH',{month:'long',year:'numeric'}),val:monthly[k]};
    });
  }else{
    const n=trendPeriod==='7d'?7:30;
    const sl=sorted.slice(-n);
    labels=sl.map(d=>d.split('-')[2]);
    values=sl.map(d=>s.dailyMap[d]);
    tableRows=sl.slice().reverse().map(d=>({
      label:new Date(d).toLocaleDateString('th-TH',{weekday:'short',day:'numeric',month:'short'}),
      val:s.dailyMap[d]
    }));
  }

  // chart
  if(trendChart) trendChart.destroy();
  const ctx=document.getElementById('trend-chart').getContext('2d');
  trendChart=new Chart(ctx,{
    type:'line',
    data:{labels,datasets:[{data:values,borderColor:'#FF9F0A',borderWidth:3,tension:0.4,fill:true,
      backgroundColor:'rgba(255,159,10,0.07)',pointRadius:2,pointBackgroundColor:'#FF9F0A'}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{grid:{display:false},ticks:{color:'#555',font:{size:11}}},y:{display:false}}}
  });

  document.getElementById('trend-table').innerHTML=tableRows
    .map(r=>`<div class="ditem"><span class="ddate">${r.label}</span><span class="dval">‡∏ø${fmt(r.val)}</span></div>`).join('');

  // platform
  const total=orders.reduce((sum,r)=>sum+(r.actual_amount||0),0);
  renderPlatformBars('trend-platform',s.platformRev,s.platformCnt,total);

  // weekday
  renderWeekdayBars('trend-weekday',s.byWeekday);

  // heatmap ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏°‡∏≠)
  const sAll=computeFrom(allOrders);
  renderHeatmap(sAll.dailyMap);
}

// ‚îÄ‚îÄ PEAK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setPeakScope(p,btn){
  peakScope=p;
  document.querySelectorAll('#page-peak .tbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderPeak();
}

function renderPeak(){
  const scopeMap={all:'all',today:'today',week:'week',month:'month'};
  const orders=filterByPeriod(allOrders,scopeMap[peakScope]||'all');
  const s=computeFrom(orders);
  const active=s.byHour.filter(h=>h.orders>0);
  const maxO=Math.max(...active.map(h=>h.orders),1);

  // hour chart
  if(peakChart) peakChart.destroy();
  const ctx1=document.getElementById('peak-chart').getContext('2d');
  peakChart=new Chart(ctx1,{
    type:'bar',
    data:{
      labels:s.byHour.map(h=>h.hour+':00'),
      datasets:[{
        data:s.byHour.map(h=>h.orders),
        backgroundColor:s.byHour.map(h=>h.orders>0&&h.orders===maxO?'#FF9F0A':'rgba(255,159,10,.2)'),
        borderRadius:5,borderSkipped:false
      }]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{grid:{display:false},ticks:{color:'#555',font:{size:9},maxRotation:0}},y:{display:false}}}
  });

  // hour list
  document.getElementById('peak-list').innerHTML=[...active].sort((a,b)=>b.orders-a.orders)
    .map(h=>`
      <div class="hitem">
        <div class="htime">${String(h.hour).padStart(2,'0')}:00</div>
        <div class="hbar-w"><div class="hbar" style="width:${Math.round(h.orders/maxO*100)}%"></div></div>
        <div class="hright">
          <div class="horders">${h.orders} ‡∏ö‡∏¥‡∏•</div>
          <div class="hrev">‡∏ø${fmt(h.revenue)}</div>
        </div>
      </div>`).join('');

  // weekday chart
  const dayNames=['‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™','‡∏≠‡∏≤'];
  const dayFull=['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå','‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'];
  const avgs=s.byWeekday.map(d=>d.cnt?Math.round(d.rev/d.cnt):0);
  const maxA=Math.max(...avgs,1);

  if(wdChart) wdChart.destroy();
  const ctx2=document.getElementById('weekday-chart').getContext('2d');
  wdChart=new Chart(ctx2,{
    type:'bar',
    data:{
      labels:dayNames,
      datasets:[{
        data:avgs,
        backgroundColor:avgs.map(v=>v===maxA?'#32D74B':'rgba(50,215,75,.2)'),
        borderRadius:6,borderSkipped:false
      }]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{grid:{display:false},ticks:{color:'#555',font:{size:11}}},y:{display:false}}}
  });

  renderWeekdayBars('peak-weekday',s.byWeekday);
}

// ‚îÄ‚îÄ WEEKDAY BARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderWeekdayBars(elId,byWeekday){
  const dayNames=['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå','‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'];
  const avgs=byWeekday.map(d=>d.cnt?Math.round(d.rev/d.cnt):0);
  const maxA=Math.max(...avgs,1);
  document.getElementById(elId).innerHTML=avgs.map((a,i)=>`
    <div class="wditem">
      <div class="wdname">${dayNames[i]}</div>
      <div class="wdbar-w"><div class="wdbar" style="width:${Math.round(a/maxA*100)}%;background:var(--primary)"></div></div>
      <div class="wdright">
        <div class="wdval">‡∏ø${fmt(a)}</div>
        <div class="wdsub">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ¬∑ ${byWeekday[i].cnt} ‡∏ß‡∏±‡∏ô</div>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ HEATMAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHeatmap(dailyMap){
  const now=new Date();
  const y=now.getFullYear(),mo=now.getMonth();
  const daysInMonth=new Date(y,mo+1,0).getDate();
  const firstDow=new Date(y,mo,1).getDay();
  const offset=firstDow===0?6:firstDow-1;
  let maxD=0;
  for(let d=1;d<=daysInMonth;d++){
    const k=`${y}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    maxD=Math.max(maxD,dailyMap[k]||0);
  }
  let html='';
  for(let i=0;i<offset;i++) html+='<div></div>';
  for(let d=1;d<=daysInMonth;d++){
    const k=`${y}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const v=dailyMap[k]||0;
    const isToday=k===todayStr;
    const p=maxD>0?v/maxD:0;
    const bg=p>0.75?'#FF9F0A':p>0.5?'rgba(255,159,10,.75)':p>0.25?'rgba(255,159,10,.5)':p>0?'rgba(255,159,10,.25)':'#1a1a1a';
    const tc=p>0.5?'#000':'#555';
    html+=`<div class="hmcell" style="background:${bg};color:${tc};font-weight:${isToday?700:400};outline:${isToday?'2px solid #FF9F0A':'none'};outline-offset:-1px">${d}</div>`;
  }
  document.getElementById('heatmap').innerHTML=html;
}

// ‚îÄ‚îÄ RANK ROW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rankRow(i,name,qty,rev,maxQ){
  const cls=i===0?'g':i===1?'s':i===2?'b':'';
  return`<div class="ritem">
    <div class="rno ${cls}">${i+1}</div>
    <div class="rinfo">
      <div class="rname">${name}</div>
      <div class="rbar-w"><div class="rbar" style="width:${Math.round(qty/maxQ*100)}%"></div></div>
    </div>
    <div class="rright">
      <div class="rqty">${qty} ‡∏ä‡∏¥‡πâ‡∏ô</div>
      <div class="rrev">‡∏ø${fmt(rev)}</div>
    </div>
  </div>`;
}

init();
</script>
</body>
</html>
