<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>KATKAT Analytics</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&family=Inter:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#000;--surface:#121212;--border:#222;--primary:#FF9F0A;--success:#32D74B;--text:#fff;--dim:#8E8E93}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans Thai',sans-serif;margin:0;padding:env(safe-area-inset-top) 0 calc(env(safe-area-inset-bottom) + 20px);user-select:none}
    .wrap{max-width:500px;margin:0 auto;padding:20px}

    /* NAV */
    .nav{display:flex;background:var(--surface);border-radius:16px;padding:4px;margin-bottom:24px;gap:4px;border:1px solid var(--border)}
    .nav-btn{flex:1;background:none;border:none;color:var(--dim);font-family:inherit;font-size:12px;font-weight:600;padding:10px 2px;border-radius:12px;cursor:pointer;transition:all .2s}
    .nav-btn.active{background:var(--primary);color:#000}

    /* HERO */
    .hero{background:linear-gradient(145deg,#1a1a1a,#0a0a0a);border:1px solid var(--border);border-radius:28px;padding:28px 24px;margin-bottom:20px;text-align:center}
    .hero-lbl{color:var(--dim);font-size:12px;text-transform:uppercase;letter-spacing:1px}
    .hero-val{font-family:'Inter',sans-serif;font-size:44px;font-weight:800;color:var(--primary);margin:8px 0;letter-spacing:-1px}
    .hero-sub{color:var(--dim);font-size:13px}

    /* GRID */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
    .scard{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:18px}
    .scard-lbl{color:var(--dim);font-size:12px;margin-bottom:6px}
    .scard-val{font-family:'Inter',sans-serif;font-size:20px;font-weight:700}

    /* SECTION TITLE */
    .sec{font-size:15px;font-weight:700;color:var(--dim);margin:24px 0 12px}

    /* PERIOD TOGGLE */
    .periods{display:flex;gap:8px;margin-bottom:16px}
    .pbtn{background:var(--surface);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:13px;font-weight:600;padding:8px 18px;border-radius:20px;cursor:pointer;transition:all .2s}
    .pbtn.active{background:var(--primary);color:#000;border-color:var(--primary)}

    /* CHART */
    .chart-box{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:20px;height:220px;margin-bottom:4px}

    /* RANK LIST */
    .rlist{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:4px}
    .ritem{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);gap:12px}
    .ritem:last-child{border-bottom:none}
    .rno{font-family:'Inter',sans-serif;font-size:12px;font-weight:800;color:#333;width:18px;text-align:center;flex-shrink:0}
    .rno.g{color:#FFD60A}.rno.s{color:#8E8E93}.rno.b{color:#CD7F32}
    .rinfo{flex:1;min-width:0}
    .rname{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rsub{font-size:11px;color:var(--dim);margin-top:2px}
    .rbar-w{height:3px;background:#1a1a1a;border-radius:2px;margin-top:5px}
    .rbar{height:100%;background:var(--primary);border-radius:2px}
    .rright{text-align:right;flex-shrink:0}
    .rqty{font-family:'Inter',sans-serif;font-size:15px;font-weight:700;color:var(--primary)}
    .rrev{font-size:11px;color:var(--dim);margin-top:2px}

    /* CAT */
    .clist{display:flex;flex-direction:column;gap:10px;margin-bottom:4px}
    .ccard{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px 18px}
    .crow{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
    .cname{font-size:15px;font-weight:600}
    .cval{font-family:'Inter',sans-serif;font-size:15px;font-weight:700;color:var(--success)}
    .cbar-w{height:3px;background:#1a1a1a;border-radius:2px}
    .cbar{height:100%;background:var(--success);border-radius:2px}
    .csub{font-size:12px;color:var(--dim);margin-top:5px}

    /* DAY LIST */
    .dlist{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:4px}
    .ditem{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;border-bottom:1px solid var(--border)}
    .ditem:last-child{border-bottom:none}
    .ddate{font-weight:500;font-size:14px}
    .dval{font-family:'Inter',sans-serif;font-weight:700;color:var(--success);font-size:14px}

    /* TODAY */
    .tlist{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:4px}
    .titem{padding:14px 18px;border-bottom:1px solid var(--border)}
    .titem:last-child{border-bottom:none}
    .tmain{display:flex;justify-content:space-between;align-items:center}
    .tname{font-size:14px;font-weight:600}
    .tqty{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;color:var(--success)}
    .tmod{font-size:11px;color:var(--dim);margin-top:4px}

    /* HOUR LIST */
    .hlist{background:var(--surface);border-radius:24px;border:1px solid var(--border);overflow:hidden;margin-bottom:4px}
    .hitem{display:flex;align-items:center;padding:12px 18px;border-bottom:1px solid var(--border);gap:12px}
    .hitem:last-child{border-bottom:none}
    .htime{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--dim);width:48px;flex-shrink:0}
    .hbar-w{flex:1;height:5px;background:#1a1a1a;border-radius:3px}
    .hbar{height:100%;background:var(--primary);border-radius:3px}
    .hright{text-align:right;flex-shrink:0}
    .horders{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--primary)}
    .hrev{font-size:11px;color:var(--dim)}

    /* HEATMAP */
    .hmwrap{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:20px;margin-bottom:4px}
    .hm-day-labels{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;text-align:center;margin-bottom:8px}
    .hm-day-labels span{font-size:10px;color:var(--dim)}
    .hmgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
    .hmcell{aspect-ratio:1;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:10px;font-family:'Inter',sans-serif;cursor:default}
    .hm-legend{display:flex;align-items:center;gap:6px;margin-top:12px;justify-content:flex-end}
    .hm-legend span{font-size:10px;color:var(--dim)}
    .hm-legend-dots{display:flex;gap:3px}
    .hm-legend-dot{width:12px;height:12px;border-radius:3px}

    /* WEEKDAY */
    .wditem{display:flex;align-items:center;padding:12px 18px;border-bottom:1px solid var(--border);gap:12px}
    .wditem:last-child{border-bottom:none}
    .wdname{font-size:13px;font-weight:600;width:44px;flex-shrink:0}
    .wdbar-w{flex:1;height:5px;background:#1a1a1a;border-radius:3px}
    .wdbar{height:100%;background:var(--primary);border-radius:3px}
    .wdright{text-align:right;flex-shrink:0}
    .wdval{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--primary)}
    .wdsub{font-size:10px;color:var(--dim)}

    /* FAB */
    .fab{position:fixed;bottom:40px;right:24px;width:54px;height:54px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(255,159,10,.35);border:none;z-index:100;cursor:pointer}

    /* LOADER */
    #loader{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .4s}
    .spinner{width:36px;height:36px;border:4px solid #222;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .page{display:none}.page.active{display:block}
    .empty{padding:28px;text-align:center;color:var(--dim);font-size:13px}
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p style="margin-top:16px;color:var(--dim);font-size:13px;letter-spacing:1px">KATKAT ANALYTICS</p>
</div>

<div class="wrap">
  <nav class="nav">
    <button class="nav-btn active" onclick="showPage('overview',this)">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
    <button class="nav-btn" onclick="showPage('today',this)">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    <button class="nav-btn" onclick="showPage('trend',this)">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</button>
    <button class="nav-btn" onclick="showPage('peak',this)">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
  </nav>

  <!-- OVERVIEW -->
  <div id="page-overview" class="page active">
    <div class="hero">
      <div class="hero-lbl">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div class="hero-val" id="ov-rev">‡∏ø0</div>
      <div class="hero-sub" id="ov-cnt">0 ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
    </div>
    <div class="grid2">
      <div class="scard"><div class="scard-lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="ov-avg">‡∏ø0</div></div>
      <div class="scard"><div class="scard-lbl">‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div><div class="scard-val" id="ov-today">‡∏ø0</div></div>
    </div>
    <div class="sec">üèÜ ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ Top 10</div>
    <div class="rlist" id="ov-menu"></div>
    <div class="sec">üìÇ ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
    <div class="clist" id="ov-cat"></div>
    <div class="sec">üìÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
    <div class="dlist" id="ov-daily"></div>
  </div>

  <!-- TODAY -->
  <div id="page-today" class="page">
    <div class="hero">
      <div class="hero-lbl">‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="hero-val" id="td-rev">‡∏ø0</div>
      <div class="hero-sub" id="td-cnt">0 ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
    </div>
    <div class="grid2">
      <div class="scard"><div class="scard-lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div class="scard-val" id="td-avg">‡∏ø0</div></div>
      <div class="scard"><div class="scard-lbl">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="scard-val" id="td-items">0 ‡∏ä‡∏¥‡πâ‡∏ô</div></div>
    </div>
    <div class="sec" style="margin-top:0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
    <div class="tlist" id="td-list"></div>
  </div>

  <!-- TREND -->
  <div id="page-trend" class="page">
    <div class="sec" style="margin-top:0">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
    <div class="periods">
      <button class="pbtn active" onclick="setPeriod('7d',this)">7 ‡∏ß‡∏±‡∏ô</button>
      <button class="pbtn" onclick="setPeriod('30d',this)">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
      <button class="pbtn" onclick="setPeriod('1y',this)">1 ‡∏õ‡∏µ</button>
    </div>
    <div class="chart-box"><canvas id="trend-chart"></canvas></div>
    <div class="dlist" id="trend-table" style="margin-top:16px;margin-bottom:0"></div>

    <div class="sec">üìÖ ‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏™‡∏∏‡∏î (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)</div>
    <div class="rlist" id="weekday-list"></div>

    <div class="sec">üóì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
    <div class="hmwrap">
      <div class="hm-day-labels">
        <span>‡∏à</span><span>‡∏≠</span><span>‡∏û</span><span>‡∏û‡∏§</span><span>‡∏®</span><span>‡∏™</span><span>‡∏≠‡∏≤</span>
      </div>
      <div class="hmgrid" id="heatmap"></div>
      <div class="hm-legend">
        <span>‡∏ô‡πâ‡∏≠‡∏¢</span>
        <div class="hm-legend-dots">
          <div class="hm-legend-dot" style="background:#1a1a1a"></div>
          <div class="hm-legend-dot" style="background:rgba(255,159,10,.25)"></div>
          <div class="hm-legend-dot" style="background:rgba(255,159,10,.5)"></div>
          <div class="hm-legend-dot" style="background:rgba(255,159,10,.75)"></div>
          <div class="hm-legend-dot" style="background:#FF9F0A"></div>
        </div>
        <span>‡∏°‡∏≤‡∏Å</span>
      </div>
    </div>
  </div>

  <!-- PEAK -->
  <div id="page-peak" class="page">
    <div class="sec" style="margin-top:0">‚è∞ ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</div>
    <div class="chart-box"><canvas id="peak-chart"></canvas></div>
    <div class="sec">üìÜ ‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</div>
    <div class="chart-box" style="height:200px"><canvas id="weekday-chart"></canvas></div>
    <div class="sec">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
    <div class="hlist" id="peak-list"></div>
  </div>
</div>

<button class="fab" onclick="init()">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
  </svg>
</button>

<script>
const SB_URL = "https://uhruejkycwcxjhcokbfm.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocnVlamt5Y3djeGpoY29rYmZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjE4NDUsImV4cCI6MjA4NzIzNzg0NX0.M67DwOTw2cKXHlPBJnfn7FSsRmUCv83s7J3-CkvZguc";
const sb = supabase.createClient(SB_URL, SB_KEY);

let allOrders = [], catMap = {}, currentPeriod = '7d';
let trendChart = null, peakChart = null, weekdayChart = null;
const fmt = n => (n||0).toLocaleString('th-TH');
const todayStr = new Date().toLocaleDateString('en-CA');

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  loader(true);
  try {
    const [oRes, pRes] = await Promise.all([
      sb.from('orders').select('*').order('created_at', {ascending:false}),
      sb.from('products').select('id,name,category')
    ]);
    if (oRes.error) throw oRes.error;
    catMap = {};
    (pRes.data||[]).forEach(p => { catMap[p.name] = p.category||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; });
    allOrders = oRes.data||[];
    renderAll();
  } catch(e) { alert('Error: '+e.message); }
  finally { loader(false); }
}

function loader(show) {
  const el = document.getElementById('loader');
  if (show) { el.style.opacity=1; el.style.display='flex'; }
  else { setTimeout(()=>{ el.style.opacity=0; setTimeout(()=>el.style.display='none',400); },500); }
}

// ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  btn.classList.add('active');
}

// ‚îÄ‚îÄ COMPUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function compute() {
  const dailyMap={}, menuCount={}, menuRev={}, catRev={}, catCnt={};
  const byHour = Array.from({length:24},(_,i)=>({hour:i,orders:0,revenue:0}));
  const byWeekday = Array(7).fill(null).map(()=>({rev:0,cnt:0})); // 0=‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå
  const todayOrders=[];

  allOrders.forEach(r => {
    const actual = r.actual_amount||0;
    const date = (r.created_at||'').split('T')[0];
    if (date) dailyMap[date] = (dailyMap[date]||0) + actual;
    if (date === todayStr) todayOrders.push(r);

    if (r.created_at) {
      const d = new Date(r.created_at);
      byHour[d.getHours()].orders++;
      byHour[d.getHours()].revenue += actual;
      const wd = d.getDay(); // 0=‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
      const idx = wd===0 ? 6 : wd-1;
      byWeekday[idx].rev += actual;
      byWeekday[idx].cnt++;
    }

    let items = r.items;
    if (!items) return;
    if (typeof items==='string') { try{items=JSON.parse(items);}catch{return;} }
    if (!Array.isArray(items)) return;

    items.forEach(item => {
      const name = item.name||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const qty = Number(item.qty||item.quantity||1);
      const price = Number(item.price||0);
      const cat = catMap[name]||item.category||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
      menuCount[name] = (menuCount[name]||0)+qty;
      menuRev[name] = (menuRev[name]||0)+(price*qty);
      catRev[cat] = (catRev[cat]||0)+(price*qty);
      catCnt[cat] = (catCnt[cat]||0)+qty;
    });
  });

  return {dailyMap,menuCount,menuRev,catRev,catCnt,byHour,byWeekday,todayOrders};
}

// ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
  const s = compute();
  renderOverview(s);
  renderToday(s.todayOrders);
  renderTrend(s.dailyMap, s.byWeekday);
  renderPeak(s.byHour, s.byWeekday);
}

// ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOverview({dailyMap,menuCount,menuRev,catRev,catCnt}) {
  const total = allOrders.reduce((s,r)=>s+(r.actual_amount||0),0);
  const cnt = allOrders.length;
  document.getElementById('ov-rev').innerText = '‡∏ø'+fmt(total);
  document.getElementById('ov-cnt').innerText = fmt(cnt)+' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
  document.getElementById('ov-avg').innerText = '‡∏ø'+fmt(Math.round(cnt?total/cnt:0));
  document.getElementById('ov-today').innerText = '‡∏ø'+fmt(dailyMap[todayStr]||0);

  const top = Object.entries(menuCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const maxQ = top[0]?.[1]||1;
  document.getElementById('ov-menu').innerHTML = top.length
    ? top.map(([n,q],i)=>rankRow(i,n,q,menuRev[n]||0,maxQ,'primary')).join('')
    : '<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';

  const cats = Object.entries(catRev).sort((a,b)=>b[1]-a[1]);
  const maxC = cats[0]?.[1]||1;
  document.getElementById('ov-cat').innerHTML = cats.length
    ? cats.map(([c,r])=>`
        <div class="ccard">
          <div class="crow"><span class="cname">${c}</span><span class="cval">‡∏ø${fmt(r)}</span></div>
          <div class="cbar-w"><div class="cbar" style="width:${Math.round(r/maxC*100)}%"></div></div>
          <div class="csub">${catCnt[c]} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>`).join('')
    : '<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';

  document.getElementById('ov-daily').innerHTML = Object.entries(dailyMap)
    .sort((a,b)=>b[0].localeCompare(a[0])).slice(0,14)
    .map(([d,v])=>`
      <div class="ditem">
        <span class="ddate">${new Date(d).toLocaleDateString('th-TH',{weekday:'short',day:'numeric',month:'short'})}</span>
        <span class="dval">‡∏ø${fmt(v)}</span>
      </div>`).join('');
}

// ‚îÄ‚îÄ TODAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderToday(todayOrders) {
  const rev = todayOrders.reduce((s,r)=>s+(r.actual_amount||0),0);
  const cnt = todayOrders.length;
  const menuT={};
  let totalItems=0;

  todayOrders.forEach(r=>{
    let items=r.items;
    if(!items) return;
    if(typeof items==='string'){try{items=JSON.parse(items);}catch{return;}}
    if(!Array.isArray(items)) return;
    items.forEach(item=>{
      const n=item.name||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const q=Number(item.qty||item.quantity||1);
      totalItems+=q;
      if(!menuT[n]) menuT[n]={qty:0,mods:{}};
      menuT[n].qty+=q;
      if(item.selectedModifier?.name){
        const m=item.selectedModifier.name;
        menuT[n].mods[m]=(menuT[n].mods[m]||0)+q;
      }
    });
  });

  document.getElementById('td-rev').innerText='‡∏ø'+fmt(rev);
  document.getElementById('td-cnt').innerText=fmt(cnt)+' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
  document.getElementById('td-avg').innerText='‡∏ø'+fmt(Math.round(cnt?rev/cnt:0));
  document.getElementById('td-items').innerText=fmt(totalItems)+' ‡∏ä‡∏¥‡πâ‡∏ô';

  const sorted = Object.entries(menuT).sort((a,b)=>b[1].qty-a[1].qty);
  document.getElementById('td-list').innerHTML = sorted.length
    ? sorted.map(([n,d])=>{
        const mods=Object.entries(d.mods).map(([m,q])=>`‚öôÔ∏è ${m} √ó${q}`).join('  ');
        return `<div class="titem">
          <div class="tmain"><span class="tname">${n}</span><span class="tqty">√ó${d.qty}</span></div>
          ${mods?`<div class="tmod">${mods}</div>`:''}
        </div>`;
      }).join('')
    : '<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
}

// ‚îÄ‚îÄ TREND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setPeriod(p, btn) {
  currentPeriod=p;
  document.querySelectorAll('.pbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const {dailyMap,byWeekday}=compute();
  renderTrend(dailyMap,byWeekday);
}

function renderTrend(dailyMap, byWeekday) {
  const sorted=Object.keys(dailyMap).sort();
  let labels, values, tableRows;

  if (currentPeriod==='1y') {
    const monthly={};
    sorted.forEach(d=>{ const k=d.slice(0,7); monthly[k]=(monthly[k]||0)+dailyMap[d]; });
    const mKeys=Object.keys(monthly).sort().slice(-12);
    labels=mKeys.map(k=>{ const[y,m]=k.split('-'); return new Date(+y,+m-1).toLocaleDateString('th-TH',{month:'short',year:'2-digit'}); });
    values=mKeys.map(k=>monthly[k]);
    tableRows=mKeys.slice().reverse().map(k=>{
      const[y,m]=k.split('-');
      return {label:new Date(+y,+m-1).toLocaleDateString('th-TH',{month:'long',year:'numeric'}),val:monthly[k]};
    });
  } else {
    const n = currentPeriod==='7d' ? 7 : 30;
    const sliced = sorted.slice(-n);
    labels = sliced.map(d=>d.split('-')[2]);
    values = sliced.map(d=>dailyMap[d]);
    tableRows = sliced.slice().reverse().map(d=>({
      label: new Date(d).toLocaleDateString('th-TH',{weekday:'short',day:'numeric',month:'short'}),
      val: dailyMap[d]
    }));
  }

  // chart
  if (trendChart) trendChart.destroy();
  const ctx=document.getElementById('trend-chart').getContext('2d');
  trendChart=new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[{data:values,borderColor:'#FF9F0A',borderWidth:3,tension:0.4,fill:true,backgroundColor:'rgba(255,159,10,0.07)',pointRadius:2,pointBackgroundColor:'#FF9F0A'}] },
    options:{ responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{ x:{grid:{display:false},ticks:{color:'#555',font:{size:11}}}, y:{display:false} } }
  });

  document.getElementById('trend-table').innerHTML = tableRows
    .map(r=>`<div class="ditem"><span class="ddate">${r.label}</span><span class="dval">‡∏ø${fmt(r.val)}</span></div>`).join('');

  // weekday bars
  const dayNames=['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå','‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'];
  const avgs = byWeekday.map(d=>d.cnt?Math.round(d.rev/d.cnt):0);
  const maxA = Math.max(...avgs,1);
  document.getElementById('weekday-list').innerHTML = avgs.map((a,i)=>`
    <div class="wditem">
      <div class="wdname">${dayNames[i]}</div>
      <div class="wdbar-w"><div class="wdbar" style="width:${Math.round(a/maxA*100)}%"></div></div>
      <div class="wdright">
        <div class="wdval">‡∏ø${fmt(a)}</div>
        <div class="wdsub">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ¬∑ ${byWeekday[i].cnt} ‡∏ß‡∏±‡∏ô</div>
      </div>
    </div>`).join('');

  // heatmap ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
  const now=new Date();
  const y=now.getFullYear(), mo=now.getMonth();
  const daysInMonth=new Date(y,mo+1,0).getDate();
  const firstDow=new Date(y,mo,1).getDay();
  const offset=firstDow===0?6:firstDow-1;
  let maxD=0;
  for(let d=1;d<=daysInMonth;d++){
    const k=`${y}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    maxD=Math.max(maxD,dailyMap[k]||0);
  }
  let hmHTML='';
  for(let i=0;i<offset;i++) hmHTML+='<div></div>';
  for(let d=1;d<=daysInMonth;d++){
    const k=`${y}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const v=dailyMap[k]||0;
    const isToday=k===todayStr;
    const p=maxD>0?v/maxD:0;
    const bg=p>0.75?'#FF9F0A':p>0.5?'rgba(255,159,10,.75)':p>0.25?'rgba(255,159,10,.5)':p>0?'rgba(255,159,10,.25)':'#1a1a1a';
    const textColor=p>0.5?'#000':'#666';
    hmHTML+=`<div class="hmcell" style="background:${bg};color:${textColor};font-weight:${isToday?700:400};outline:${isToday?'2px solid #FF9F0A':'none'};outline-offset:-1px" title="‡∏ø${fmt(v)}">${d}</div>`;
  }
  document.getElementById('heatmap').innerHTML=hmHTML;
}

// ‚îÄ‚îÄ PEAK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPeak(byHour, byWeekday) {
  const active=byHour.filter(h=>h.orders>0);
  const maxO=Math.max(...active.map(h=>h.orders),1);
  const dayNames=['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå','‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'];

  // hour bar chart
  if(peakChart) peakChart.destroy();
  const ctx1=document.getElementById('peak-chart').getContext('2d');
  peakChart=new Chart(ctx1,{
    type:'bar',
    data:{
      labels:byHour.map(h=>h.hour+':00'),
      datasets:[{
        data:byHour.map(h=>h.orders),
        backgroundColor:byHour.map(h=>h.orders===maxO?'#FF9F0A':'rgba(255,159,10,.2)'),
        borderRadius:5,borderSkipped:false
      }]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{grid:{display:false},ticks:{color:'#555',font:{size:10},maxRotation:0}},y:{display:false}}}
  });

  // weekday bar chart
  const wdAvgs=byWeekday.map(d=>d.cnt?Math.round(d.rev/d.cnt):0);
  const maxWD=Math.max(...wdAvgs,1);
  if(weekdayChart) weekdayChart.destroy();
  const ctx2=document.getElementById('weekday-chart').getContext('2d');
  weekdayChart=new Chart(ctx2,{
    type:'bar',
    data:{
      labels:dayNames,
      datasets:[{
        data:wdAvgs,
        backgroundColor:wdAvgs.map(v=>v===maxWD?'#32D74B':'rgba(50,215,75,.25)'),
        borderRadius:6,borderSkipped:false
      }]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{grid:{display:false},ticks:{color:'#555',font:{size:11}}},y:{display:false}}}
  });

  // hour list ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏™‡∏∏‡∏î
  document.getElementById('peak-list').innerHTML=[...active]
    .sort((a,b)=>b.orders-a.orders)
    .map((h,i)=>`
      <div class="hitem">
        <div class="htime">${String(h.hour).padStart(2,'0')}:00</div>
        <div class="hbar-w"><div class="hbar" style="width:${Math.round(h.orders/maxO*100)}%"></div></div>
        <div class="hright">
          <div class="horders">${h.orders} ‡∏ö‡∏¥‡∏•</div>
          <div class="hrev">‡∏ø${fmt(h.revenue)}</div>
        </div>
      </div>`).join('');
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rankRow(i,name,qty,rev,maxQ,color) {
  const cls=i===0?'g':i===1?'s':i===2?'b':'';
  return `<div class="ritem">
    <div class="rno ${cls}">${i+1}</div>
    <div class="rinfo">
      <div class="rname">${name}</div>
      <div class="rbar-w"><div class="rbar" style="width:${Math.round(qty/maxQ*100)}%"></div></div>
    </div>
    <div class="rright">
      <div class="rqty">${qty} ‡∏ä‡∏¥‡πâ‡∏ô</div>
      <div class="rrev">‡∏ø${fmt(rev)}</div>
    </div>
  </div>`;
}

init();
</script>
</body>
</html>
